<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Μαθητικό Στέκι</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;400&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <div class="topbar">
      <div class="logo"><img src="logo.png" alt="logo"></div>
      <nav>
        <a href="#">Αρχική Σελίδα</a>
        <a href="#">Προγράμματα</a>
        <a href="#">Πανελλαδικές Εξετάσεις</a>
        <a href="#">Φωτογραφίες</a>
        <a href="#">Σχετικά με εμάς</a>
      </nav>
      <div class="icons">
        <a href="#"><img src="\elements\Group 17.svg" alt="fb" class="facebook-icon"></a>
        <a href="#"><img src="\elements\mdi_instagram.svg" alt="insta" class="instagram-icon"></a>
        <a href="#"><img src="\elements\phone.svg" alt="phone"></a>
        <a href="#"><img src="\elements\mail.svg" alt="mail"></a>
      </div>
      <a href="../index2.html" class="login-btn" style="text-decoration: none;">Είσοδος</a>
    </div>
  </header>
  
  <main>
    <!-- Admin Dashboard Header -->
    <div class="admin-header">
      <h1> Admin Dashboard - Διαχείριση Μαθητών</h1>
      <p>Διαχειριστείτε βαθμούς, πρόοδο και ημερολόγιο μαθητών</p>
    </div>

    <!-- Quick Actions Panel -->
    <div class="quick-actions-panel" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
      <h2> Γρήγορες Ενέργειες</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
        
        <button class="quick-action-btn" onclick="openGradesModal()" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; border: none; padding: 15px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: transform 0.2s;">
           Καταχώρηση Βαθμού
        </button>
        
        <button class="quick-action-btn" onclick="openProgressModal()" style="background: linear-gradient(135deg, #28a745, #218838); color: white; border: none; padding: 15px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: transform 0.2s;">
           Καταγραφή Προόδου
        </button>
        
        <button class="quick-action-btn" onclick="openCalendarModal()" style="background: linear-gradient(135deg, #ffc107, #e0a800); color: white; border: none; padding: 15px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: transform 0.2s;">
           Ενημέρωση Ημερολογίου
        </button>
      </div>
    </div>

    <!-- Student Selection Panel -->
    <div class="student-selection-panel" style="background: #ffffff; padding: 25px; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 2px 15px rgba(0,0,0,0.1); border-left: 5px solid #E39C50;">
      <h2> Επιλογή Μαθητή</h2>
      
      <!-- Search and Filter Controls -->
      <div class="search-controls" style="display: grid; grid-template-columns: 1fr 200px 200px 150px; gap: 15px; margin: 20px 0; align-items: end;">
        
        <div class="form-group" style="margin-bottom: 0;">
          <label for="studentSearchInput">Αναζήτηση Μαθητή</label>
          <input type="text" id="studentSearchInput" placeholder="Όνομα, επώνυμο ή τηλέφωνο..." style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;" oninput="searchStudents()">
        </div>
        
        <div class="form-group" style="margin-bottom: 0;">
          <label for="studentClassFilter">Τάξη</label>
          <select id="studentClassFilter" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;" onchange="searchStudents()">
            <option value="">Όλες οι τάξεις</option>
            <option value="Α' Γυμνασίου">Α' Γυμνασίου</option>
            <option value="Β' Γυμνασίου">Β' Γυμνασίου</option>
            <option value="Γ' Γυμνασίου">Γ' Γυμνασίου</option>
            <option value="Α' Λυκείου">Α' Λυκείου</option>
            <option value="Β' Λυκείου">Β' Λυκείου</option>
            <option value="Γ' Λυκείου">Γ' Λυκείου</option>
          </select>
        </div>
        
        <div class="form-group" style="margin-bottom: 0;">
          <label for="studentSubjectFilter">Μάθημα</label>
          <select id="studentSubjectFilter" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;" onchange="searchStudents()">
            <option value="">Όλα τα μαθήματα</option>
          </select>
        </div>
        
        <button onclick="refreshStudentList()" class="btn btn-success" style="padding: 10px 20px; height: fit-content;">
           Ανανέωση
        </button>
      </div>

      <!-- Search Results Count -->
      <div id="searchResultsCount" style="margin: 10px 0; color: #666; font-size: 14px;"></div>

      <!-- Selected Student Display -->
      <div id="selectedStudentDisplay" style="display: none; background: #e8f5e8; padding: 15px; border-radius: 8px; margin-top: 20px; border: 2px solid #28a745;">
        <h3 style="margin: 0 0 10px 0; color: #155724;">✅ Επιλεγμένος Μαθητής</h3>
        <div id="selectedStudentInfo" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
          <!-- Student info will be populated here -->
        </div>
        <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
          <button onclick="viewStudentDetails()" class="btn btn-info" style="padding: 8px 15px;">
             Προβολή Στοιχείων
          </button>
          <button onclick="viewStudentGrades()" class="btn btn-warning" style="padding: 8px 15px;">
             Βαθμολογίες
          </button>
          <button onclick="viewStudentProgress()" class="btn btn-secondary" style="padding: 8px 15px;">
             Πρόοδος
          </button>
          <button onclick="clearSelectedStudent()" class="btn btn-light" style="padding: 8px 15px;">
             Καθαρισμός
          </button>
        </div>
      </div>
    </div>

    <!-- Students Grid/List -->
    <div class="students-grid-section" style="background: #ffffff; padding: 25px; border-radius: 10px; box-shadow: 0 2px 15px rgba(0,0,0,0.1);">
      <h2>👥 Μαθητές</h2>
      <div id="studentsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
        <!-- Students will be populated here -->
      </div>
    </div>

    <!-- Modals -->
    <!-- Grades Modal -->
    <div id="gradesModal" class="modal">
      <div class="modal-content" style="max-width: 600px;">
        <span class="close" onclick="closeGradesModal()">&times;</span>
        <h2> Καταχώρηση Βαθμού</h2>
        <div style="background: #e7f3ff; padding: 10px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #007bff;">
          <small> <strong>Συμβουλή:</strong> Μπορείτε να προσθέσετε πολλαπλούς βαθμούς συνεχόμενα. Το παράθυρο θα παραμείνει ανοιχτό μετά την αποθήκευση.</small>
        </div>
        
        <form id="gradesForm">
          <div class="form-group">
            <label>Μαθητής</label>
            <div id="gradeStudentInfo" style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
              Επιλέξτε μαθητή πρώτα
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="gradeSubject">Μάθημα *</label>
              <select id="gradeSubject" required>
                <option value="">Επιλέξτε μάθημα</option>
              </select>
            </div>
            <div class="form-group">
              <label for="gradeType">Τύπος Αξιολόγησης *</label>
              <select id="gradeType" required>
                <option value="">Επιλέξτε τύπο</option>
                <option value="quiz">Διαγώνισμα</option>
                <option value="homework">Εργασία</option>
                <option value="oral">Προφορικό</option>
                <option value="project">Project</option>
                <option value="exam">Εξετάσεις</option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="gradeValue">Βαθμός *</label>
              <input type="number" id="gradeValue" min="0" max="20" step="0.5" required placeholder="π.χ. 15.5">
            </div>
            <div class="form-group">
              <label for="gradeDate">Ημερομηνία *</label>
              <input type="date" id="gradeDate" required>
            </div>
          </div>
          
          <div class="form-group">
            <label for="gradeComments">Σχόλια</label>
            <textarea id="gradeComments" rows="3" placeholder="Προαιρετικά σχόλια για τον βαθμό..."></textarea>
          </div>
          
          <div style="text-align: center; margin-top: 30px;">
            <button type="button" class="btn btn-secondary" onclick="clearGradesForm()" style="margin-right: 10px; background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">🧹 Καθαρισμός</button>
            <button type="button" class="btn btn-primary" onclick="closeGradesModal()">Ακύρωση</button>
            <button type="submit" class="btn btn-success"> Αποθήκευση Βαθμού</button>
            <button type="button" class="btn btn-info" onclick="clearGradesForm()" style="margin-left: 10px; background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">➕ Νέα Εγγραφή</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Progress Modal -->
    <div id="progressModal" class="modal">
      <div class="modal-content" style="max-width: 600px;">
        <span class="close" onclick="closeProgressModal()">&times;</span>
        <h2> Καταγραφή Προόδου</h2>
        <div style="background: #e8f5e8; padding: 10px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #28a745;">
          <small> <strong>Συμβουλή:</strong> Μπορείτε να προσθέσετε πολλαπλές σημειώσεις προόδου συνεχόμενα. Το παράθυρο θα παραμείνει ανοιχτό μετά την αποθήκευση.</small>
        </div>
        
        <form id="progressForm">
          <div class="form-group">
            <label>Μαθητής</label>
            <div id="progressStudentInfo" style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
              Επιλέξτε μαθητή πρώτα
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="progressSubject">Μάθημα *</label>
              <select id="progressSubject" required>
                <option value="">Επιλέξτε μάθημα</option>
              </select>
            </div>
            <div class="form-group">
              <label for="progressDate">Ημερομηνία *</label>
              <input type="date" id="progressDate" required>
            </div>
          </div>
          
          <div class="form-group">
            <label for="progressNote">Σημείωση Προόδου *</label>
            <textarea id="progressNote" rows="4" required placeholder="π.χ. Βελτίωση στα μαθηματικά, χρειάζεται περισσότερη εξάσκηση στη γεωμετρία..."></textarea>
          </div>
          
          <div class="form-group">
            <label for="progressRating">Αξιολόγηση Προόδου</label>
            <select id="progressRating">
              <option value="">Επιλέξτε αξιολόγηση</option>
              <option value="excellent">Εξαιρετική</option>
              <option value="good">Καλή</option>
              <option value="average">Μέτρια</option>
              <option value="poor">Χρειάζεται βελτίωση</option>
            </select>
          </div>
          
          <div style="text-align: center; margin-top: 30px;">
            <button type="button" class="btn btn-secondary" onclick="clearProgressForm()" style="margin-right: 10px; background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">🧹 Καθαρισμός</button>
            <button type="button" class="btn btn-primary" onclick="closeProgressModal()">Ακύρωση</button>
            <button type="submit" class="btn btn-success"> Αποθήκευση Προόδου</button>
            <button type="button" class="btn btn-info" onclick="clearProgressForm()" style="margin-left: 10px; background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">➕ Νέα Εγγραφή</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Calendar Modal -->
    <div id="calendarModal" class="modal">
      <div class="modal-content" style="max-width: 600px;">
        <span class="close" onclick="closeCalendarModal()">&times;</span>
        <h2> Ενημέρωση Ημερολογίου</h2>
        <div style="background: #fff8e1; padding: 10px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
          <small> <strong>Συμβουλή:</strong> Μπορείτε να προσθέσετε πολλαπλά γεγονότα συνεχόμενα. Το παράθυρο θα παραμείνει ανοιχτό μετά την αποθήκευση.</small>
        </div>
        
        <form id="calendarForm">
          <div class="form-group">
            <label>Μαθητής</label>
            <div id="calendarStudentInfo" style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
              Επιλέξτε μαθητή πρώτα
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="calendarEventType">Τύπος Γεγονότος *</label>
              <select id="calendarEventType" required>
                <option value="">Επιλέξτε τύπο</option>
                <option value="makeup_class">Αναπλήρωση Μαθήματος</option>
                <option value="exam">Διαγώνισμα</option>
                <option value="meeting">Συνάντηση Γονέα</option>
                <option value="absence">Απουσία</option>
                <option value="extra_class">Επιπλέον Μάθημα</option>
                <option value="other">Άλλο</option>
              </select>
            </div>
            <div class="form-group">
              <label for="calendarSubject">Μάθημα</label>
              <select id="calendarSubject">
                <option value="">Επιλέξτε μάθημα (προαιρετικό)</option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="calendarDate">Ημερομηνία *</label>
              <input type="date" id="calendarDate" required>
            </div>
            <div class="form-group">
              <label for="calendarTime">Ώρα</label>
              <input type="time" id="calendarTime" placeholder="π.χ. 15:00">
            </div>
          </div>
          
          <div class="form-group">
            <label for="calendarTitle">Τίτλος *</label>
            <input type="text" id="calendarTitle" required placeholder="π.χ. Αναπλήρωση Μαθηματικών">
          </div>
          
          <div class="form-group">
            <label for="calendarDescription">Περιγραφή</label>
            <textarea id="calendarDescription" rows="3" placeholder="Λεπτομέρειες για το γεγονός..."></textarea>
          </div>
          
          <div style="text-align: center; margin-top: 30px;">
            <button type="button" class="btn btn-secondary" onclick="clearCalendarForm()" style="margin-right: 10px; background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">🧹 Καθαρισμός</button>
            <button type="button" class="btn btn-primary" onclick="closeCalendarModal()">Ακύρωση</button>
            <button type="submit" class="btn btn-success">💾 Αποθήκευση Γεγονότος</button>
            <button type="button" class="btn btn-info" onclick="clearCalendarForm()" style="margin-left: 10px; background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">➕ Νέα Εγγραφή</button>
          </div>
        </form>
      </div>
    </div>

    <style>
      .quick-action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      }
      
      .student-card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-left: 4px solid #E39C50;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .student-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      }
      
      .student-card.selected {
        border-left-color: #28a745;
        background: #f8fff8;
      }
      
      .student-card h4 {
        margin: 0 0 8px 0;
        color: #333;
        font-size: 16px;
      }
      
      .student-card p {
        margin: 4px 0;
        color: #666;
        font-size: 14px;
      }
      
      .student-card .actions {
        margin-top: 10px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      
      .student-card .btn-mini {
        padding: 4px 8px;
        font-size: 12px;
        border-radius: 4px;
      }
    </style>

    <!-- Announcements Management Section -->
    <section class="announcements-management" style="padding: 40px 20px; background: #f8f9fa; margin-top: 30px;">
      <div style="max-width: 1200px; margin: 0 auto;">
        <h2 style="text-align: center; color: #2C5F4F; margin-bottom: 30px;">📢 Διαχείριση Ανακοινώσεων</h2>
        
        <!-- Add Announcement Form -->
        <div style="background: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <h3>Προσθήκη Νέας Ανακοίνωσης</h3>
          <form id="add-announcement-form" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: end;">
            <div>
              <label for="announcement-title" style="display: block; margin-bottom: 5px; font-weight: bold;">Τίτλος:</label>
              <input type="text" id="announcement-title" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
            </div>
            <div>
              <label for="announcement-content" style="display: block; margin-bottom: 5px; font-weight: bold;">Περιεχόμενο:</label>
              <input type="text" id="announcement-content" required style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px;">
            </div>
            <button type="submit" style="grid-column: span 2; padding: 12px 20px; background: #E39C50; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;">
              Προσθήκη Ανακοίνωσης
            </button>
          </form>
        </div>

        <!-- Announcements List -->
        <div style="background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <h3 style="padding: 20px; margin: 0; background: #2C5F4F; color: white;">Λίστα Ανακοινώσεων</h3>
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: #f8f9fa;">
                  <th style="padding: 15px; text-align: left; border-bottom: 1px solid #ddd;">ID</th>
                  <th style="padding: 15px; text-align: left; border-bottom: 1px solid #ddd;">Τίτλος</th>
                  <th style="padding: 15px; text-align: left; border-bottom: 1px solid #ddd;">Περιεχόμενο</th>
                  <th style="padding: 15px; text-align: left; border-bottom: 1px solid #ddd;">Ημερομηνία</th>
                  <th style="padding: 15px; text-align: left; border-bottom: 1px solid #ddd;">Ενέργειες</th>
                </tr>
              </thead>
              <tbody id="announcements-list">
                <!-- Announcements will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>
  <footer>
    <div class="footer-content">
      <div class="footer-logo">Μαθητικό Στέκι</div>
      <div class="footer-links"  data-id="footer-links">
        <span>Καθηγητές:</span>
        <span>...</span>
      </div>
      <div class="footer-map" >
        <img src="map.png" alt="Χάρτης">
      </div>
    </div>
    <div class="footer-bottom">
      &copy; 2025 Μαθητικό Στέκι
    </div>
  </footer>
    <script src="main.js"></script>
    <script src="client-text.js"></script>
    
    <script>
      // Global variables
      let selectedStudent = null;
      let allStudents = [];
      let allSubjects = [];
      let selectedStudentSubjects = [];
      
      // Initialize page
      document.addEventListener('DOMContentLoaded', function() {
        initializePage();
      });
      
      async function initializePage() {
        try {
          await loadSubjects();
          await loadStudents();
          populateSubjectFilters();
          setDefaultDates();
        } catch (error) {
          console.error('Error initializing page:', error);
          showNotification('Σφάλμα κατά τη φόρτωση της σελίδας', 'error');
        }
      }
      
      // Load subjects from database
      async function loadSubjects() {
        try {
          const response = await fetch('/api/subjects');
          if (response.ok) {
            allSubjects = await response.json();
          } else {
            console.error('Failed to load subjects');
          }
        } catch (error) {
          console.error('Error loading subjects:', error);
        }
      }
      
      // Load students from database
      async function loadStudents() {
        try {
          console.log('Attempting to load students from server...');
          const response = await fetch('/api/students');
          if (response.ok) {
            const rawStudents = await response.json();
            console.log('Raw students data:', rawStudents);
            
            // Map database fields to frontend expected fields
            allStudents = rawStudents.map(student => ({
              id: student.id,
              firstName: student.first_name,
              lastName: student.last_name,
              studentClass: student.class,
              phone: student.phone,
              email: student.email,
              parentName: student.parentName,
              parentPhone: student.parentPhone,
              address: student.address,
              birthDate: student.birthDate,
              enrollmentDate: student.enrollmentDate,
              status: student.status,
              notes: student.notes
            }));
            
            console.log('Students loaded from server:', allStudents.length);
            console.log('Mapped first student:', allStudents[0]);
            displayStudents(allStudents);
            updateSearchResults(allStudents.length);
          } else {
            console.error('Failed to load students, status:', response.status);
            throw new Error('Server responded with error');
          }
        } catch (error) {
          console.error('Error loading students:', error);
          // Fallback to demo data
          loadDemoData();
        }
      }
      
      // Demo data fallback
      function loadDemoData() {
        console.log('Loading demo data...');
        allStudents = [
          {
            id: 1,
            firstName: 'Γιάννης',
            lastName: 'Παπαδόπουλος',
            studentClass: 'Β\' Λυκείου',
            phone: '6901234567',
            email: 'giannis@example.com',
            parentName: 'Κώστας Παπαδόπουλος',
            parentPhone: '6907654321',
            enrollmentDate: '2023-09-01',
            status: 'active'
          },
          {
            id: 2,
            firstName: 'Μαρία',
            lastName: 'Γεωργίου',
            studentClass: 'Γ\' Λυκείου',
            phone: '6902345678',
            email: 'maria@example.com',
            parentName: 'Ελένη Γεωργίου',
            parentPhone: '6908765432',
            enrollmentDate: '2022-09-01',
            status: 'active'
          },
          {
            id: 3,
            firstName: 'Κώστας',
            lastName: 'Δημητρίου',
            studentClass: 'Α\' Λυκείου',
            phone: '6903456789',
            email: 'kostas@example.com',
            parentName: 'Νίκος Δημητρίου',
            parentPhone: '6909876543',
            enrollmentDate: '2024-09-01',
            status: 'active'
          }
        ];
        
        allSubjects = [
          { id: 1, name: 'Μαθηματικά', code: 'Μγ4', class: 'Γ\' Λυκείου' },
          { id: 2, name: 'Χημεία', code: 'Χγ2', class: 'Γ\' Λυκείου' },
          { id: 3, name: 'Φυσική', code: 'Φβ1', class: 'Β\' Λυκείου' },
          { id: 4, name: 'Αρχαία', code: 'Αρα3', class: 'Α\' Λυκείου' },
          { id: 5, name: 'Νέα Ελληνικά', code: 'Νεγ1', class: 'Γ\' Γυμνασίου' }
        ];
        
        displayStudents(allStudents);
        populateSubjectFilters();
        updateSearchResults(allStudents.length);
        console.log('Demo data loaded, students count:', allStudents.length);
      }
      
      // Populate subject filter dropdowns
      function populateSubjectFilters() {
        const filterSelects = ['studentSubjectFilter', 'gradeSubject', 'progressSubject', 'calendarSubject'];
        
        filterSelects.forEach(selectId => {
          const select = document.getElementById(selectId);
          if (select) {
            // Clear existing options except first one
            const firstOption = select.firstElementChild;
            select.innerHTML = '';
            select.appendChild(firstOption);
            
            // Add subject options
            allSubjects.forEach(subject => {
              const option = document.createElement('option');
              option.value = subject.id;
              option.textContent = `${subject.name} (${subject.class})`;
              select.appendChild(option);
            });
          }
        });
      }
      
      // Set default dates
      function setDefaultDates() {
        const today = new Date().toISOString().split('T')[0];
        const dateInputs = ['gradeDate', 'progressDate', 'calendarDate'];
        
        dateInputs.forEach(inputId => {
          const input = document.getElementById(inputId);
          if (input) {
            input.value = today;
          }
        });
      }
      
      // Search students functionality
      function searchStudents() {
        console.log('searchStudents called, allStudents:', allStudents);
        if (!allStudents || allStudents.length === 0) {
          console.log('No students data available');
          return;
        }
        
        const searchTerm = document.getElementById('studentSearchInput').value.toLowerCase();
        const classFilter = document.getElementById('studentClassFilter').value;
        const subjectFilter = document.getElementById('studentSubjectFilter').value;
        
        let filteredStudents = allStudents.filter(student => {
          const matchesSearch = 
            (student.firstName && student.firstName.toLowerCase().includes(searchTerm)) ||
            (student.lastName && student.lastName.toLowerCase().includes(searchTerm)) ||
            (student.phone && student.phone.includes(searchTerm)) ||
            (student.email && student.email.toLowerCase().includes(searchTerm));
          
          const matchesClass = !classFilter || student.studentClass === classFilter;
          
          // For subject filter, we would need to check enrollments
          // For now, we'll just match by class
          const matchesSubject = !subjectFilter || true;
          
          return matchesSearch && matchesClass && matchesSubject;
        });
        
        displayStudents(filteredStudents);
        updateSearchResults(filteredStudents.length);
      }
      
      // Display students in grid
      function displayStudents(students) {
        console.log('displayStudents called with:', students.length, 'students');
        const grid = document.getElementById('studentsGrid');
        grid.innerHTML = '';
        
        if (students.length === 0) {
          grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">Δεν βρέθηκαν μαθητές</div>';
          return;
        }
        
        students.forEach(student => {
          console.log('Processing student:', student);
          const studentCard = document.createElement('div');
          studentCard.className = 'student-card';
          studentCard.dataset.studentId = student.id;
          
          studentCard.innerHTML = `
            <h4>${student.firstName || 'Άγνωστο'} ${student.lastName || 'Όνομα'}</h4>
            <p><strong>Τάξη:</strong> ${student.studentClass || 'Δεν έχει οριστεί'}</p>
            <p><strong>Τηλέφωνο:</strong> ${student.phone || 'Δεν έχει καταχωρηθεί'}</p>
            <p><strong>Γονέας:</strong> ${student.parentName || 'Δεν έχει καταχωρηθεί'}</p>
            <p><strong>Κατάσταση:</strong> <span class="status-${student.status}">${getStatusText(student.status)}</span></p>
            <div class="actions">
              <button class="btn btn-mini btn-success" onclick="selectStudent(${student.id})">
                 Επιλογή
              </button>
              <button class="btn btn-mini btn-info" onclick="viewStudentDetails(${student.id})">
                 Στοιχεία
              </button>
              <button class="btn btn-mini btn-warning" onclick="viewStudentGrades(${student.id})">
                 Βαθμοί
              </button>
            </div>
          `;
          
          grid.appendChild(studentCard);
        });
      }
      
      // Get status text
      function getStatusText(status) {
        const statusMap = {
          'active': 'Ενεργός',
          'inactive': 'Ανενεργός',
          'graduated': 'Απόφοιτος'
        };
        return statusMap[status] || status;
      }
      
      // Update search results count
      function updateSearchResults(count) {
        const countElement = document.getElementById('searchResultsCount');
        countElement.textContent = `Βρέθηκαν ${count} μαθητές`;
      }
      
      // Select a student
      async function selectStudent(studentId) {
        const student = allStudents.find(s => s.id === studentId);
        if (!student) return;
        
        selectedStudent = student;
        
        // Update UI
        document.querySelectorAll('.student-card').forEach(card => {
          card.classList.remove('selected');
        });
        
        const selectedCard = document.querySelector(`[data-student-id="${studentId}"]`);
        if (selectedCard) {
          selectedCard.classList.add('selected');
        }
        
        // Show selected student info
        const display = document.getElementById('selectedStudentDisplay');
        const info = document.getElementById('selectedStudentInfo');
        
        info.innerHTML = `
          <div><strong>Όνομα:</strong> ${student.firstName} ${student.lastName}</div>
          <div><strong>Τάξη:</strong> ${student.studentClass}</div>
          <div><strong>Τηλέφωνο:</strong> ${student.phone}</div>
          <div><strong>Email:</strong> ${student.email || 'Δεν υπάρχει'}</div>
          <div><strong>Γονέας:</strong> ${student.parentName || 'Δεν έχει καταχωρηθεί'}</div>
          <div><strong>Τηλ. Γονέα:</strong> ${student.parentPhone || 'Δεν έχει καταχωρηθεί'}</div>
        `;
        
        display.style.display = 'block';
        
        // Load student's enrolled subjects
        await loadStudentSubjects(studentId);
        
        // Update modal forms
        updateModalForms(student);
        
        showNotification(`Επιλέχθηκε ο/η μαθητής/τρια: ${student.firstName} ${student.lastName}`, 'success');
      }
      
      // Load subjects that the student is enrolled in
      async function loadStudentSubjects(studentId) {
        try {
          const response = await fetch(`/api/enrollments?studentId=${studentId}`);
          if (response.ok) {
            const enrollments = await response.json();
            console.log('Student enrollments:', enrollments);
            
            // Extract subject information from enrollments
            selectedStudentSubjects = enrollments.map(enrollment => ({
              id: enrollment.class_id, // This is actually the subject_id from Subjects table
              name: enrollment.subject_name,
              code: enrollment.subject_code,
              class: enrollment.subject_class,
              teacher: enrollment.teacher_name
            }));
            
            console.log('Student subjects:', selectedStudentSubjects);
            
            // Update subject dropdowns in modals
            updateSubjectDropdowns();
            
          } else {
            console.error('Failed to load student subjects');
            selectedStudentSubjects = [];
          }
        } catch (error) {
          console.error('Error loading student subjects:', error);
          selectedStudentSubjects = [];
        }
      }
      
      // Update subject dropdowns to show only enrolled subjects
      function updateSubjectDropdowns() {
        const subjectSelects = ['gradeSubject', 'progressSubject', 'calendarSubject'];
        
        subjectSelects.forEach(selectId => {
          const select = document.getElementById(selectId);
          if (select) {
            // Clear existing options except first one
            const firstOption = select.querySelector('option[value=""]');
            select.innerHTML = '';
            if (firstOption) {
              select.appendChild(firstOption.cloneNode(true));
            } else {
              const defaultOption = document.createElement('option');
              defaultOption.value = '';
              defaultOption.textContent = 'Επιλέξτε μάθημα';
              select.appendChild(defaultOption);
            }
            
            // Add enrolled subjects only
            selectedStudentSubjects.forEach(subject => {
              const option = document.createElement('option');
              option.value = subject.id;
              option.textContent = `${subject.name} (${subject.code})`;
              select.appendChild(option);
            });
          }
        });
      }

      // Update modal forms with selected student
      function updateModalForms(student) {
        const studentInfo = `${student.firstName} ${student.lastName} - ${student.studentClass}`;
        
        const infoElements = [
          'gradeStudentInfo',
          'progressStudentInfo', 
          'calendarStudentInfo'
        ];
        
        infoElements.forEach(elementId => {
          const element = document.getElementById(elementId);
          if (element) {
            element.innerHTML = `
              <strong>Μαθητής:</strong> ${studentInfo}<br>
              <strong>Τηλέφωνο:</strong> ${student.phone}
            `;
          }
        });
      }
      
      // Clear selected student
      function clearSelectedStudent() {
        selectedStudent = null;
        
        document.querySelectorAll('.student-card').forEach(card => {
          card.classList.remove('selected');
        });
        
        document.getElementById('selectedStudentDisplay').style.display = 'none';
        
        showNotification('Η επιλογή μαθητή καθαρίστηκε', 'info');
      }
      
      // Refresh student list
      function refreshStudentList() {
        document.getElementById('studentSearchInput').value = '';
        document.getElementById('studentClassFilter').value = '';
        document.getElementById('studentSubjectFilter').value = '';
        loadStudents();
      }
      
      // Modal functions
      function openGradesModal() {
        if (!selectedStudent) {
          showNotification('Παρακαλώ επιλέξτε πρώτα έναν μαθητή', 'warning');
          return;
        }
        document.getElementById('gradesModal').style.display = 'block';
      }
      
      function closeGradesModal() {
        document.getElementById('gradesModal').style.display = 'none';
        document.getElementById('gradesForm').reset();
        setDefaultDates();
      }
      
      function openProgressModal() {
        if (!selectedStudent) {
          showNotification('Παρακαλώ επιλέξτε πρώτα έναν μαθητή', 'warning');
          return;
        }
        document.getElementById('progressModal').style.display = 'block';
      }
      
      function closeProgressModal() {
        document.getElementById('progressModal').style.display = 'none';
        document.getElementById('progressForm').reset();
        setDefaultDates();
      }
      
      function openCalendarModal() {
        if (!selectedStudent) {
          showNotification('Παρακαλώ επιλέξτε πρώτα έναν μαθητή', 'warning');
          return;
        }
        document.getElementById('calendarModal').style.display = 'block';
      }
      
      function closeCalendarModal() {
        document.getElementById('calendarModal').style.display = 'none';
        document.getElementById('calendarForm').reset();
        setDefaultDates();
      }
      
      // Functions για καθαρισμό forms χωρίς κλείσιμο των modals
      function clearGradesForm() {
        document.getElementById('gradeSubject').value = '';
        document.getElementById('gradeType').value = '';
        document.getElementById('gradeValue').value = '';
        document.getElementById('gradeDate').value = '';
        document.getElementById('gradeComments').value = '';
        setDefaultDates();
        showNotification('Τα πεδία καθαρίστηκαν', 'info');
      }
      
      function clearProgressForm() {
        document.getElementById('progressSubject').value = '';
        document.getElementById('progressNote').value = '';
        document.getElementById('progressDate').value = '';
        document.getElementById('progressRating').value = '';
        setDefaultDates();
        showNotification('Τα πεδία καθαρίστηκαν', 'info');
      }
      
      function clearCalendarForm() {
        document.getElementById('calendarTitle').value = '';
        document.getElementById('calendarDescription').value = '';
        document.getElementById('calendarDate').value = '';
        document.getElementById('calendarTime').value = '';
        document.getElementById('calendarEventType').value = '';
        document.getElementById('calendarSubject').value = '';
        document.getElementById('addToGoogleCalendar').checked = false;
        setDefaultDates();
        showNotification('Τα πεδία καθαρίστηκαν', 'info');
      }
      
      // Form submission handlers
      document.getElementById('gradesForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!selectedStudent) {
          showNotification('Δεν έχει επιλεγεί μαθητής', 'error');
          return;
        }
        
        const formData = new FormData(this);
        const gradeData = {
          studentId: selectedStudent.id,
          subjectId: document.getElementById('gradeSubject').value,
          examType: document.getElementById('gradeType').value,
          grade: parseFloat(document.getElementById('gradeValue').value),
          examDate: document.getElementById('gradeDate').value,
          notes: document.getElementById('gradeComments').value
        };
        
        console.log(' Sending grade data:', gradeData);
        console.log(' Selected student subjects:', selectedStudentSubjects);
        
        try {
          const response = await fetch('/api/grades', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(gradeData)
          });
          
          if (response.ok) {
            showNotification(' Ο βαθμός αποθηκεύτηκε επιτυχώς! Μπορείτε να προσθέσετε άλλον βαθμό ή να κλείσετε το παράθυρο.', 'success');
            const result = await response.json();
            console.log('Grade saved response:', result);
            
            // Optionally, you can keep the modal open and just clear the form
            // closeGradesModal();
            // clearGradesForm();
          } else {
            const errorText = await response.text();
            console.error('Failed to save grade, status:', response.status, 'Response:', errorText);
            showNotification('Σφάλμα κατά την αποθήκευση του βαθμού: ' + errorText, 'error');
          }
        } catch (error) {
          console.error('Error saving grade:', error);
          showNotification('Σφάλμα κατά την αποθήκευση του βαθμού', 'error');
        }
      });
      
      document.getElementById('progressForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!selectedStudent) {
          showNotification('Δεν έχει επιλεγεί μαθητής', 'error');
          return;
        }
        
        const formData = new FormData(this);
        const progressData = {
          studentId: selectedStudent.id,
          subjectId: document.getElementById('progressSubject').value,
          date: document.getElementById('progressDate').value,
          note: document.getElementById('progressNote').value,
          rating: document.getElementById('progressRating').value
        };
        
        console.log(' Sending progress data:', progressData);
        
        try {
          const response = await fetch('/api/progress', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(progressData)
          });
          
          if (response.ok) {
            showNotification(' Η πρόοδος αποθηκεύτηκε επιτυχώς! Μπορείτε να προσθέσετε άλλη καταχώρηση ή να κλείσετε το παράθυρο.', 'success');
            const result = await response.json();
            console.log('Progress saved response:', result);
          } else {
            const errorText = await response.text();
            console.error('Failed to save progress, status:', response.status, 'Response:', errorText);
            showNotification('Σφάλμα κατά την αποθήκευση της πρόοδου: ' + errorText, 'error');
          }
        } catch (error) {
          console.error('Error saving progress:', error);
          showNotification('Σφάλμα κατά την αποθήκευση της πρόοδου', 'error');
        }
      });
      
      document.getElementById('calendarForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!selectedStudent) {
          showNotification('Δεν έχει επιλεγεί μαθητής', 'error');
          return;
        }
        
        const formData = new FormData(this);
        const eventData = {
          studentId: selectedStudent.id,
          title: document.getElementById('calendarTitle').value,
          description: document.getElementById('calendarDescription').value,
          entryDate: document.getElementById('calendarDate').value,
          eventType: document.getElementById('calendarEventType').value,
          subjectId: document.getElementById('calendarSubject').value,
          time: document.getElementById('calendarTime').value
        };
        
        console.log(' Sending event data:', eventData);
        
        try {
          const response = await fetch('/api/events', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(eventData)
          });
          
          if (response.ok) {
            const result = await response.json();
            console.log('Event saved response:', result);
            
            showNotification(' Το γεγονός αποθηκεύτηκε επιτυχώς!', 'success');
            closeCalendarModal();
          } else {
            const errorText = await response.text();
            console.error('Failed to save event, status:', response.status, 'Response:', errorText);
            showNotification('Σφάλμα κατά την αποθήκευση του γεγονότος: ' + errorText, 'error');
          }
        } catch (error) {
          console.error('Error saving event:', error);
          showNotification('Σφάλμα κατά την αποθήκευση του γεγονότος', 'error');
        }
      });

      // Function to show notifications
      function showNotification(message, type = 'info') {
        // Create notification container if it doesn't exist
        let container = document.getElementById('notificationContainer');
        if (!container) {
          container = document.createElement('div');
          container.id = 'notificationContainer';
          container.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
            pointer-events: none;
          `;
          document.body.appendChild(container);
        }

        // Create notification element
        const notification = document.createElement('div');
        notification.style.cssText = `
          background: ${type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1'};
          color: ${type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#0c5460'};
          border: 1px solid ${type === 'success' ? '#c3e6cb' : type === 'error' ? '#f5c6cb' : '#bee5eb'};
          border-radius: 8px;
          padding: 15px;
          margin-bottom: 10px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
          pointer-events: auto;
          transform: translateX(100%);
          opacity: 0;
          transition: all 0.3s ease;
          font-size: 14px;
          line-height: 1.4;
          word-wrap: break-word;
        `;
        
        notification.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div style="flex: 1; margin-right: 10px;">${message}</div>
            <button onclick="this.parentElement.parentElement.remove()" style="
              background: none;
              border: none;
              font-size: 18px;
              cursor: pointer;
              color: inherit;
              opacity: 0.7;
              padding: 0;
              line-height: 1;
            ">&times;</button>
          </div>
        `;

        container.appendChild(notification);

        // Animate in
        setTimeout(() => {
          notification.style.transform = 'translateX(0)';
          notification.style.opacity = '1';
        }, 10);

        // Auto remove after 5 seconds
        setTimeout(() => {
          if (notification.parentElement) {
            notification.style.transform = 'translateX(100%)';
            notification.style.opacity = '0';
            setTimeout(() => {
              if (notification.parentElement) {
                notification.remove();
              }
            }, 300);
          }
        }, 5000);
      }
    </script>
    <script src="announcements.js"></script>
</body>
</html>
