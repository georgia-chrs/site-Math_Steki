<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Μαθητικό Στέκι - Υπολογιστής Μορίων</title>
    <!-- XLSX Library για Excel export -->
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="../style.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;400&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #8e8e93, #6d6d70, #48484a);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .wizard { 
            max-width: 1200px; 
            width: 95%;
            margin: 0 auto; 
            padding: 0;
        }
        
        .step-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }
        
        /* Ειδικό CSS για το 6ο βήμα - Αποτελέσματα */
        #step6 .step-container {
            max-width: 1400px;
            width: 95%;
            margin: 0 auto 20px auto;
            padding: 40px;
        }
        
        /* Κάνω τα αποτελέσματα πιο φαρδιά */
        #step6 .selected-schools-list {
            width: 100%;
        }
        
        #step6 .final-results {
            width: 100%;
            max-width: none;
        }
        
        #step6 .selected-school-item {
            padding: 20px;
            margin-bottom: 15px;
        }
        
        #step6 .school-stats {
            min-width: 300px;
            gap: 20px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        
        #step6 .stat-item {
            min-width: 90px;
            text-align: center;
            padding: 8px 12px;
            background: rgba(0, 122, 255, 0.05);
            border-radius: 6px;
            margin: 2px;
        }
        
        /* CSS για τα μόρια του μαθητή */
        .user-moria-container {
            margin: 20px 0;
            display: flex;
            justify-content: center;
        }
        
        .user-moria-box {
            background: linear-gradient(135deg, #007aff, #0056cc);
            color: white;
            border-radius: 15px;
            padding: 20px 30px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 122, 255, 0.3);
            min-width: 200px;
            position: relative;
            overflow: hidden;
        }
        
        .user-moria-box::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            50% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        .user-moria-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 10px;
            position: relative;
            z-index: 2;
        }
        
        .user-icon {
            font-size: 20px;
        }
        
        .user-moria-header h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            opacity: 0.9;
        }
        
        .user-moria-value {
            font-size: 32px;
            font-weight: bold;
            margin: 5px 0;
            position: relative;
            z-index: 2;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .user-moria-label {
            font-size: 14px;
            opacity: 0.8;
            position: relative;
            z-index: 2;
        }
        
        .moria-comparison {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 2;
        }
        
        .comparison-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 5px 0;
            font-size: 13px;
        }
        
        .comparison-label {
            opacity: 0.8;
        }
        
        .comparison-value {
            font-weight: bold;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        #step6 .school-info {
            flex: 1;
            min-width: 250px;
            padding-right: 20px;
        }
        
        #step6 .school-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            line-height: 1.3;
        }
        
        #step6 .school-university {
            font-size: 14px;
            color: #666;
            margin-bottom: 4px;
        }
        
        #step6 .school-location {
            font-size: 12px;
            color: #888;
        }
        
        .step-header {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .step-number {
            display: inline-flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .step-circles {
            display: flex;
            gap: 8px;
        }
        
        .step-circle {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            position: relative;
        }
        
        .step-circle.completed {
            background: #34c759;
            color: white;
        }
        
        .step-circle.active {
            background: #007aff;
            color: white;
        }
        
        .step-circle.pending {
            background: #d1d1d6;
            color: #8e8e93;
        }
        
        .step-circle.error {
            background: #ff3b30;
            color: white;
        }
        
        .step-circle.error::after {
            content: '!';
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff3b30;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid white;
        }
        
        .step-title {
            font-size: 18px;
            font-weight: 600;
            color: #1d1d1f;
            margin: 0;
        }
        
        .step-subtitle {
            font-size: 14px;
            color: #86868b;
            margin: 5px 0 0 0;
        }
        
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }
        
        .radio-option {
            background: white;
            border: 2px solid #e5e5ea;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .radio-option:hover {
            border-color: #007aff;
            background: #f0f8ff;
        }
        
        .radio-option.selected {
            border-color: #007aff;
            background: #007aff;
            color: white;
        }
        
        .radio-option input[type="radio"] {
            width: 20px;
            height: 20px;
            accent-color: #007aff;
        }
        
        .radio-option.selected input[type="radio"] {
            accent-color: white;
        }
        
        .radio-option label {
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin: 0;
            flex: 1;
        }
        
        .step-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 15px;
        }
        
        .nav-button {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 120px;
        }
        
        .nav-button.primary {
            background: #007aff;
            color: white;
        }
        
        .nav-button.primary:hover {
            background: #0051d5;
        }
        
        .nav-button.secondary {
            background: #f2f2f7;
            color: #007aff;
        }
        
        .nav-button.secondary:hover {
            background: #e5e5ea;
        }
        
        .nav-button:disabled {
            background: #f2f2f7;
            color: #8e8e93;
            cursor: not-allowed;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1d1d1f;
            font-size: 16px;
        }
        
        .input-group input,
        .input-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e5ea;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            box-sizing: border-box;
        }
        
        .input-group input:focus,
        .input-group select:focus {
            border-color: #007aff;
            outline: none;
            background: #f0f8ff;
        }
        
        .grade-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .subjects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .subject-input {
            background: white;
            border: 2px solid #e5e5ea;
            border-radius: 12px;
            padding: 16px;
            transition: all 0.2s ease;
        }
        
        .subject-input:hover {
            border-color: #007aff;
            background: #f0f8ff;
        }
        
        .subject-input label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1d1d1f;
            font-size: 16px;
        }
        
        .subject-input input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e5ea;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            box-sizing: border-box;
            margin-bottom: 6px;
        }
        
        .subject-input input:focus {
            border-color: #007aff;
            outline: none;
            background: #f0f8ff;
        }
        
        .grade-help {
            font-size: 12px;
            color: #86868b;
            display: block;
        }
        
        .required-note {
            font-size: 14px;
            color: #86868b;
            margin-top: 20px;
            text-align: center;
            font-style: italic;
        }
        
        .special-subjects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .special-subject-input {
            background: white;
            border: 2px solid #e5e5ea;
            border-radius: 12px;
            padding: 16px;
            transition: all 0.2s ease;
        }
        
        .special-subject-input:hover {
            border-color: #34c759;
            background: #f0fff4;
        }
        
        .special-subject-input label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1d1d1f;
            font-size: 16px;
        }
        
        .special-subject-input input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e5ea;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            box-sizing: border-box;
        }
        
        .special-subject-input input:focus {
            border-color: #34c759;
            outline: none;
            background: #f0fff4;
        }
        
        .optional-note {
            font-size: 14px;
            color: #34c759;
            margin-top: 20px;
            text-align: center;
            font-style: italic;
        }

        .special-subjects {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        /* Styles για τα αποτελέσματα με checkboxes */
        .schools-container {
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            margin-top: 20px;
        }
        
        .school-item {
            background: white;
            border: 2px solid #e5e5ea;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            min-height: 120px;
        }
        
        .school-item:hover {
            border-color: #34c759;
            background: #f0fff4;
        }
        
        .school-item.selected {
            border-color: #34c759;
            background: #34c759;
            color: white;
        }
        
        .school-info {
            flex: 1;
            min-width: 300px;
            padding-right: 15px;
        }
        
        .school-info h4 {
            margin: 0 0 8px 0;
            font-size: 17px;
            font-weight: 600;
            line-height: 1.3;
        }
        
        .school-info p {
            margin: 0 0 6px 0;
            font-size: 15px;
            opacity: 0.8;
            line-height: 1.2;
        }
        
        .school-field {
            background: rgba(0, 122, 255, 0.1);
            color: #007aff;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 13px;
            font-weight: 500;
            display: inline-block;
            margin-top: 4px;
        }
        
        .school-item.selected .school-field {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .school-moria {
            text-align: center;
            min-width: 80px;
        }
        
        .moria-value {
            display: block;
            font-size: 18px;
            font-weight: bold;
            color: #007aff;
        }
        
        .school-item.selected .moria-value {
            color: white;
        }
        
        .moria-label {
            font-size: 12px;
            color: #86868b;
        }
        
        .school-item.selected .moria-label {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .selection-indicator {
            width: 24px;
            height: 24px;
            border: 2px solid #e5e5ea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .school-item.selected .selection-indicator {
            background: white;
            border-color: white;
        }
        
        .checkmark {
            color: #34c759;
            font-weight: bold;
            font-size: 16px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .school-item.selected .checkmark {
            opacity: 1;
        }
        
        .schools-header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
        }
        
        .schools-header h3 {
            margin: 0 0 8px 0;
            color: #1d1d1f;
            font-size: 20px;
        }
        
        .schools-header p {
            margin: 0;
            color: #86868b;
            font-size: 14px;
        }
        
        .final-results {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .final-results h3 {
            text-align: center;
            margin: 0 0 20px 0;
            color: #1d1d1f;
            font-size: 20px;
        }
        
        .results-table {
            overflow-x: auto;
        }
        
        .results-table table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .results-table th {
            background: #007aff;
            color: white;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }
        
        .results-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #e5e5ea;
            font-size: 14px;
        }
        
        .results-table tr:last-child td {
            border-bottom: none;
        }
        
        .results-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .export-button {
            background: #34c759;
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 20px;
        }
        
        .export-button:hover {
            background: #30b955;
            transform: translateY(-1px);
        }
        
        .no-schools-message {
            text-align: center;
            padding: 40px 20px;
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 12px;
            margin: 20px 0;
        }
        
        .no-schools-message h3 {
            color: #856404;
            margin: 0 0 15px 0;
            font-size: 18px;
        }
        
        .no-schools-message p {
            color: #856404;
            margin: 0;
            font-size: 14px;
        }

        /* Styles για το βήμα 6 - Οι επιλεγμένες σχολές */
        .selected-schools-list {
            margin-top: 20px;
        }
        
        .selected-school-card {
            background: white;
            border: 2px solid #e5e5ea;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .selection-summary {
            background: #007aff;
            color: white;
            border-radius: 12px;
            padding: 16px;
            margin: 20px 0;
            text-align: center;
        }
        
        .selection-summary h3 {
            margin: 0 0 8px 0;
            font-size: 18px;
            font-weight: 600;
        }
        
        .selection-summary p {
            margin: 0;
            opacity: 0.9;
            font-size: 14px;
        }
        
        .selection-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 16px;
        }
        
        .action-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .action-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Styles για το βήμα 6 - Οι επιλεγμένες σχολές */
        .selected-schools-list {
            margin-top: 20px;
        }
        
        .selected-school-card {
            background: white;
            border: 2px solid #e5e5ea;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .selected-priority-number {
            background: #007aff;
            color: white;
            border-radius: 8px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .selected-school-info {
            flex: 1;
        }
        
        .selected-school-name {
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 4px 0;
            color: #1d1d1f;
        }
        
        .selected-school-details {
            font-size: 14px;
            color: #86868b;
            margin: 0;
        }
        
        .remove-button {
            background: #ff3b30;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .remove-button:hover {
            background: #d70015;
            transform: scale(1.1);
        }
        
        .excel-export {
            text-align: center;
            margin-top: 30px;
        }
        
        .export-button {
            background: #34c759;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .export-button:hover {
            background: #28a745;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 199, 89, 0.3);
        }
        
        .export-button:disabled {
            background: #8e8e93;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .export-button:disabled:hover {
            background: #8e8e93;
            transform: none;
        }
        
        /* Scrollbar styling */
        .schools-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .schools-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .schools-container::-webkit-scrollbar-thumb {
            background: #c1c1c3;
            border-radius: 4px;
        }
        
        .schools-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8aa;
        }
        
        /* Hide default styles */
        .scholes-list,
        .schools-table-container,
        .school-selection,
        .selected-schools-summary,
        .selected-school-item,
        .calculator-step,
        .calculator-wizard { display: none; }
        
        /* Show only our new design */
        .step { 
            display: none; 
            width: 100%;
            position: relative;
        }
        .step.active { 
            display: block; 
        }
        
        .step-container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Drag & Drop Styles */
        .selected-school-item {
            position: relative;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: grab;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            min-height: 90px;
        }
        
        .selected-school-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-color: #007aff;
        }
        
        .selected-school-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
            transform: rotate(2deg);
        }
        
        .selected-school-item.drag-over {
            border-color: #007aff;
            border-width: 2px;
            background: #f0f8ff;
        }
        
        .drag-handle {
            color: #999;
            font-size: 18px;
            cursor: grab;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .drag-handle:hover {
            color: #007aff;
        }
        
        .drag-handle::before {
            content: "⋮⋮⋮";
            line-height: 0.5;
            letter-spacing: 1px;
        }
        
        .school-position {
            background: #007aff;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        
        .school-info {
            flex: 1;
        }
        
        .school-name {
            font-weight: 600;
            font-size: 16px;
            color: #333;
            margin-bottom: 5px;
        }
        
        .school-university {
            color: #666;
            font-size: 14px;
            margin-bottom: 3px;
        }
        
        .school-location {
            color: #999;
            font-size: 12px;
            font-style: italic;
        }
        
        .school-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 180px;
            padding: 12px 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            padding: 4px 0;
        }
        
        .stat-label {
            color: #666;
            font-weight: 500;
            min-width: 80px;
        }
        
        .stat-value {
            font-weight: 600;
            font-size: 14px;
            text-align: right;
        }
        
        .stat-value.max {
            color: #007aff;
        }
        
        .stat-value.avg {
            color: #34c759;
        }
        
        .stat-value.min {
            color: #ff9500;
        }
        
        .school-actions {
            display: flex;
            gap: 10px;
        }
        
        .remove-school-btn {
            background: #ff3b30;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .remove-school-btn:hover {
            background: #d70015;
        }
        
        .drag-instruction {
            background: #f0f8ff;
            border: 1px solid #007aff;
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 20px;
            color: #007aff;
            font-size: 14px;
            text-align: center;
        }
        
        .school-moria {
            color: #007aff;
            font-size: 14px;
            text-align: right;
            min-width: 80px;
        }
        
        .sortable-schools {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .final-results h3 {
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .no-schools-message {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .no-schools-message h3 {
            color: #999;
            margin-bottom: 10px;
        }
        
        .school-result:last-child {
            border-bottom: none;
        }
        
        .school-result.high-probability {
            background: #f0f8f0;
        }
        
        .probability-high { color: #28a745; font-weight: bold; }
        .probability-medium { color: #ffc107; font-weight: bold; }
        .probability-low { color: #dc3545; font-weight: bold; }
        
        .navigation {
            text-align: center;
            margin-top: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 5px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #5b3c2a;
            color: white;
        }
        
        .btn-primary:hover {
            background: #4a2f1f;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .excel-export-section {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        /* New styles for schools list */
        .no-schools-message {
            text-align: center;
            padding: 30px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            margin: 20px 0;
        }

        .no-schools-message h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .no-schools-message ul {
            text-align: left;
            max-width: 300px;
            margin: 15px auto 0;
        }

        .results-summary {
            text-align: center;
            margin-bottom: 25px;
            padding: 20px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-radius: 8px;
        }

        .results-summary h3 {
            margin: 0 0 10px 0;
        }

        .schools-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .school-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #ddd;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }

        .school-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .school-card.probability-high {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #f8fff9, #f0fff4);
        }

        .school-card.probability-medium {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, #fffef7, #fff8e1);
        }

        .school-card.probability-low {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #fff5f5, #ffeae9);
        }

        .school-rank {
            position: absolute;
            top: -10px;
            left: 20px;
            background: #5b3c2a;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 14px;
        }

        .school-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .school-name {
            margin: 0;
            color: #2c3e50;
            font-size: 18px;
            font-weight: 600;
            flex: 1;
            margin-right: 15px;
        }

        .probability-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
        }

        .probability-badge.high {
            background: #d4edda;
            color: #155724;
        }

        .probability-badge.medium {
            background: #fff3cd;
            color: #856404;
        }

        .probability-badge.low {
            background: #f8d7da;
            color: #721c24;
        }

        .university-name {
            color: #6c757d;
            margin: 0 0 15px 0;
            font-style: italic;
        }

        .school-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .detail-label {
            font-weight: 500;
            color: #495057;
        }

        .detail-value {
            font-weight: 600;
            color: #2c3e50;
        }

        .detail-value.user-moria {
            color: #5b3c2a;
            background: #f8f9fa;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .step-navigation {
            text-align: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .step-navigation .btn {
            margin: 0 10px;
        }

        @media (max-width: 768px) {
            .school-header {
                flex-direction: column;
                align-items: flex-start;
            }        .school-name {
            margin-right: 0;
            margin-bottom: 10px;
        }

        .school-details {
            grid-template-columns: 1fr;
        }
    }

    /* Scrollable schools table container */
    .schools-table-container {
        max-height: 500px;
        overflow-y: auto;
        overflow-x: auto;
        border: 2px solid #5b3c2a;
        border-radius: 8px;
        background: #fff;
        margin: 20px 0;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .schools-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }

    .schools-table thead {
        background: #5b3c2a;
        color: white;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .schools-table th,
    .schools-table td {
        padding: 12px 8px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }

    .schools-table th {
        font-weight: bold;
        white-space: nowrap;
    }

    .schools-table tr:hover {
        background-color: #f8f9fa;
    }

    .schools-table tbody tr:nth-child(even) {
        background-color: #f2f2f2;
    }

    .probability-cell {
        text-align: center;
        font-weight: bold;
    }

    .probability-high {
        color: #28a745;
        background-color: #d4edda;
    }

    .probability-medium {
        color: #ffc107;
        background-color: #fff3cd;
    }

    .probability-low {
        color: #dc3545;
        background-color: #f8d7da;
    }

    .schools-table-container::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    .schools-table-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .schools-table-container::-webkit-scrollbar-thumb {
        background: #5b3c2a;
        border-radius: 4px;
    }

    .schools-table-container::-webkit-scrollbar-thumb:hover {
        background: #4a2f1f;
    }

    /* School Selection Checkbox Styles */
    .school-card {
        position: relative;
    }

    .school-selection {
        position: absolute;
        top: 15px;
        right: 15px;
        display: flex;
        align-items: center;
        gap: 12px;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(248, 249, 250, 0.95));
        padding: 12px 18px;
        border-radius: 30px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.12), 0 2px 8px rgba(0,0,0,0.08);
        border: 2px solid rgba(91, 60, 42, 0.1);
        transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        backdrop-filter: blur(15px);
        cursor: pointer;
        overflow: hidden;
        position: relative;
    }

    .school-selection::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        transition: left 0.6s ease;
    }

    .school-selection:hover::before {
        left: 100%;
    }

    .school-selection:hover {
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 12px 35px rgba(0,0,0,0.18), 0 4px 12px rgba(91, 60, 42, 0.2);
        border-color: rgba(91, 60, 42, 0.3);
        background: linear-gradient(135deg, rgba(255, 255, 255, 1), rgba(251, 252, 253, 0.98));
    }

    .school-selection.selected {
        background: linear-gradient(135deg, #5b3c2a, #8b6c4a, #a67c5a);
        color: white;
        border-color: #5b3c2a;
        transform: scale(1.08) translateY(-2px);
        box-shadow: 0 15px 40px rgba(91, 60, 42, 0.4), 0 8px 20px rgba(91, 60, 42, 0.2);
        animation: selectedPulse 2s infinite ease-in-out;
    }

    @keyframes selectedPulse {
        0%, 100% {
            box-shadow: 0 15px 40px rgba(91, 60, 42, 0.4), 0 8px 20px rgba(91, 60, 42, 0.2);
        }
        50% {
            box-shadow: 0 20px 50px rgba(91, 60, 42, 0.5), 0 10px 25px rgba(91, 60, 42, 0.3);
        }
    }

    .school-selection input[type="checkbox"] {
        width: 22px;
        height: 22px;
        accent-color: #5b3c2a;
        cursor: pointer;
        transform: scale(1.3);
        transition: all 0.4s ease;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }

    .school-selection.selected input[type="checkbox"] {
        accent-color: white;
        filter: drop-shadow(0 2px 6px rgba(0,0,0,0.4));
        animation: checkboxBounce 0.6s ease;
    }

    @keyframes checkboxBounce {
        0%, 20%, 60%, 100% {
            transform: scale(1.3);
        }
        40% {
            transform: scale(1.5);
        }
        80% {
            transform: scale(1.2);
        }
    }

    .school-selection label {
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        margin: 0;
        user-select: none;
        transition: all 0.3s ease;
        text-shadow: 0 1px 3px rgba(0,0,0,0.1);
        letter-spacing: 0.5px;
    }

    .school-selection.selected label {
        color: white;
        text-shadow: 0 2px 4px rgba(0,0,0,0.4);
        font-weight: 700;
    }

    .priority-number {
        background: linear-gradient(135deg, #ff6b35, #f7931e, #ff8c42);
        color: white;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        font-weight: 800;
        box-shadow: 0 4px 15px rgba(255, 107, 53, 0.5), 0 2px 8px rgba(247, 147, 30, 0.3);
        border: 3px solid white;
        animation: priorityPulse 2.5s infinite ease-in-out;
        position: relative;
        overflow: hidden;
    }

    .priority-number::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
        transform: rotate(45deg);
        animation: priorityShine 3s infinite ease-in-out;
    }

    @keyframes priorityPulse {
        0%, 100% {
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.5), 0 2px 8px rgba(247, 147, 30, 0.3);
            transform: scale(1);
        }
        50% {
            box-shadow: 0 6px 25px rgba(255, 107, 53, 0.7), 0 4px 12px rgba(247, 147, 30, 0.5);
            transform: scale(1.05);
        }
    }

    @keyframes priorityShine {
        0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
        50% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        100% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
    }

    /* Selected Schools Styles */
    .selected-schools-summary {
        background: linear-gradient(135deg, #5b3c2a, #8b6c4a);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
    }

    .selected-schools-summary h3 {
        margin: 0 0 10px 0;
        font-size: 20px;
    }

    .selected-schools-summary p {
        margin: 0;
        opacity: 0.9;
    }

    .selected-school-item {
        background: linear-gradient(135deg, #ffffff, #fafafa);
        border: 2px solid #5b3c2a;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 18px;
        display: flex;
        align-items: center;
        gap: 18px;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 4px 15px rgba(0,0,0,0.08), 0 2px 8px rgba(91, 60, 42, 0.1);
        position: relative;
        overflow: hidden;
    }

    .selected-school-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(91, 60, 42, 0.05), transparent);
        transition: left 0.6s ease;
    }

    .selected-school-item:hover::before {
        left: 100%;
    }

    .selected-school-item:hover {
        box-shadow: 0 8px 25px rgba(0,0,0,0.12), 0 4px 15px rgba(91, 60, 42, 0.2);
        transform: translateY(-3px) scale(1.02);
        border-color: #8b6c4a;
        background: linear-gradient(135deg, #ffffff, #f8f9fa);
    }

    .selected-priority {
        background: linear-gradient(135deg, #5b3c2a, #8b6c4a, #a67c5a);
        color: white;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        font-weight: bold;
        flex-shrink: 0;
        box-shadow: 0 4px 15px rgba(91, 60, 42, 0.3), 0 2px 8px rgba(91, 60, 42, 0.2);
        border: 3px solid white;
        position: relative;
        overflow: hidden;
    }

    .selected-priority::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent);
        transform: rotate(45deg);
        animation: priorityShine 4s infinite ease-in-out;
    }

    .selected-school-info {
        flex: 1;
    }

    .selected-school-name {
        font-size: 16px;
        font-weight: bold;
        color: #5b3c2a;
        margin: 0 0 5px 0;
    }

    .selected-school-university {
        color: #666;
        font-size: 14px;
        margin: 0 0 8px 0;
    }

    .selected-school-details {
        display: flex;
        gap: 15px;
        font-size: 12px;
        color: #888;
    }

    .remove-selection {
        background: linear-gradient(135deg, #dc3545, #c82333, #bd2130);
        color: white;
        border: none;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        flex-shrink: 0;
        font-size: 16px;
        font-weight: bold;
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3), 0 2px 6px rgba(220, 53, 69, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.9);
        position: relative;
        overflow: hidden;
    }

    .remove-selection::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        transition: all 0.4s ease;
        transform: translate(-50%, -50%);
    }

    .remove-selection:hover::before {
        width: 100%;
        height: 100%;
    }

    .remove-selection:hover {
        background: linear-gradient(135deg, #e74c3c, #c0392b, #a93226);
        transform: scale(1.15) rotate(90deg);
        box-shadow: 0 8px 20px rgba(220, 53, 69, 0.5), 0 4px 12px rgba(220, 53, 69, 0.3);
        border-color: white;
    }

    .remove-selection:active {
        transform: scale(1.05) rotate(90deg);
        box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);
    }

    .remove-selection:hover .remove-icon {
        animation: removeShake 0.6s ease-in-out;
    }

    @keyframes removeShake {
        0%, 100% { transform: rotate(0deg); }
        25% { transform: rotate(-5deg); }
        75% { transform: rotate(5deg); }
    }

    /* Buttons for Selected Schools Actions */
    .selected-schools-actions {
        display: flex;
        gap: 10px;
        margin: 20px 0;
        justify-content: center;
        flex-wrap: wrap;
    }

    .action-btn {
        background: #5b3c2a;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        transition: all 0.3s ease;
    }

    .action-btn:hover {
        background: #4a2f1f;
        transform: translateY(-2px);
    }

    .action-btn.secondary {
        background: #6c757d;
    }

    .action-btn.secondary:hover {
        background: #545b62;
    }
    </style>
</head>
<body>
    <header>
        <div class="topbar">
            <div class="logo"><img src="../logo.png" alt="logo"></div>
            <nav>
                <a href="#">Αρχική Σελίδα</a>
                <a href="#">Προγράμματα</a>
                <a href="#">Πανελλαδικές Εξετάσεις</a>
                <a href="#">Φωτογραφίες</a>
                <a href="#">Σχετικά με εμάς</a>
            </nav>
            <div class="icons">
                <a href="#"><img src="../elements/Group 17.svg" alt="fb" class="facebook-icon"></a>
                <a href="#"><img src="../elements/mdi_instagram.svg" alt="insta" class="instagram-icon"></a>
                <a href="#"><img src="../elements/phone.svg" alt="phone"></a>
                <a href="#"><img src="../elements/mail.svg" alt="mail"></a>
            </div>
            <a href="../index2.html" class="login-btn" style="text-decoration: none;">Είσοδος</a>
        </div>
    </header>
    
    <main>
        <div class="wizard">
            <!-- Βήμα 1ο: Επιλογή Λυκείου -->
            <div class="step active" id="step1">
                <div class="step-container">
                    <div class="step-header">
                        <div class="step-number">
                            <h2>Βήμα 1ο:</h2>
                            <div class="step-circles">
                                <div class="step-circle active">1</div>
                                <div class="step-circle pending">2</div>
                                <div class="step-circle pending">3</div>
                                <div class="step-circle pending">4</div>
                                <div class="step-circle pending">5</div>
                                <div class="step-circle pending">6</div>
                            </div>
                        </div>
                        <h3 class="step-title">Επιλέξτε το Λύκειό σας</h3>
                    </div>
                    
                    <div class="radio-group">
                        <div class="radio-option" onclick="selectSchoolType('gel')">
                            <input type="radio" name="school-type" value="gel" id="gel-radio">
                            <label for="gel-radio">ΓΕΛ</label>
                        </div>
                        <div class="radio-option" onclick="selectSchoolType('epal')">
                            <input type="radio" name="school-type" value="epal" id="epal-radio">
                            <label for="epal-radio">ΕΠΑΛ</label>
                        </div>
                    </div>
                    
                    <div class="step-navigation">
                        <button class="nav-button secondary" disabled>Πίσω</button>
                        <button class="nav-button primary" onclick="goToStep2()" disabled id="next-btn-1">Επόμενο</button>
                    </div>
                </div>
            </div>

            <!-- Βήμα 2ο: Επιλογή Κατεύθυνσης -->
            <div class="step" id="step2">
                <div class="step-container">
                    <div class="step-header">
                        <div class="step-number">
                            <h2>Βήμα 2ο:</h2>
                            <div class="step-circles">
                                <div class="step-circle completed">1</div>
                                <div class="step-circle active">2</div>
                                <div class="step-circle pending">3</div>
                                <div class="step-circle pending">4</div>
                                <div class="step-circle pending">5</div>
                                <div class="step-circle pending">6</div>
                            </div>
                        </div>
                        <h3 class="step-title">Επιλέξτε το Πεδίο σας</h3>
                    </div>
                    
                    <div class="radio-group" id="field-options">
                        <!-- Θα συμπληρωθεί δυναμικά -->
                    </div>
                    
                    <div class="step-navigation">
                        <button class="nav-button secondary" onclick="goToStep1()">Πίσω</button>
                        <button class="nav-button primary" onclick="goToStep3()" disabled id="next-btn-2">Επόμενο</button>
                    </div>
                </div>
            </div>

            <!-- Βήμα 3ο: Εισαγωγή Βαθμών -->
            <div class="step" id="step3">
                <div class="step-container">
                    <div class="step-header">
                        <div class="step-number">
                            <h2>Βήμα 3ο:</h2>
                            <div class="step-circles">
                                <div class="step-circle completed">1</div>
                                <div class="step-circle completed">2</div>
                                <div class="step-circle active">3</div>
                                <div class="step-circle pending">4</div>
                                <div class="step-circle pending">5</div>
                                <div class="step-circle pending">6</div>
                            </div>
                        </div>
                        <h3 class="step-title">Συμπληρώστε τους Βαθμούς σας</h3>
                        <p class="step-subtitle">Νεοελληνική Γλώσσα και Λογοτεχνία</p>
                    </div>
                    
                    <div class="grade-inputs" id="grade-inputs">
                        <!-- Θα συμπληρωθεί δυναμικά -->
                    </div>
                    
                    <div class="step-navigation">
                        <button class="nav-button secondary" onclick="goToStep2()">Πίσω</button>
                        <button class="nav-button primary" onclick="goToStep4()" disabled id="next-btn-3">Επόμενο</button>
                    </div>
                </div>
            </div>

            <!-- Βήμα 4ο: Ειδικά Μαθήματα -->
            <div class="step" id="step4">
                <div class="step-container">
                    <div class="step-header">
                        <div class="step-number">
                            <h2>Βήμα 4ο:</h2>
                            <div class="step-circles">
                                <div class="step-circle completed">1</div>
                                <div class="step-circle completed">2</div>
                                <div class="step-circle completed">3</div>
                                <div class="step-circle active">4</div>
                                <div class="step-circle pending">5</div>
                                <div class="step-circle pending">6</div>
                            </div>
                        </div>
                        <h3 class="step-title">Συμπληρώστε τα Ειδικά μαθήματα</h3>
                    </div>
                    
                    <div class="special-subjects" id="special-subjects">
                        <!-- Θα συμπληρωθεί δυναμικά -->
                    </div>
                    
                    <div class="step-navigation">
                        <button class="nav-button secondary" onclick="goToStep3()">Πίσω</button>
                        <button class="nav-button primary" onclick="goToStep5()" id="next-btn-4">*Προεπιλογή Πεδίο</button>
                    </div>
                </div>
            </div>

            <!-- Βήμα 5ο: Επιλογή Σχολών -->
            <div class="step" id="step5">
                <div class="step-container">
                    <div class="step-header">
                        <div class="step-number">
                            <h2>Βήμα 5ο:</h2>
                            <div class="step-circles">
                                <div class="step-circle completed">1</div>
                                <div class="step-circle completed">2</div>
                                <div class="step-circle completed">3</div>
                                <div class="step-circle completed">4</div>
                                <div class="step-circle active">5</div>
                                <div class="step-circle pending">6</div>
                            </div>
                        </div>
                        <h3 class="step-title">Επιλογή Σχολών (κατά σειρά προτεραιότητας)</h3>
                    </div>
                    
                    <!-- Summary of selections -->
                    <div class="selection-summary" id="selection-summary" style="display: none;">
                        <h3 id="selection-count">0 σχολές επιλεγμένες</h3>
                        <p>Μπορείτε να επιλέξετε έως 20 σχολές</p>
                        <div class="selection-actions">
                            <button class="action-button" onclick="clearAllSelections()">Καθαρισμός Όλων</button>
                            <button class="action-button" onclick="goToStep6()">Ολοκλήρωση</button>
                        </div>
                    </div>
                    
                    <div class="schools-container" id="schools-container">
                        <!-- Θα συμπληρωθεί δυναμικά -->
                    </div>
                    
                    <div class="step-navigation">
                        <button class="nav-button secondary" onclick="goToStep4()">Πίσω</button>
                        <button class="nav-button primary" onclick="goToStep6()" disabled id="next-btn-5">Ολοκλήρωση</button>
                    </div>
                </div>
            </div>

            <!-- Βήμα 6ο: Αποτελέσματα -->
            <div class="step" id="step6">
                <div class="step-container">
                    <div class="step-header">
                        <div class="step-number">
                            <h2>Ολοκλήρωση:</h2>
                            <div class="step-circles">
                                <div class="step-circle completed">1</div>
                                <div class="step-circle completed">2</div>
                                <div class="step-circle completed">3</div>
                                <div class="step-circle completed">4</div>
                                <div class="step-circle completed">5</div>
                                <div class="step-circle active">6</div>
                            </div>
                        </div>
                        <h3 class="step-title">Αποτελέσματα</h3>
                    </div>
                    
                    <div class="selected-schools-list" id="selected-schools-list">
                        <!-- Θα συμπληρωθεί δυναμικά -->
                    </div>
                    
                    <div class="excel-export">
                        <button class="export-button" onclick="exportToExcel()">
                            📊 Κατέβασμα ως Excel (.xlsx)
                        </button>
                    </div>
                    
                    <div class="step-navigation">
                        <button class="nav-button secondary" onclick="goToStep5()">Πίσω</button>
                        <button class="nav-button primary" onclick="restartCalculator()">🔄 Νέος Υπολογισμός</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-content">
            <div class="footer-logo">Μαθητικό Στέκι</div>
            <div class="footer-links" data-id="footer-links">
                <span>Καθηγητές:</span>
                <span>...</span>
            </div>
            <div class="footer-map">
                <img src="../map.png" alt="Χάρτης">
            </div>
        </div>
        <div class="footer-bottom">
            &copy; 2025 Μαθητικό Στέκι
        </div>
    </footer>

    <script>
        // Global variables
        let currentStep = 1;
        let selectedSchoolType = '';
        let selectedField = '';
        let userGrades = {};
        let specialSubjects = {};
        let userMoria = 0;
        let filteredSchools = [];
        let schoolsData = [];  // Dynamic school data - loaded from API
        let selectedFieldCode = null;  // Selected field code for configurations
        let systemConfig = null;  // Configuration from system-config.json

        // Load system configuration and schools data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing calculator...');
            loadSystemConfiguration();
            loadSchoolsData();
        });

        // Load system configuration from JSON
        async function loadSystemConfiguration() {
            try {
                console.log('Loading system configuration...');
                const response = await fetch('./data/system-config.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                systemConfig = await response.json();
                console.log('System configuration loaded:', systemConfig);
            } catch (error) {
                console.error('Error loading system configuration:', error);
                // Fallback to hardcoded configs if needed
                console.log('Using fallback configurations');
            }
        }

        // Load schools data based on school type
        async function loadSchoolsData() {
            try {
                console.log('Loading schools data...');
                const response = await fetch('./data/schools-data.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                window.schoolsData = data;
                console.log('Schools data loaded:', data.length, 'schools');
            } catch (error) {
                console.error('Error loading schools data:', error);
                window.schoolsData = [];
            }
        }

        // Document ready initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing calculator...');
            loadSystemConfiguration();
            loadSchoolsData();
        });
        // Field configurations for ΓΕΛ (keeping as fallback only)
        const gelFieldConfigs = {
            anthropistikes: {
                name: "Ανθρωπιστικές, Νομικές και Κοινωνικές Επιστήμες",
                subjects: {
                    "Νεοελληνική Γλώσσα": { weight: 0.3, required: true },
                    "Αρχαία Ελληνικά": { weight: 0.3, required: true },
                    "Ιστορία": { weight: 0.2, required: true },
                    "Λατινικά": { weight: 0.2, required: false }
                },
                specialSubjects: ["Αγγλικά", "Γαλλικά", "Γερμανικά"]
            },
            thetikes: {
                name: "Θετικές και Τεχνολογικές Επιστήμες",
                subjects: {
                    "Μαθηματικά": { weight: 0.3, required: true },
                    "Φυσική": { weight: 0.3, required: true },
                    "Χημεία": { weight: 0.2, required: true },
                    "Βιολογία": { weight: 0.2, required: false }
                },
                specialSubjects: ["Αγγλικά", "Γαλλικά", "Γερμανικά"]
            },
            ygeia: {
                name: "Επιστήμες Υγείας",
                subjects: {
                    "Βιολογία": { weight: 0.3, required: true },
                    "Χημεία": { weight: 0.3, required: true },
                    "Φυσική": { weight: 0.2, required: true },
                    "Μαθηματικά": { weight: 0.2, required: false }
                },
                specialSubjects: ["Αγγλικά", "Γαλλικά", "Γερμανικά"]
            },
            oikonomikes: {
                name: "Επιστήμες Οικονομικών και Πληροφορικής",
                subjects: {
                    "Μαθηματικά": { weight: 0.3, required: true },
                    "Στατιστική": { weight: 0.3, required: true },
                    "Οικονομικά": { weight: 0.2, required: true },
                    "Πληροφορική": { weight: 0.2, required: false }
                },
                specialSubjects: ["Αγγλικά", "Γαλλικά", "Γερμανικά"]
            }
        };

        // Field configurations for ΕΠΑΛ
        const epalFieldConfigs = {
            pliroforiki: {
                name: "Πληροφορική",
                subjects: {
                    "Νεοελληνική Γλώσσα": { weight: 0.2, required: true },
                    "Μαθηματικά": { weight: 0.3, required: true },
                    "Προγραμματισμός": { weight: 0.3, required: true },
                    "Δίκτυα": { weight: 0.2, required: false }
                },
                specialSubjects: ["Βάσεις Δεδομένων", "Web Development", "Κυβερνοασφάλεια"]
            },
            tourismou: {
                name: "Τουρισμός",
                subjects: {
                    "Νεοελληνική Γλώσσα": { weight: 0.3, required: true },
                    "Μαθηματικά": { weight: 0.2, required: true },
                    "Τουριστικές Επιχειρήσεις": { weight: 0.3, required: true },
                    "Γεωγραφία": { weight: 0.2, required: false }
                },
                specialSubjects: ["Ξένες Γλώσσες", "Πολιτισμός", "Διαχείριση Προορισμών"]
            },
            technologiko: {
                name: "Τεχνολογικός Τομέας",
                subjects: {
                    "Νεοελληνική Γλώσσα": { weight: 0.2, required: true },
                    "Μαθηματικά": { weight: 0.3, required: true },
                    "Τεχνολογία": { weight: 0.3, required: true },
                    "Φυσική": { weight: 0.2, required: false }
                },
                specialSubjects: ["Αυτοματισμοί", "Ηλεκτρονικά", "Μηχανολογία"]
            },
            oikonomiko: {
                name: "Οικονομικός Τομέας",
                subjects: {
                    "Νεοελληνική Γλώσσα": { weight: 0.2, required: true },
                    "Μαθηματικά": { weight: 0.3, required: true },
                    "Οικονομικά": { weight: 0.3, required: true },
                    "Λογιστική": { weight: 0.2, required: false }
                },
                specialSubjects: ["Διοίκηση", "Μάρκετινγκ", "Επιχειρηματικότητα"]
            },
            mixanologia: {
                name: "Μηχανολογία",
                subjects: {
                    "Νεοελληνική Γλώσσα": { weight: 0.2, required: true },
                    "Μαθηματικά": { weight: 0.3, required: true },
                    "Μηχανολογικά": { weight: 0.3, required: true },
                    "Φυσική": { weight: 0.2, required: false }
                },
                specialSubjects: ["Αντοχή Υλικών", "Μηχανολογικό Σχέδιο", "Παραγωγή"]
            }
        };

        // Step 1: Set School Type (ΓΕΛ/ΕΠΑΛ)
        function setSchoolType(type) {
            selectedSchoolType = type;
            console.log('School type selected:', type);
            
            // Check if data is loaded
            if (!schoolsData || schoolsData.length === 0) {
                console.log('Data not yet loaded, enabling button but will check on next step');
            } else {
                // Filter schools by selected type and show count
                const filteredSchools = schoolsData.filter(school => school.schoolType === type);
                console.log(`Found ${filteredSchools.length} schools for ${type.toUpperCase()}`);
                
                if (filteredSchools.length === 0) {
                    alert(`Δεν βρέθηκαν δεδομένα για ${type.toUpperCase()}. Παρακαλώ επικοινωνήστε με τον διαχειριστή για να ανεβάσει τα κατάλληλα αρχεία σχολών.`);
                    return;
                }
            }
            
            document.getElementById('next-step1').disabled = false;
        }

        // Step 2: Set Field based on school type
        function setField(fieldName) {
            selectedField = fieldName;
            
            // Find the corresponding field code
            const mappedField = mapScientificFieldToReadableName(fieldName);
            if (mappedField) {
                selectedFieldCode = mappedField.code;
                console.log(`Selected field: ${fieldName} -> code: ${selectedFieldCode}`);
            } else {
                // Fallback - try to determine code from name
                const nameLower = fieldName.toLowerCase();
                if (nameLower.includes('θετικ')) {
                    selectedFieldCode = 'thetiko';
                } else if (nameLower.includes('ανθρωπιστικ')) {
                    selectedFieldCode = 'theoretiko';
                } else if (nameLower.includes('οικονομ')) {
                    selectedFieldCode = 'oikonomiko';
                } else if (nameLower.includes('πληροφορ')) {
                    selectedFieldCode = 'pliroforiki';
                } else {
                    selectedFieldCode = 'theoretiko'; // default
                }
                console.log(`Fallback field mapping: ${fieldName} -> code: ${selectedFieldCode}`);
            }
            
            document.getElementById('next-step2').disabled = false;
        }

        // Navigation functions
        function nextStep() {
            if (currentStep === 1) {
                console.log('Attempting to move to step 2...');
                console.log('Schools data available:', schoolsData ? schoolsData.length : 'null');
                
                // Check if data is loaded before proceeding
                if (!schoolsData || schoolsData.length === 0) {
                    alert('Περιμένετε να φορτωθούν τα δεδομένα σχολών από τον admin...');
                    return;
                }
                
                setupFieldOptions();
                showStep(2);
            } else if (currentStep === 2) {
                setupGradeInputs();
                showStep(3);
            } else if (currentStep === 3) {
                setupSpecialSubjects();
                showStep(4);
            } else if (currentStep === 4) {
                calculateAndShowResults();
                showStep(5);
            } else if (currentStep === 5) {
                // Move to step 6 to show selected schools
                viewSelectedSchools();
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                showStep(currentStep - 1);
            }
        }

        function showStep(stepNumber) {
            // Hide all steps
            for (let i = 1; i <= 6; i++) {
                document.getElementById(`step${i}`).style.display = 'none';
            }
            
            // Show current step
            document.getElementById(`step${stepNumber}`).style.display = 'block';
            currentStep = stepNumber;
            
            // If showing step 6, update the display
            if (stepNumber === 6) {
                updateStep6Display();
            }
        }

        function setupFieldOptions() {
            const container = document.getElementById('field-options');
            
            console.log('=== Setting up field options ===');
            console.log('Selected school type:', selectedSchoolType);
            console.log('Schools data available:', schoolsData ? schoolsData.length : 'null');
            
            // Get available scientific fields from admin data based on selected school type
            if (!schoolsData || schoolsData.length === 0) {
                container.innerHTML = '<p>⚠️ Δεν υπάρχουν διαθέσιμα δεδομένα σχολών από τον admin</p>';
                console.error('No schools data available for field options');
                return;
            }
            
            // Filter schools by selected school type and get unique scientific fields
            const availableSchools = schoolsData.filter(school => school.schoolType === selectedSchoolType);
            console.log(`Schools for ${selectedSchoolType}:`, availableSchools.length);
            console.log('Sample school:', availableSchools[0]);
            
            const uniqueFields = [...new Set(availableSchools.map(school => school.scientificField))];
            
            console.log(`Available scientific fields for ${selectedSchoolType}:`, uniqueFields);
            
            if (uniqueFields.length === 0) {
                container.innerHTML = `<p>⚠️ Δεν βρέθηκαν διαθέσιμες κατευθύνσεις για ${selectedSchoolType === 'gel' ? 'ΓΕΛ' : 'ΕΠΑΛ'}</p>`;
                console.error('No fields found for school type:', selectedSchoolType);
                return;
            }
            
            // Convert numeric fields to readable names
            const mappedFields = uniqueFields
                .filter(field => field && field.trim() && field !== 'ΕΠΙΣΤΗΜΟΝΙΚΑ ΠΕΔΙΑ') // Skip invalid fields
                .map(field => mapScientificFieldToReadableName(field))
                .filter(field => field !== null); // Remove unmapped fields
            
            console.log('Mapped fields:', mappedFields);
            
            if (mappedFields.length === 0) {
                container.innerHTML = `<p>⚠️ Δεν βρέθηκαν έγκυρες κατευθύνσεις για ${selectedSchoolType === 'gel' ? 'ΓΕΛ' : 'ΕΠΑΛ'}</p>`;
                return;
            }
            
            let html = '';
            mappedFields.forEach(fieldObj => {
                html += `
                    <label>
                        <input type="radio" name="field" value="${fieldObj.code}" onchange="setField('${fieldObj.name}')">
                        ${fieldObj.name}
                    </label>
                `;
            });
            
            container.innerHTML = html;
            console.log('Field options HTML generated successfully');
        }

        // Map scientific field numbers to readable names and codes
        function mapScientificFieldToReadableName(field) {
            const fieldStr = String(field).trim();
            
            // Handle numeric fields
            if (fieldStr === '1') {
                return { name: 'Ανθρωπιστικές Επιστήμες', code: 'theoretiko' };
            } else if (fieldStr === '2') {
                return { name: 'Θετικές Επιστήμες', code: 'thetiko' };
            } else if (fieldStr === '3') {
                return { name: 'Επιστήμες Υγείας και Ζωής', code: 'thetiko' };
            } else if (fieldStr === '4') {
                return { name: 'Οικονομικές Επιστήμες', code: 'oikonomiko' };
            }
            
            // Handle combined fields like "2/3", "1/2/3/4", etc.
            if (fieldStr.includes('/')) {
                const fieldNumbers = fieldStr.split('/');
                if (fieldNumbers.includes('2') || fieldNumbers.includes('3')) {
                    return { name: 'Θετικές Επιστήμες', code: 'thetiko' };
                } else if (fieldNumbers.includes('1')) {
                    return { name: 'Ανθρωπιστικές Επιστήμες', code: 'theoretiko' };
                } else if (fieldNumbers.includes('4')) {
                    return { name: 'Οικονομικές Επιστήμες', code: 'oikonomiko' };
                }
            }
            
            // Handle text fields (backup)
            const fieldLower = fieldStr.toLowerCase();
            if (fieldLower.includes('θετικ') || fieldLower.includes('μαθηματικ') || fieldLower.includes('φυσικ')) {
                return { name: 'Θετικές Επιστήμες', code: 'thetiko' };
            } else if (fieldLower.includes('ανθρωπιστικ') || fieldLower.includes('θεωρητικ') || fieldLower.includes('φιλολογ')) {
                return { name: 'Ανθρωπιστικές Επιστήμες', code: 'theoretiko' };
            } else if (fieldLower.includes('οικονομ') || fieldLower.includes('διοικητ')) {
                return { name: 'Οικονομικές Επιστήμες', code: 'oikonomiko' };
            } else if (fieldLower.includes('πληροφορ')) {
                return { name: 'Πληροφορική', code: 'pliroforiki' };
            }
            
            // Default fallback
            return null;
        }

        // Map scientific fields from admin data to existing field configurations
        function getFieldConfig(scientificField, schoolType) {
            const configs = schoolType === 'gel' ? gelFieldConfigs : epalFieldConfigs;
            
            // First try to map the scientific field to a readable name and get its code
            const mappedField = mapScientificFieldToReadableName(scientificField);
            if (mappedField && configs[mappedField.code]) {
                console.log(`Mapped '${scientificField}' to '${mappedField.code}'`);
                return configs[mappedField.code];
            }
            
            // Fallback to keyword matching
            const fieldLower = scientificField.toLowerCase();
            
            if (schoolType === 'gel') {
                if (fieldLower.includes('θεωρητικ') || fieldLower.includes('φιλολογ') || fieldLower.includes('ιστορ') || fieldLower.includes('φιλοσοφ') || fieldLower === '1' || fieldLower.includes('ανθρωπιστικ')) {
                    return configs.theoretiko;
                } else if (fieldLower.includes('θετικ') || fieldLower.includes('μαθηματικ') || fieldLower.includes('φυσικ') || fieldLower.includes('χημε') || fieldLower === '2' || fieldLower === '3') {
                    return configs.thetiko;
                } else if (fieldLower.includes('τεχνολογ') || fieldLower.includes('τεχνικ')) {
                    return configs.technologiko;
                } else if (fieldLower.includes('οικονομ') || fieldLower.includes('διοικητ')) {
                    return configs.oikonomiko;
                }
                // Default to theoretiko for GEL if no match
                return configs.theoretiko;
            } else {
                if (fieldLower.includes('πληροφορ') || fieldLower.includes('υπολογιστ')) {
                    return configs.pliroforiki;
                } else if (fieldLower.includes('μηχανολογ') || fieldLower.includes('μηχανικ')) {
                    return configs.mixanologia;
                }
                // Default to pliroforiki for EPAL if no match
                return configs.pliroforiki;
            }
        }

        function setupGradeInputs() {
            if (!selectedField || !selectedSchoolType || !selectedFieldCode) {
                console.log('Missing selections for grade inputs:', { selectedField, selectedSchoolType, selectedFieldCode });
                return;
            }
            
            const configs = selectedSchoolType === 'gel' ? gelFieldConfigs : epalFieldConfigs;
            const config = configs[selectedFieldCode];
            
            if (!config) {
                console.error('No configuration found for field code:', selectedFieldCode);
                return;
            }
            
            const container = document.getElementById('grade-inputs');
            
            let html = '<h3>Κύρια Μαθήματα</h3>';
            Object.entries(config.subjects).forEach(([subject, info]) => {
                const required = info.required ? ' *' : '';
                html += `
                    <div class="input-group">
                        <label>${subject}${required} (Συντελεστής: ${info.weight})</label>
                        <input type="number" 
                               id="grade-${subject.replace(/\s+/g, '-')}" 
                               class="grade-input"
                               min="0" max="20" step="0.1" 
                               placeholder="Εισάγετε βαθμό (0-20)"
                               ${info.required ? 'required' : ''}
                               onchange="checkGradesComplete()">
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function setupSpecialSubjects() {
            if (!selectedField || !selectedSchoolType || !selectedFieldCode) {
                console.log('Missing selections for special subjects:', { selectedField, selectedSchoolType, selectedFieldCode });
                return;
            }
            
            const configs = selectedSchoolType === 'gel' ? gelFieldConfigs : epalFieldConfigs;
            const config = configs[selectedFieldCode];
            
            if (!config) {
                console.error('No configuration found for special subjects with field code:', selectedFieldCode);
                return;
            }
            
            const container = document.getElementById('special-subjects');
            let html = '<h3>Ειδικά Μαθήματα (Προαιρετικά)</h3>';
            html += '<p>Κάθε ειδικό μάθημα προσθέτει 10% επιπλέον μόρια</p>';
            
            config.specialSubjects.forEach(subject => {
                html += `
                    <div class="input-group">
                        <label>${subject} (Προαιρετικό)</label>
                        <input type="number" 
                               id="special-${subject.replace(/\s+/g, '-')}" 
                               class="grade-input"
                               min="0" max="20" step="0.1" 
                               placeholder="Εισάγετε βαθμό (0-20)">
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function checkGradesComplete() {
            if (!selectedField || !selectedSchoolType) return;
            
            // Use the mapping function to get the appropriate config
            const config = getFieldConfig(selectedField, selectedSchoolType);
            
            if (!config) {
                console.error('No configuration found for grade check:', selectedField);
                return;
            }
            
            let allRequiredFilled = true;
            Object.entries(config.subjects).forEach(([subject, info]) => {
                if (info.required) {
                    const inputId = `grade-${subject.replace(/\s+/g, '-')}`;
                    const input = document.getElementById(inputId);
                    if (!input.value) {
                        allRequiredFilled = false;
                    }
                }
            });
            
            document.getElementById('next-step3').disabled = !allRequiredFilled;
        }

        function collectGrades() {
            if (!selectedField || !selectedSchoolType || !selectedFieldCode) {
                console.log('Missing required selections:', { selectedField, selectedSchoolType, selectedFieldCode });
                return false;
            }
            
            const configs = selectedSchoolType === 'gel' ? gelFieldConfigs : epalFieldConfigs;
            const config = configs[selectedFieldCode];
            
            if (!config) {
                console.error('No configuration found for field code:', selectedFieldCode);
                return false;
            }
            
            userGrades = {};
            specialSubjects = {};
            
            // Collect main subjects
            let hasRequiredGrades = true;
            Object.entries(config.subjects).forEach(([subject, info]) => {
                const inputId = `grade-${subject.replace(/\s+/g, '-')}`;
                const input = document.getElementById(inputId);
                const value = parseFloat(input.value);
                
                if (input.value && !isNaN(value)) {
                    userGrades[subject] = value;
                } else if (info.required) {
                    hasRequiredGrades = false;
                }
            });
            
            // Collect special subjects
            config.specialSubjects.forEach(subject => {
                const inputId = `special-${subject.replace(/\s+/g, '-')}`;
                const input = document.getElementById(inputId);
                const value = parseFloat(input.value);
                
                if (input.value && !isNaN(value)) {
                    specialSubjects[subject] = value;
                }
            });
            
            return hasRequiredGrades;
        }

        function calculateMoria() {
            if (!selectedField || !selectedSchoolType || !selectedFieldCode) {
                console.log('Missing selections for moria calculation:', { selectedField, selectedSchoolType, selectedFieldCode });
                return 0;
            }
            
            const configs = selectedSchoolType === 'gel' ? gelFieldConfigs : epalFieldConfigs;
            const config = configs[selectedFieldCode];
            
            if (!config) {
                console.error('No configuration found for moria calculation with field code:', selectedFieldCode);
                return 0;
            }
            
            let totalMoria = 0;
            
            // Calculate from main subjects
            Object.entries(config.subjects).forEach(([subject, info]) => {
                if (userGrades[subject]) {
                    totalMoria += userGrades[subject] * info.weight * 1000;
                }
            });
            
            // Add special subjects bonus (10% each)
            Object.values(specialSubjects).forEach(grade => {
                totalMoria += grade * 0.1 * 100;
            });
            
            return Math.round(totalMoria);
        }

        function calculateAndShowResults() {
            if (!collectGrades()) {
                alert('Παρακαλώ συμπληρώστε όλα τα υποχρεωτικά μαθήματα');
                return;
            }
            
            userMoria = calculateMoria();
            filterSchools();
            displayResults();
        }

        function filterSchools() {
            console.log('=== Filtering schools ===');
            console.log('Filter criteria:', {
                selectedSchoolType: selectedSchoolType,
                selectedField: selectedField,
                userMoria: userMoria,
                schoolsDataLength: Array.isArray(schoolsData) ? schoolsData.length : 'not array'
            });
            
            // Validate input data
            if (!Array.isArray(schoolsData) || schoolsData.length === 0) {
                console.error('❌ No schools data available for filtering');
                filteredSchools = [];
                return;
            }
            
            if (!selectedField || !selectedSchoolType) {
                console.error('❌ No field or school type selected for filtering');
                filteredSchools = [];
                return;
            }
            
            // Show available data structure
            const availableSchoolTypes = [...new Set(schoolsData.map(s => s.schoolType))];
            const availableScientificFields = [...new Set(schoolsData.map(s => s.scientificField))];
            console.log('Available school types:', availableSchoolTypes);
            console.log('Available scientific fields:', availableScientificFields);
            
            // Filter schools by school type first (ΓΕΛ/ΕΠΑΛ)
            const schoolTypeMatches = schoolsData.filter(school => 
                school.schoolType === selectedSchoolType
            );
            console.log(`Schools matching school type '${selectedSchoolType}':`, schoolTypeMatches.length);
            
            // Then filter by selected scientific field
            const fieldMatches = schoolTypeMatches.filter(school => 
                school.scientificField === selectedField
            );
            console.log(`Schools matching scientific field '${selectedField}':`, fieldMatches.length);
            
            if (fieldMatches.length === 0) {
                console.warn('⚠️ No schools found for the selected field. Showing all schools for this school type.');
                // If no exact field match, show all schools for the school type
                filteredSchools = schoolTypeMatches.filter(school => {
                    const minMoria = school.minMoria || 0;
                    return userMoria >= (minMoria - 1000); // Allow 1000 moria tolerance
                });
            } else {
                // Filter by moria requirements
                filteredSchools = fieldMatches.filter(school => {
                    const minMoria = school.minMoria || 0;
                    const maxMoria = school.maxMoria || 25000;
                    
                    // Show schools if user moria is within or close to range
                    const moriaMatch = userMoria >= (minMoria - 1000); // Allow 1000 moria tolerance
                    
                    console.log(`${school.name}: minMoria=${minMoria}, maxMoria=${maxMoria}, userMoria=${userMoria}, match=${moriaMatch}`);
                    
                    return moriaMatch;
                });
            }
            
            console.log(`✅ Final filtered schools: ${filteredSchools.length}`);
            
            // Sort by probability (best matches first)
            filteredSchools.sort((a, b) => {
                const scoreA = calculateProbabilityScore(a);
                const scoreB = calculateProbabilityScore(b);
                return scoreB - scoreA; // Descending order (best first)
            });
            
            console.log('Sorted schools by probability:', filteredSchools.map(s => ({ 
                name: s.name, 
                probability: calculateProbability(s) 
            })));
        }

        function displayResults() {
            document.getElementById('moria-value').textContent = userMoria.toLocaleString();
            
            const container = document.getElementById('schools-list');
            
            if (filteredSchools.length === 0) {
                container.innerHTML = `
                    <div class="no-schools-message">
                        <h3>😞 Δεν βρέθηκαν κατάλληλες σχολές</h3>
                        <p>Με τα μόρια που έχετε (${userMoria.toLocaleString()}), δεν βρέθηκαν σχολές της κατεύθυνσης που επιλέξατε.</p>
                        <p><strong>Συμβουλές:</strong></p>
                        <ul>
                            <li>Προσπαθήστε να βελτιώσετε τους βαθμούς σας</li>
                            <li>Εξετάστε άλλες κατευθύνσεις</li>
                            <li>Προσθέστε ειδικά μαθήματα για επιπλέον μόρια</li>
                        </ul>
                    </div>
                `;
                return;
            }
            
            // Create a beautiful list of schools with selection checkboxes
            let html = `
                <div class="results-summary">
                    <h3>🎓 Βρέθηκαν ${filteredSchools.length} κατάλληλες σχολές</h3>
                    <p>Οι σχολές είναι ταξινομημένες με βάση την πιθανότητα εισαγωγής</p>
                    <p><strong>💡 Tip:</strong> Επιλέξτε τις σχολές που σας ενδιαφέρουν για να δημιουργήσετε τη λίστα προτεραιότητάς σας!</p>
                </div>
                <div class="schools-list">
            `;
            
            filteredSchools.forEach((school, index) => {
                const probability = calculateProbability(school);
                const statusClass = probability > 70 ? 'high' : probability > 40 ? 'medium' : 'low';
                const statusIcon = probability > 70 ? '🟢' : probability > 40 ? '🟡' : '🔴';
                const statusText = probability > 70 ? 'Πολύ Καλή' : probability > 40 ? 'Μέτρια' : 'Χαμηλή';
                
                const isSelected = selectedSchools.some(s => s.id === school.id);
                const priorityIndex = selectedSchools.findIndex(s => s.id === school.id);
                const priorityNumber = priorityIndex >= 0 ? priorityIndex + 1 : '';
                
                html += `
                    <div class="school-card probability-${statusClass}" id="school-card-${school.id}">
                        <div class="school-selection ${isSelected ? 'selected' : ''}" onclick="toggleSchoolSelection('${school.id}')">
                            <input type="checkbox" id="checkbox-${school.id}" ${isSelected ? 'checked' : ''} onchange="toggleSchoolSelection('${school.id}')">
                            <label for="checkbox-${school.id}">Επιλογή</label>
                            ${isSelected ? `<div class="priority-number">${priorityNumber}</div>` : ''}
                        </div>
                        <div class="school-rank">#${index + 1}</div>
                        <div class="school-content">
                            <div class="school-header">
                                <h4 class="school-name">${school.name}</h4>
                                <div class="probability-badge ${statusClass}">
                                    ${statusIcon} ${statusText} (${probability}%)
                                </div>
                            </div>
                            <p class="university-name">${school.university}</p>
                            <div class="school-details">
                                <div class="detail-item">
                                    <span class="detail-label">Μέση Βάση:</span>
                                    <span class="detail-value">${(school.avgScore || 0).toLocaleString()} μόρια</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Ελάχιστα:</span>
                                    <span class="detail-value">${(school.minMoria || 0).toLocaleString()} μόρια</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Μέγιστα:</span>
                                    <span class="detail-value">${(school.maxMoria || 0).toLocaleString()} μόρια</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Τα μόρια σας:</span>
                                    <span class="detail-value user-moria">${userMoria.toLocaleString()} μόρια</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // Add selection summary and actions if schools are selected
            if (selectedSchools.length > 0) {
                html += `
                    <div class="selected-schools-actions">
                        <button class="action-btn" onclick="clearAllSelections()">
                            🗑️ Καθαρισμός Όλων
                        </button>
                        <button class="action-btn" onclick="viewSelectedSchools()">
                            👀 Προβολή Επιλεγμένων (${selectedSchools.length})
                        </button>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            // Show export section
            document.getElementById('excel-export-section').style.display = 'block';
        }

        function calculateProbability(school) {
            // If user moria is above maxMoria, very high probability
            if (userMoria > school.maxMoria) return 95;
            
            // If user moria is above avgScore, high probability
            if (userMoria >= school.avgScore) return 80;
            
            // If user moria is above minMoria, medium-high probability
            if (userMoria >= school.minMoria) return 60;
            
            // If user moria is close to minMoria (within 500), medium probability
            if (userMoria >= school.minMoria - 500) return 40;
            
            // If user moria is close to minMoria (within 1000), low probability
            if (userMoria >= school.minMoria - 1000) return 20;
            
            // Very low probability
            return 5;
        }

        // Calculate probability score for sorting (0-100)
        function calculateProbabilityScore(school) {
            const minMoria = school.minMoria || 0;
            const maxMoria = school.maxMoria || minMoria + 1000;
            const avgMoria = school.avgScore || ((minMoria + maxMoria) / 2);
            
            // If user has more moria than maxMoria, perfect score
            if (userMoria >= maxMoria) {
                return 100;
            }
            
            // If user has more than average, high score
            if (userMoria >= avgMoria) {
                const ratio = Math.min((userMoria - avgMoria) / (maxMoria - avgMoria), 1);
                return 80 + (ratio * 20); // 80-100
            }
            
            // If user has more than minimum, medium score
            if (userMoria >= minMoria) {
                const ratio = (userMoria - minMoria) / (avgMoria - minMoria);
                return 50 + (ratio * 30); // 50-80
            }
            
            // If user is close to minimum (within 1000), low score
            if (userMoria >= minMoria - 1000) {
                const ratio = (userMoria - (minMoria - 1000)) / 1000;
                return ratio * 50; // 0-50
            }
            
            // Very low score
            return 0;
        }

        function resetCalculator() {
            currentStep = 1;
            selectedSchoolType = '';
            selectedField = '';
            userGrades = {};
            specialSubjects = {};
            userMoria = 0;
            filteredSchools = [];
            selectedSchools = []; // Clear selected schools
            
            // DO NOT clear localStorage admin data - keep admin uploaded schools
            console.log('Calculator reset - keeping admin uploaded data');
            
            // Reload data (will use admin data if available)
            loadSchoolsData();
            
            // Reset all form inputs
            document.querySelectorAll('input[type="radio"]').forEach(input => input.checked = false);
            document.querySelectorAll('input[type="number"]').forEach(input => input.value = '');
            
            // Reset all buttons
            document.querySelectorAll('.btn[disabled]').forEach(btn => btn.disabled = true);
            document.getElementById('next-step1').disabled = true;
            
            // Show first step
            showStep(1);
        }

        // School Selection Functions
        function toggleSchoolSelection(schoolId) {
            const school = filteredSchools.find(s => s.id === schoolId);
            if (!school) return;
            
            const existingIndex = selectedSchools.findIndex(s => s.id === schoolId);
            
            if (existingIndex >= 0) {
                // Remove from selection
                selectedSchools.splice(existingIndex, 1);
                console.log(`Removed school ${school.name} from selection`);
            } else {
                // Add to selection
                selectedSchools.push({
                    ...school,
                    selectedAt: new Date(),
                    priority: selectedSchools.length + 1
                });
                console.log(`Added school ${school.name} to selection. Priority: ${selectedSchools.length}`);
            }
            
            // Update the UI to reflect the change
            updateSchoolSelectionUI();
            updateSelectedSchoolsCount();
        }

        function updateSchoolSelectionUI() {
            selectedSchools.forEach((school, index) => {
                const cardElement = document.getElementById(`school-card-${school.id}`);
                const checkboxElement = document.getElementById(`checkbox-${school.id}`);
                const selectionElement = cardElement?.querySelector('.school-selection');
                
                if (cardElement && checkboxElement && selectionElement) {
                    checkboxElement.checked = true;
                    selectionElement.classList.add('selected');
                    
                    // Update or add priority number
                    let priorityElement = selectionElement.querySelector('.priority-number');
                    if (!priorityElement) {
                        priorityElement = document.createElement('div');
                        priorityElement.className = 'priority-number';
                        selectionElement.appendChild(priorityElement);
                    }
                    priorityElement.textContent = index + 1;
                }
            });
            
            // Update deselected schools
            filteredSchools.forEach(school => {
                if (!selectedSchools.some(s => s.id === school.id)) {
                    const cardElement = document.getElementById(`school-card-${school.id}`);
                    const checkboxElement = document.getElementById(`checkbox-${school.id}`);
                    const selectionElement = cardElement?.querySelector('.school-selection');
                    
                    if (cardElement && checkboxElement && selectionElement) {
                        checkboxElement.checked = false;
                        selectionElement.classList.remove('selected');
                        
                        // Remove priority number
                        const priorityElement = selectionElement.querySelector('.priority-number');
                        if (priorityElement) {
                            priorityElement.remove();
                        }
                    }
                }
            });
        }

        function updateSelectedSchoolsCount() {
            const actionsContainer = document.querySelector('.selected-schools-actions');
            if (selectedSchools.length > 0) {
                if (!actionsContainer) {
                    // Re-render the display to show actions
                    displayResults();
                } else {
                    // Update count in existing button
                    const viewButton = actionsContainer.querySelector('button[onclick="viewSelectedSchools()"]');
                    if (viewButton) {
                        viewButton.innerHTML = `👀 Προβολή Επιλεγμένων (${selectedSchools.length})`;
                    }
                }
            } else {
                if (actionsContainer) {
                    actionsContainer.remove();
                }
            }
        }

        function clearAllSelections() {
            selectedSchools = [];
            updateSchoolSelectionUI();
            updateSelectedSchoolsCount();
            console.log('Cleared all school selections');
        }

        function viewSelectedSchools() {
            if (selectedSchools.length === 0) {
                alert('Δεν έχετε επιλέξει καμία σχολή ακόμα!');
                return;
            }
            
            // Update step 6 with selected schools
            updateStep6Display();
            
            // Navigate to step 6
            showStep(6);
        }

        function updateStep6Display() {
            const summaryElement = document.querySelector('#step6 .selected-schools-summary h3');
            const listElement = document.getElementById('selected-schools-list');
            const exportSection = document.getElementById('selected-excel-export-section');
            
            if (selectedSchools.length === 0) {
                summaryElement.textContent = '📋 Δεν έχετε επιλέξει σχολές ακόμα';
                listElement.innerHTML = '';
                exportSection.style.display = 'none';
                return;
            }
            
            summaryElement.textContent = `📋 Έχετε επιλέξει ${selectedSchools.length} σχολές με σειρά προτεραιότητας`;
            
            let html = '';
            selectedSchools.forEach((school, index) => {
                const probability = calculateProbability(school);
                const statusIcon = probability > 70 ? '🟢' : probability > 40 ? '🟡' : '🔴';
                
                html += `
                    <div class="selected-school-item">
                        <div class="selected-priority">${index + 1}</div>
                        <div class="selected-school-info">
                            <h4 class="selected-school-name">${school.name}</h4>
                            <p class="selected-school-university">${school.university}</p>
                            <div class="selected-school-details">
                                <span>${statusIcon} Πιθανότητα: ${probability}%</span>
                                <span>Μόρια: ${school.minMoria?.toLocaleString()} - ${school.maxMoria?.toLocaleString()}</span>
                                <span>Τα δικά σας: ${userMoria.toLocaleString()}</span>
                            </div>
                        </div>
                        <button class="remove-selection" onclick="removeSchoolSelection('${school.id}')" title="Αφαίρεση από τη λίστα">
                            <span class="remove-icon">✕</span>
                        </button>
                    </div>
                `;
            });
            
            listElement.innerHTML = html;
            exportSection.style.display = 'block';
        }

        function removeSchoolSelection(schoolId) {
            const index = selectedSchools.findIndex(s => s.id === schoolId);
            if (index >= 0) {
                const removedSchool = selectedSchools.splice(index, 1)[0];
                console.log(`Removed ${removedSchool.name} from selected schools`);
                
                // Update display
                updateStep6Display();
                
                // If we're on step 5, also update the UI there
                if (currentStep === 5) {
                    updateSchoolSelectionUI();
                    updateSelectedSchoolsCount();
                }
            }
        }

        function exportSelectedSchools() {
            if (selectedSchools.length === 0) {
                alert('Δεν έχετε επιλέξει καμία σχολή για εξαγωγή!');
                return;
            }
            
            // Prepare data for export
            const exportData = selectedSchools.map((school, index) => ({
                'Προτεραιότητα': index + 1,
                'Κωδικός': school.id,
                'Όνομα Σχολής': school.name,
                'Ίδρυμα': school.university,
                'Κατεύθυνση': school.field,
                'Τύπος Σχολής': school.schoolType === 'gel' ? 'ΓΕΛ' : 'ΕΠΑΛ',
                'Μέση Βάση': school.avgScore || 0,
                'Ελάχιστα Μόρια': school.minMoria || 0,
                'Μέγιστα Μόρια': school.maxMoria || 0,
                'Τα Μόρια σας': userMoria,
                'Πιθανότητα Εισαγωγής (%)': calculateProbability(school),
                'Επιστημονικό Πεδίο': school.scientificField,
                'Τύπος Θέσης': school.positionType
            }));
            
            // Create and download Excel file
            try {
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Επιλεγμένες Σχολές');
                
                // Style the header row
                const headerRow = 1;
                const cols = Object.keys(exportData[0]);
                cols.forEach((col, index) => {
                    const cellAddr = XLSX.utils.encode_cell({ r: 0, c: index });
                    if (ws[cellAddr]) {
                        ws[cellAddr].s = {
                            font: { bold: true },
                            fill: { fgColor: { rgb: "5b3c2a" } },
                            alignment: { horizontal: "center" }
                        };
                    }
                });
                
                // Auto-size columns
                const maxWidth = cols.map(col => 
                    Math.max(
                        col.length,
                        ...exportData.map(row => String(row[col] || '').length)
                    )
                );
                ws['!cols'] = maxWidth.map(w => ({ wch: Math.min(w + 2, 50) }));
                
                // Generate filename with timestamp
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const filename = `Επιλεγμένες_Σχολές_${timestamp}.xlsx`;
                
                XLSX.writeFile(wb, filename);
                
                console.log(`Exported ${selectedSchools.length} selected schools to ${filename}`);
                alert(`Οι επιλεγμένες σχολές εξήχθησαν επιτυχώς!\nΑρχείο: ${filename}`);
            } catch (error) {
                console.error('Error exporting selected schools:', error);
                alert('Σφάλμα κατά την εξαγωγή των δεδομένων. Παρακαλώ δοκιμάστε ξανά.');
            }
        }

        // Additional calculator functions continue below...

        // Cleanup completed - all required functions are implemented above

        // Initialize the calculator when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing moria calculator...');
            
            // Set initial step first
            showStep(1);
            
            // Load schools data from API
            loadSchoolsData().then(() => {
                console.log('Schools data loaded successfully');
                console.log('Total schools loaded:', schoolsData ? schoolsData.length : 0);
            }).catch(error => {
                console.error('Failed to load schools data:', error);
                // Still show the interface, admin will need to upload data
            });
        });

        // Input validation for grade inputs
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('grade-input')) {
                let value = parseFloat(e.target.value);
                if (value < 0) e.target.value = 0;
                if (value > 20) e.target.value = 20;
                
                // Update navigation buttons when grades change
                if (currentStep === 3) {
                    checkGradesComplete();
                }
            }
        });

        // Go to step 2 (field selection)
        function goToStep2() {
            if (!selectedSchoolType) {
                alert('Παρακαλώ επιλέξτε τον τύπο λυκείου');
                return;
            }
            
            currentStep = 2;
            
            // Hide step 1 and show step 2
            const step1 = document.getElementById('step1');
            const step2 = document.getElementById('step2');
            
            if (step1) {
                step1.classList.remove('active');
                step1.style.display = 'none';
            }
            if (step2) {
                step2.classList.add('active');
                step2.style.display = 'block';
            }
            
            // Update step circles
            updateStepCircles(2);
            
            // Load field options based on school type
            loadFieldOptions();
        }

        // Function to load field options
        function loadFieldOptions() {
            const fieldOptionsContainer = document.getElementById('field-options');
            if (!fieldOptionsContainer) return;
            
            let fieldOptions = [];
            
            if (selectedSchoolType === 'gel') {
                // Use system configuration if available
                if (systemConfig && systemConfig.lykeiaTypes) {
                    const gelConfig = systemConfig.lykeiaTypes.find(type => type.id === 'gel');
                    if (gelConfig && gelConfig.pedia) {
                        fieldOptions = gelConfig.pedia.map(fieldId => ({
                            value: fieldId,
                            name: systemConfig.pedia[fieldId] ? systemConfig.pedia[fieldId].name : fieldId
                        }));
                    }
                }
                
                // Fallback if no system config
                if (fieldOptions.length === 0) {
                    fieldOptions = [
                        { value: 'anthropistikes', name: 'Ανθρωπιστικές, Νομικές και Κοινωνικές Επιστήμες' },
                        { value: 'thetikes', name: 'Θετικές και Τεχνολογικές Επιστήμες' },
                        { value: 'ygeia', name: 'Επιστήμες Υγείας' },
                        { value: 'oikonomikes', name: 'Επιστήμες Οικονομικών και Πληροφορικής' }
                    ];
                }
            } else if (selectedSchoolType === 'epal') {
                // Use system configuration if available
                if (systemConfig && systemConfig.lykeiaTypes) {
                    const epalConfig = systemConfig.lykeiaTypes.find(type => type.id === 'epal');
                    if (epalConfig && epalConfig.pedia) {
                        fieldOptions = epalConfig.pedia.map(fieldId => ({
                            value: fieldId,
                            name: systemConfig.pedia[fieldId] ? systemConfig.pedia[fieldId].name : fieldId
                        }));
                    }
                }
                
                // Fallback if no system config
                if (fieldOptions.length === 0) {
                    fieldOptions = [
                        { value: 'technologika', name: 'Τεχνολογικά Τμήματα' },
                        { value: 'oikonomika', name: 'Οικονομικά και Διοίκηση' },
                        { value: 'tourismou', name: 'Τουρισμός' }
                    ];
                }
            }
            
            let html = '';
            fieldOptions.forEach(field => {
                html += `
                    <div class="radio-option" onclick="selectField('${field.value}')">
                        <input type="radio" name="field-type" value="${field.value}" id="field-${field.value}">
                        <label for="field-${field.value}">${field.name}</label>
                    </div>
                `;
            });
            
            fieldOptionsContainer.innerHTML = html;
            console.log('Field options loaded for:', selectedSchoolType, 'with', fieldOptions.length, 'options');
        }

        // Navigation functions
        function goToStep1() {
            currentStep = 1;
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step1').classList.add('active');
            document.getElementById('step1').style.display = 'block';
            
            // Update step circles
            updateStepCircles(1);
        }

        function selectField(fieldValue) {
            selectedField = fieldValue;
            
            // Update UI - handle both radio-option and option-card classes
            document.querySelectorAll('#field-options .radio-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelectorAll('.option-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selected class to the clicked element
            const clickedElement = event.target.closest('.radio-option') || event.target.closest('.option-card');
            if (clickedElement) {
                clickedElement.classList.add('selected');
            }
            
            // Enable the appropriate next button
            const nextBtn2 = document.getElementById('next-btn-2');
            const nextFieldGel = document.getElementById('next_field_gel');
            const nextFieldEpal = document.getElementById('next_field_epal');
            
            if (nextBtn2) nextBtn2.disabled = false;
            if (nextFieldGel) nextFieldGel.disabled = false;
            if (nextFieldEpal) nextFieldEpal.disabled = false;
        }

        function goToStep3() {
            if (!selectedField) {
                alert('Παρακαλώ επιλέξτε το πεδίο σας');
                return;
            }
            
            currentStep = 3;
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step3').classList.add('active');
            document.getElementById('step3').style.display = 'block';
            
            // Update step circles
            updateStepCircles(3);
            
            // Load grade inputs based on selected field
            loadGradeInputs();
        }

        function goToStep4() {
            if (!validateAllGrades()) {
                alert('Παρακαλώ συμπληρώστε όλα τα υποχρεωτικά μαθήματα με βαθμούς από 0 έως 20');
                return;
            }
            
            currentStep = 4;
            document.getElementById('step3').classList.remove('active');
            document.getElementById('step3').style.display = 'none';
            document.getElementById('step4').classList.add('active');
            document.getElementById('step4').style.display = 'block';
            
            updateStepCircles(4);
            loadSpecialSubjects();
        }

        function validateAllGrades() {
            const gradeInputs = document.querySelectorAll('#grade-inputs input[required]');
            let allValid = true;
            
            gradeInputs.forEach(input => {
                const value = parseFloat(input.value);
                if (!input.value || isNaN(value) || value < 0 || value > 20) {
                    allValid = false;
                }
            });
            
            return allValid;
        }

        function loadSpecialSubjects() {
            const specialSubjectsContainer = document.getElementById('special-subjects');
            if (!specialSubjectsContainer) return;
            
            // Get field configuration from system config
            let fieldConfig = null;
            if (systemConfig && systemConfig.pedia && systemConfig.pedia[selectedField]) {
                fieldConfig = systemConfig.pedia[selectedField];
                console.log('Using system config for special subjects:', selectedField, fieldConfig);
            }
            
            if (!fieldConfig || !fieldConfig.eidikaMathimata || fieldConfig.eidikaMathimata.length === 0) {
                console.log('No special subjects configuration found for field:', selectedField);
                specialSubjectsContainer.innerHTML = '<p>Δεν υπάρχουν ειδικά μαθήματα για το επιλεγμένο πεδίο.</p>';
                document.getElementById('next-btn-4').disabled = false;
                return;
            }
            
            let html = '<div class="special-subjects-grid">';
            
            fieldConfig.eidikaMathimata.forEach((subjectName, index) => {
                const subjectId = `special-${selectedField}-${index + 1}`;
                html += `
                    <div class="special-subject-input">
                        <label for="${subjectId}">${subjectName} (Προαιρετικό)</label>
                        <input type="number" 
                               id="${subjectId}" 
                               name="${subjectName}"
                               min="0" 
                               max="20" 
                               step="0.1" 
                               placeholder="0.0-20.0" 
                               onchange="validateSpecialSubjects()">
                    </div>
                `;
            });
            
            html += '</div>';
            html += '<p class="optional-note">Όλα τα ειδικά μαθήματα είναι προαιρετικά και μπορούν να βοηθήσουν στον υπολογισμό των μορίων</p>';
            
            specialSubjectsContainer.innerHTML = html;
            document.getElementById('next-btn-4').disabled = false; // Special subjects are optional
        }

        function validateSpecialSubjects() {
            // Special subjects are optional, so always enable next button
            document.getElementById('next-btn-4').disabled = false;
        }

        function updateStepCircles(activeStep) {
            document.querySelectorAll('.step-circle').forEach((circle, index) => {
                circle.classList.remove('active', 'completed', 'pending');
                if (index < activeStep - 1) {
                    circle.classList.add('completed');
                } else if (index === activeStep - 1) {
                    circle.classList.add('active');
                } else {
                    circle.classList.add('pending');
                }
            });
        }

        function loadGradeInputs() {
            console.log('loadGradeInputs called');
            console.log('selectedSchoolType:', selectedSchoolType);
            console.log('selectedField:', selectedField);
            
            const gradeInputsContainer = document.getElementById('grade-inputs');
            if (!gradeInputsContainer) {
                console.log('No grade-inputs container found!');
                return;
            }
            
            // Clear previous content
            gradeInputsContainer.innerHTML = '';
            
            // Get field configuration from system config
            let fieldConfig = null;
            if (systemConfig && systemConfig.pedia && systemConfig.pedia[selectedField]) {
                fieldConfig = systemConfig.pedia[selectedField];
                console.log('Using system config for field:', selectedField, fieldConfig);
            }
            
            if (!fieldConfig) {
                console.log('No field configuration found for:', selectedField);
                gradeInputsContainer.innerHTML = '<p>Δεν βρέθηκε ρύθμιση για το επιλεγμένο πεδίο.</p>';
                return;
            }
            
            // Update step subtitle with field name
            const stepSubtitle = document.querySelector('#step3 .step-subtitle');
            if (stepSubtitle) {
                stepSubtitle.textContent = fieldConfig.name;
            }
            
            // Create input fields for main subjects only (based on system config)
            let html = '<div class="subjects-grid">';
            
            if (fieldConfig.mathimata && Array.isArray(fieldConfig.mathimata)) {
                fieldConfig.mathimata.forEach(subject => {
                    const requiredText = subject.required ? ' (Υποχρεωτικό)' : ' (Προαιρετικό)';
                    const requiredAttr = subject.required ? 'required' : '';
                    const subjectId = subject.key; // Use the key from config
                    
                    html += `
                        <div class="subject-input">
                            <label for="${subjectId}">${subject.name}${requiredText}</label>
                            <input type="number" 
                                   id="${subjectId}" 
                                   name="${subject.name}"
                                   min="0" 
                                   max="20" 
                                   step="0.1" 
                                   placeholder="0.0-20.0" 
                                   ${requiredAttr}
                                   onchange="validateGradeInputs()">
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            gradeInputsContainer.innerHTML = html;
            console.log('Grade inputs loaded for main subjects from system config');
        }

        function validateGradeInputs() {
            const gradeInputs = document.querySelectorAll('#grade-inputs input[required]');
            let allValid = true;
            
            gradeInputs.forEach(input => {
                const value = parseFloat(input.value);
                if (!input.value || isNaN(value) || value < 0 || value > 20) {
                    allValid = false;
                }
            });
            
            document.getElementById('next-btn-3').disabled = !allValid;
        }

        function goToStep5() {
            currentStep = 5;
            document.getElementById('step4').classList.remove('active');
            document.getElementById('step4').style.display = 'none';
            document.getElementById('step5').classList.add('active');
            document.getElementById('step5').style.display = 'block';
            
            updateStepCircles(5);
            loadSchoolSelections();
            showUserMoria(); // Show user's calculated moria
        }

        function loadSchoolSelections() {
            console.log('loadSchoolSelections called');
            console.log('schoolsData available:', !!window.schoolsData);
            console.log('schoolsData length:', window.schoolsData ? window.schoolsData.length : 0);
            
            const schoolsContainer = document.getElementById('schools-container');
            if (!schoolsContainer) {
                console.log('No schools-container found!');
                return;
            }
            
            if (!window.schoolsData || window.schoolsData.length === 0) {
                schoolsContainer.innerHTML = `
                    <div class="no-schools-message">
                        <h3>Δεν υπάρχουν διαθέσιμα δεδομένα σχολών</h3>
                        <p>Παρακαλώ επικοινωνήστε με τον διαχειριστή για να φορτώσει τα δεδομένα.</p>
                    </div>
                `;
                return;
            }
            
            console.log('Selected school type:', selectedSchoolType);
            console.log('Selected field:', selectedField);
            
            // Filter schools based on selected field and school type
            let filteredSchools = [];
            
            // Get field configuration from system config
            let fieldConfig = null;
            if (systemConfig && systemConfig.pedia && systemConfig.pedia[selectedField]) {
                fieldConfig = systemConfig.pedia[selectedField];
            }
            
            if (fieldConfig && fieldConfig.dataFile) {
                // Try to load schools from the specific data file mentioned in config
                console.log(`Field config suggests data file: ${fieldConfig.dataFile}`);
                
                // For now, filter from the main schools data based on field
                filteredSchools = window.schoolsData.filter(school => {
                    // Check if school type matches
                    if (school.schoolType !== selectedSchoolType) return false;
                    
                    // For field matching, we need to map scientificField to our field codes
                    const schoolFieldMatch = checkSchoolFieldMatch(school, selectedField);
                    
                    if (schoolFieldMatch) {
                        console.log(`Match found: ${school.name} - scientificField: ${school.scientificField}`);
                    }
                    
                    return schoolFieldMatch;
                });
            } else {
                // Fallback to original filtering logic
                filteredSchools = window.schoolsData.filter(school => {
                    return school.schoolType === selectedSchoolType;
                });
            }
            
            console.log('Filtered schools:', filteredSchools.length);
            
            if (filteredSchools.length === 0) {
                schoolsContainer.innerHTML = `
                    <div class="no-schools-message">
                        <h3>Δεν βρέθηκαν σχολές για το επιλεγμένο πεδίο</h3>
                        <p>Δοκιμάστε να επιλέξετε διαφορετικό πεδίο ή επικοινωνήστε με τον διαχειριστή.</p>
                    </div>
                `;
                return;
            }
            
            // Sort schools by maxMoria (highest first)
            const sortedSchools = filteredSchools.sort((a, b) => {
                const aMoria = parseFloat(a.maxMoria) || 0;
                const bMoria = parseFloat(b.maxMoria) || 0;
                return bMoria - aMoria;
            });
            
            let html = '<div class="schools-list">';
            html += '<div class="schools-header">';
            html += '<h3>Διαθέσιμες Σχολές</h3>';
            html += `<p>Βρέθηκαν ${sortedSchools.length} σχολές. Κάντε κλικ για να επιλέξετε έως 20 σχολές</p>`;
            html += '</div>';
            
            sortedSchools.forEach((school, index) => {
                const maxMoria = school.maxMoria ? parseFloat(school.maxMoria) : null;
                const minMoria = school.minMoria ? parseFloat(school.minMoria) : null;
                const avgScore = school.avgScore ? parseFloat(school.avgScore) : null;
                
                html += `
                    <div class="school-item" data-school-id="${school.id}" onclick="toggleSchoolSelection('${school.id}')">
                        <div class="school-info">
                            <h4>${school.name}</h4>
                            <p>${school.university}</p>
                            <span class="school-field">${getFieldDisplayName(selectedField)}</span>
                        </div>
                        <div class="school-stats">
                            <div class="stat-item">
                                <span class="stat-label">Μέγιστα:</span>
                                <span class="stat-value max">${maxMoria ? maxMoria.toFixed(1) : 'Δ/Υ'}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Μέσος όρος:</span>
                                <span class="stat-value avg">${avgScore ? avgScore.toFixed(1) : 'Δ/Υ'}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Ελάχιστα:</span>
                                <span class="stat-value min">${minMoria ? minMoria.toFixed(1) : 'Δ/Υ'}</span>
                            </div>
                        </div>
                        <div class="selection-indicator">
                            <span class="checkmark">✓</span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            schoolsContainer.innerHTML = html;
            console.log('Schools HTML set');
        }

        // Helper function to check if a school matches the selected field
        function checkSchoolFieldMatch(school, selectedField) {
            // This function maps the numeric scientificField to our field codes
            // Based on the data structure, we need to create a mapping
            
            if (selectedSchoolType === 'gel') {
                // For GEL schools, map scientificField numbers to field codes
                const gelFieldMapping = {
                    '1': 'anthropistikes',     // Humanities
                    '2': 'thetikes',           // Positive sciences  
                    '3': 'ygeia',              // Health sciences
                    '4': 'oikonomikes',        // Economics/Informatics
                    '2/3': ['thetikes', 'ygeia'],  // Multiple fields
                    '2/4': ['thetikes', 'oikonomikes'],
                    '1/2': ['anthropistikes', 'thetikes'],
                };
                
                const schoolFields = gelFieldMapping[school.scientificField];
                if (Array.isArray(schoolFields)) {
                    return schoolFields.includes(selectedField);
                } else {
                    return schoolFields === selectedField;
                }
            } else if (selectedSchoolType === 'epal') {
                // For EPAL schools, the scientificField might already be normalized
                return school.scientificField === selectedField;
            }
            
            return false;
        }

        function calculateMoria(school) {
            // Use the correct field from admin data
            // Based on the logs, we should use maxMoria as the representative score
            if (school.maxMoria !== undefined) {
                return parseFloat(school.maxMoria) || 0;
            }
            
            // Fallback to other fields if maxMoria doesn't exist
            if (school.moria !== undefined) {
                return parseFloat(school.moria) || 0;
            }
            if (school.baseMoria !== undefined) {
                return parseFloat(school.baseMoria) || 0;
            }
            if (school.cutoff !== undefined) {
                return parseFloat(school.cutoff) || 0;
            }
            
            return 0;
        }

        function getFieldName(fieldCode) {
            const fieldNames = {
                // GEL fields
                'theoretiko': 'Θεωρητικό',
                'thetiko': 'Θετικό', 
                'technologiko': 'Τεχνολογικό',
                'oikonomiko': 'Οικονομικό',
                'pliroforiki': 'Πληροφορική',
                // EPAL fields
                'tourismou': 'Τουρισμός - Επισιτισμός',
                'ygeias': 'Υγεία - Πρόνοια - Ευεξία',
                'technon': 'Εφαρμοσμένες Τέχνες',
                'georgiko': 'Γεωπονία, Τρόφιμα και Περιβάλλον'
            };
            return fieldNames[fieldCode] || fieldCode;
        }

        let selectedSchools = [];

        function toggleSchoolSelection(schoolId) {
            const schoolElement = document.querySelector(`[data-school-id="${schoolId}"]`);
            
            if (selectedSchools.includes(schoolId)) {
                // Remove from selection
                selectedSchools = selectedSchools.filter(id => id !== schoolId);
                schoolElement.classList.remove('selected');
            } else {
                // Add to selection (max 20)
                if (selectedSchools.length < 20) {
                    selectedSchools.push(schoolId);
                    schoolElement.classList.add('selected');
                } else {
                    alert('Μπορείτε να επιλέξετε έως 20 σχολές');
                    return;
                }
            }
            
            updateSelectionSummary();
        }

        function updateSelectionSummary() {
            const summaryElement = document.getElementById('selection-summary');
            const countElement = document.getElementById('selection-count');
            const nextBtn = document.getElementById('next-btn-5');
            
            if (selectedSchools.length > 0) {
                summaryElement.style.display = 'block';
                countElement.textContent = `${selectedSchools.length} σχολές επιλεγμένες`;
                nextBtn.disabled = false;
            } else {
                summaryElement.style.display = 'none';
                nextBtn.disabled = true;
            }
            
            // Update user moria display if we're on step 5
            if (currentStep === 5) {
                showUserMoria();
            }
        }

        function clearAllSelections() {
            selectedSchools = [];
            document.querySelectorAll('.school-item.selected').forEach(item => {
                item.classList.remove('selected');
            });
            updateSelectionSummary();
        }

        function goToStep6() {
            if (selectedSchools.length === 0) {
                alert('Παρακαλώ επιλέξτε τουλάχιστον μία σχολή');
                return;
            }
            
            currentStep = 6;
            document.getElementById('step5').classList.remove('active');
            document.getElementById('step5').style.display = 'none';
            document.getElementById('step6').classList.add('active');
            document.getElementById('step6').style.display = 'block';
            
            updateStepCircles(6);
            displayFinalResults();
            showUserMoria(); // Show user's calculated moria
        }

        // Calculate and show user's moria
        function showUserMoria() {
            const userMoria = calculateUserMoria();
            
            // Create or update user moria display
            let moriaDisplay = document.getElementById('user-moria-display');
            if (!moriaDisplay) {
                moriaDisplay = document.createElement('div');
                moriaDisplay.id = 'user-moria-display';
                moriaDisplay.className = 'user-moria-container';
            }
            
            // Calculate some statistics if we're on step 6 with selected schools
            let comparisonText = '';
            if (currentStep === 6 && selectedSchools.length > 0) {
                const selectedSchoolsData = selectedSchools.map(schoolId => {
                    return window.schoolsData.find(school => school.id === schoolId);
                }).filter(school => school);
                
                const schoolMoriaValues = selectedSchoolsData
                    .map(school => parseFloat(school.maxMoria))
                    .filter(moria => !isNaN(moria));
                
                if (schoolMoriaValues.length > 0) {
                    const maxSchoolMoria = Math.max(...schoolMoriaValues);
                    const minSchoolMoria = Math.min(...schoolMoriaValues);
                    const avgSchoolMoria = schoolMoriaValues.reduce((sum, val) => sum + val, 0) / schoolMoriaValues.length;
                    
                    comparisonText = `
                        <div class="moria-comparison">
                            <div class="comparison-item">
                                <span class="comparison-label">Μέγιστα επιλεγμένων:</span>
                                <span class="comparison-value">${maxSchoolMoria.toFixed(0)}</span>
                            </div>
                            <div class="comparison-item">
                                <span class="comparison-label">Μέσος όρος επιλεγμένων:</span>
                                <span class="comparison-value">${avgSchoolMoria.toFixed(0)}</span>
                            </div>
                            <div class="comparison-item">
                                <span class="comparison-label">Ελάχιστα επιλεγμένων:</span>
                                <span class="comparison-value">${minSchoolMoria.toFixed(0)}</span>
                            </div>
                        </div>
                    `;
                }
            }
            
            moriaDisplay.innerHTML = `
                <div class="user-moria-box">
                    <div class="user-moria-header">
                        <span class="user-icon">👤</span>
                        <h4>Τα Μόρια σας</h4>
                    </div>
                    <div class="user-moria-value">${userMoria.toFixed(0)}</div>
                    <div class="user-moria-label">μόρια</div>
                    ${comparisonText}
                </div>
            `;
            
            // Add to step 5
            const step5Container = document.querySelector('#step5 .step-container');
            if (step5Container && currentStep === 5) {
                const existingDisplay = step5Container.querySelector('#user-moria-display');
                if (existingDisplay) {
                    existingDisplay.replaceWith(moriaDisplay);
                } else {
                    step5Container.appendChild(moriaDisplay);
                }
            }
            
            // Add to step 6
            const step6Container = document.querySelector('#step6 .step-container');
            if (step6Container && currentStep === 6) {
                const existingDisplay = step6Container.querySelector('#user-moria-display');
                if (existingDisplay) {
                    existingDisplay.replaceWith(moriaDisplay.cloneNode(true));
                } else {
                    step6Container.appendChild(moriaDisplay.cloneNode(true));
                }
            }
        }

        // Calculate user's moria based on entered grades
        function calculateUserMoria() {
            if (!selectedField || !systemConfig) {
                console.log('Missing data for user moria calculation:', { selectedField, systemConfigAvailable: !!systemConfig });
                return 0;
            }
            
            const fieldConfig = systemConfig.pedia[selectedField];
            if (!fieldConfig || !fieldConfig.mathimata) {
                console.log('No field configuration found for:', selectedField);
                return 0;
            }
            
            let totalWeightedScore = 0;
            let totalWeight = 0;
            
            // Calculate weighted average from main subjects based on system config
            fieldConfig.mathimata.forEach(subject => {
                const gradeInput = document.getElementById(subject.key);
                if (gradeInput && gradeInput.value && subject.required) {
                    const grade = parseFloat(gradeInput.value);
                    if (!isNaN(grade) && grade >= 0 && grade <= 20) {
                        // Weight all required subjects equally for now
                        const weight = 1;
                        totalWeightedScore += grade * weight;
                        totalWeight += weight;
                    }
                }
            });
            
            // Calculate base moria
            let baseMoria = 0;
            if (totalWeight > 0) {
                const averageGrade = totalWeightedScore / totalWeight;
                baseMoria = averageGrade * 1000; // Base calculation
            }
            
            // Add special subjects bonus
            const specialInputs = document.querySelectorAll('#special-subjects input');
            let specialBonus = 0;
            specialInputs.forEach(input => {
                if (input.value) {
                    const grade = parseFloat(input.value);
                    if (!isNaN(grade) && grade >= 0 && grade <= 20) {
                        // Special subjects add 10% of their value as bonus
                        specialBonus += grade * 100;
                    }
                }
            });
            
            const totalMoria = baseMoria + specialBonus;
            return Math.round(totalMoria);
        }

        function displayFinalResults() {
            const resultsContainer = document.getElementById('selected-schools-list');
            if (!resultsContainer) return;
            
            // Get selected schools data
            const selectedSchoolsData = selectedSchools.map(schoolId => {
                return window.schoolsData.find(school => school.id === schoolId);
            }).filter(school => school);
            
            let html = '<div class="final-results">';
            html += '<h3>Οι Επιλογές σας κατά σειρά προτεραιότητας</h3>';
            html += '<p class="drag-instruction">💡 Σύρετε τις σχολές για να αλλάξετε τη σειρά προτεραιότητας</p>';
            html += '<div class="sortable-schools" id="sortable-schools">';
            
            selectedSchoolsData.forEach((school, index) => {
                const maxMoria = school.maxMoria ? parseFloat(school.maxMoria) : null;
                const minMoria = school.minMoria ? parseFloat(school.minMoria) : null;
                const avgScore = school.avgScore ? parseFloat(school.avgScore) : null;
                
                // Format the displays
                const maxMoriaDisplay = maxMoria ? `${maxMoria.toFixed(1)}` : 'Δ/Υ';
                const minMoriaDisplay = minMoria ? `${minMoria.toFixed(1)}` : 'Δ/Υ';
                const avgScoreDisplay = avgScore ? `${avgScore.toFixed(1)}` : 'Δ/Υ';
                
                html += `
                    <div class="selected-school-item" draggable="true" data-school-id="${school.id}" data-index="${index}">
                        <div class="drag-handle"></div>
                        <div class="school-position">${index + 1}</div>
                        <div class="school-info">
                            <div class="school-name">${school.name}</div>
                            <div class="school-university">${school.university}</div>
                            <div class="school-location">${school.city || ''}</div>
                        </div>
                        <div class="school-stats">
                            <div class="stat-item">
                                <span class="stat-label">Μέγιστα:</span>
                                <span class="stat-value max">${maxMoriaDisplay}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Μέσος όρος:</span>
                                <span class="stat-value avg">${avgScoreDisplay}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Ελάχιστα:</span>
                                <span class="stat-value min">${minMoriaDisplay}</span>
                            </div>
                        </div>
                        <div class="school-actions">
                            <button class="remove-school-btn" onclick="removeSchoolFromFinal('${school.id}')">✕</button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            html += '</div>';
            
            resultsContainer.innerHTML = html;
            
            // Initialize drag and drop
            initializeDragAndDrop();
        }

        function exportToExcel() {
            if (!window.XLSX) {
                alert('Η βιβλιοθήκη Excel δεν έχει φορτωθεί. Παρακαλώ δοκιμάστε ξανά.');
                return;
            }
            
            if (selectedSchools.length === 0) {
                alert('Δεν έχετε επιλέξει σχολές για εξαγωγή.');
                return;
            }
            
            // Show loading state
            const exportButton = document.querySelector('.export-button');
            const originalText = exportButton.innerHTML;
            exportButton.innerHTML = '⏳ Δημιουργία αρχείου...';
            exportButton.disabled = true;
            
            // Use setTimeout to allow UI to update
            setTimeout(() => {
                try {
                    // Get selected schools data in order
                    const selectedSchoolsData = selectedSchools.map(schoolId => {
                        return window.schoolsData.find(school => school.id === schoolId);
                    }).filter(school => school);
                    
                    // Prepare data for Excel
                    const excelData = [];
                    
                    // Add header with student info
                    excelData.push(['ΥΠΟΛΟΓΙΣΤΗΣ ΜΟΡΙΩΝ - ΑΠΟΤΕΛΕΣΜΑΤΑ']);
                    excelData.push(['Ημερομηνία:', new Date().toLocaleDateString('el-GR')]);
                    excelData.push(['Τύπος Λυκείου:', selectedSchoolType === 'gel' ? 'ΓΕΛ' : 'ΕΠΑΛ']);
                    excelData.push(['Πεδίο/Τομέας:', getFieldDisplayName(selectedField)]);
                    excelData.push([]);
                    
                    // Add grades section
                    excelData.push(['ΒΑΘΜΟΙ ΜΑΘΗΜΑΤΩΝ']);
                    const gradeInputs = document.querySelectorAll('#grade-inputs input');
                    gradeInputs.forEach(input => {
                        if (input.value) {
                            const label = input.previousElementSibling ? input.previousElementSibling.textContent : input.name;
                            excelData.push([label.replace(/\s*\(.*?\)\s*/g, ''), parseFloat(input.value)]);
                        }
                    });
                    
                    // Add special subjects if any
                    const specialInputs = document.querySelectorAll('#special-subjects input');
                    let hasSpecialSubjects = false;
                    specialInputs.forEach(input => {
                        if (input.value) {
                            if (!hasSpecialSubjects) {
                                excelData.push([]);
                                excelData.push(['ΕΙΔΙΚΑ ΜΑΘΗΜΑΤΑ']);
                                hasSpecialSubjects = true;
                            }
                            const label = input.previousElementSibling ? input.previousElementSibling.textContent : input.name;
                            excelData.push([label.replace(/\s*\(.*?\)\s*/g, ''), parseFloat(input.value)]);
                        }
                    });
                    
                    excelData.push([]);
                    
                    // Add schools table header
                    excelData.push(['ΕΠΙΛΟΓΕΣ ΣΧΟΛΩΝ (κατά σειρά προτεραιότητας)']);
                    excelData.push(['Σειρά', 'Σχολή', 'Πανεπιστήμιο', 'Πόλη', 'Μέγιστα Μόρια', 'Μέσος Όρος', 'Ελάχιστα Μόρια']);
                    
                    // Add schools data
                    selectedSchoolsData.forEach((school, index) => {
                        const maxMoria = school.maxMoria ? parseFloat(school.maxMoria).toFixed(1) : 'Δεν υπάρχουν δεδομένα';
                        const minMoria = school.minMoria ? parseFloat(school.minMoria).toFixed(1) : 'Δεν υπάρχουν δεδομένα';
                        const avgScore = school.avgScore ? parseFloat(school.avgScore).toFixed(1) : 'Δεν υπάρχουν δεδομένα';
                        
                        excelData.push([
                            index + 1,
                            school.name,
                            school.university,
                            school.city || '',
                            maxMoria,
                            avgScore,
                            minMoria
                        ]);
                    });
                    
                    // Add summary
                    excelData.push([]);
                    excelData.push(['ΣΥΝΟΨΗ']);
                    excelData.push(['Συνολικές Επιλογές:', selectedSchools.length]);
                    
                    // Calculate averages for schools with valid data
                    const validMaxMoriaSchools = selectedSchoolsData.filter(school => school.maxMoria);
                    const validAvgScoreSchools = selectedSchoolsData.filter(school => school.avgScore);
                    const validMinMoriaSchools = selectedSchoolsData.filter(school => school.minMoria);
                    
                    if (validMaxMoriaSchools.length > 0) {
                        const avgMaxMoria = (validMaxMoriaSchools.reduce((sum, school) => sum + parseFloat(school.maxMoria), 0) / validMaxMoriaSchools.length).toFixed(1);
                        excelData.push(['Μέσος Όρος Μέγιστων Μορίων:', avgMaxMoria]);
                    }
                    
                    if (validAvgScoreSchools.length > 0) {
                        const avgOfAvgs = (validAvgScoreSchools.reduce((sum, school) => sum + parseFloat(school.avgScore), 0) / validAvgScoreSchools.length).toFixed(1);
                        excelData.push(['Μέσος Όρος Βαθμολογιών:', avgOfAvgs]);
                    }
                    
                    if (validMinMoriaSchools.length > 0) {
                        const avgMinMoria = (validMinMoriaSchools.reduce((sum, school) => sum + parseFloat(school.minMoria), 0) / validMinMoriaSchools.length).toFixed(1);
                        excelData.push(['Μέσος Όρος Ελάχιστων Μορίων:', avgMinMoria]);
                    }
                    
                    // Create workbook and worksheet
                    const workbook = XLSX.utils.book_new();
                    const worksheet = XLSX.utils.aoa_to_sheet(excelData);
                    
                    // Set column widths
                    const colWidths = [
                        {wch: 8},  // Σειρά
                        {wch: 50}, // Σχολή
                        {wch: 30}, // Πανεπιστήμιο
                        {wch: 15}, // Πόλη
                        {wch: 15}, // Μέγιστα Μόρια
                        {wch: 15}, // Μέσος Όρος
                        {wch: 15}  // Ελάχιστα Μόρια
                    ];
                    worksheet['!cols'] = colWidths;
                    
                    // Style the header rows
                    const headerStyle = {
                        font: {bold: true, sz: 14, color: {rgb: "FFFFFF"}},
                        fill: {fgColor: {rgb: "007AFF"}},
                        alignment: {horizontal: "center"}
                    };
                    
                    // Apply basic formatting
                    if (worksheet['A1']) {
                        worksheet['A1'].s = {
                            font: {bold: true, sz: 16, color: {rgb: "007AFF"}},
                            alignment: {horizontal: "center"}
                        };
                    }
                    
                    // Add worksheet to workbook
                    XLSX.utils.book_append_sheet(workbook, worksheet, "Υπολογισμός Μορίων");
                    
                    // Generate filename with timestamp
                    const timestamp = new Date().toISOString().slice(0, 16).replace(/:/g, '-');
                    const filename = `Moria_Calculator_${timestamp}.xlsx`;
                    
                    // Download the file
                    XLSX.writeFile(workbook, filename);
                    
                    // Show success message
                    setTimeout(() => {
                        alert(`✅ Το αρχείο "${filename}" κατέβηκε επιτυχώς!\n\nΠεριεχόμενο:\n• Στοιχεία μαθητή\n• Βαθμοί μαθημάτων\n• ${selectedSchools.length} επιλεγμένες σχολές\n• Υπολογισμένα μόρια για κάθε σχολή`);
                    }, 100);
                    
                } catch (error) {
                    console.error('Error exporting to Excel:', error);
                    alert('Παρουσιάστηκε σφάλμα κατά την εξαγωγή. Παρακαλώ δοκιμάστε ξανά.');
                } finally {
                    // Restore button state
                    exportButton.innerHTML = originalText;
                    exportButton.disabled = false;
                }
            }, 100);
        }
        
        function getFieldDisplayName(fieldCode) {
            // Use system configuration if available
            if (systemConfig && systemConfig.pedia && systemConfig.pedia[fieldCode]) {
                return systemConfig.pedia[fieldCode].name;
            }
            
            // Fallback field names
            const fieldNames = {
                // GEL fields
                'anthropistikes': 'Ανθρωπιστικές, Νομικές και Κοινωνικές Επιστήμες',
                'thetikes': 'Θετικές και Τεχνολογικές Επιστήμες',
                'ygeia': 'Επιστήμες Υγείας',
                'oikonomikes': 'Επιστήμες Οικονομικών και Πληροφορικής',
                // EPAL fields
                'technologika': 'Τεχνολογικά Τμήματα',
                'oikonomika': 'Οικονομικά και Διοίκηση',
                'tourismou': 'Τουρισμός',
                // Legacy field names for compatibility
                'theoretiko': 'Θεωρητικό',
                'thetiko': 'Θετικό', 
                'technologiko': 'Τεχνολογικό',
                'oikonomiko': 'Οικονομικό',
                'pliroforiki': 'Πληροφορική',
                'ygeias': 'Υγεία - Πρόνοια - Ευεξία',
                'technon': 'Εφαρμοσμένες Τέχνες',
                'georgiko': 'Γεωπονία, Τρόφιμα και Περιβάλλον'
            };
            return fieldNames[fieldCode] || fieldCode;
        }
        
        function getProbability(userMoria, schoolCutoff) {
            if (!schoolCutoff || schoolCutoff === 0) return 'Δεν υπάρχουν δεδομένα';
            
            const difference = userMoria - schoolCutoff;
            if (difference >= 500) return 'Πολύ Υψηλή';
            if (difference >= 200) return 'Υψηλή';
            if (difference >= 0) return 'Μέτρια';
            if (difference >= -200) return 'Χαμηλή';
            return 'Πολύ Χαμηλή';
        }
        
        // Drag & Drop functionality
        function initializeDragAndDrop() {
            const sortableContainer = document.getElementById('sortable-schools');
            if (!sortableContainer) return;
            
            const items = sortableContainer.querySelectorAll('.selected-school-item');
            
            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('dragenter', handleDragEnter);
                item.addEventListener('dragleave', handleDragLeave);
            });
        }
        
        let draggedItem = null;
        
        function handleDragStart(e) {
            draggedItem = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
        }
        
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        
        function handleDragEnter(e) {
            if (this !== draggedItem) {
                this.classList.add('drag-over');
            }
        }
        
        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }
        
        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (draggedItem !== this) {
                const draggedIndex = parseInt(draggedItem.dataset.index);
                const targetIndex = parseInt(this.dataset.index);
                
                // Reorder the selected schools array
                const draggedSchoolId = selectedSchools[draggedIndex];
                selectedSchools.splice(draggedIndex, 1);
                selectedSchools.splice(targetIndex, 0, draggedSchoolId);
                
                // Refresh the display
                displayFinalResults();
                showUserMoria(); // Update moria display after reordering
            }
            
            return false;
        }
        
        function handleDragEnd(e) {
            const items = document.querySelectorAll('.selected-school-item');
            items.forEach(item => {
                item.classList.remove('dragging', 'drag-over');
            });
            draggedItem = null;
        }
        
        function removeSchoolFromFinal(schoolId) {
            const index = selectedSchools.indexOf(schoolId);
            if (index > -1) {
                selectedSchools.splice(index, 1);
                displayFinalResults();
                showUserMoria(); // Update moria display after removing school
                
                // If no schools left, disable export and show message
                if (selectedSchools.length === 0) {
                    document.getElementById('selected-schools-list').innerHTML = `
                        <div class="no-schools-message">
                            <h3>Δεν έχετε επιλέξει σχολές</h3>
                            <p>Επιστρέψτε στο βήμα 5 για να επιλέξετε σχολές.</p>
                        </div>
                    `;
                }
            }
        }

        function restartCalculator() {
            // Reset all variables
            selectedSchoolType = null;
            selectedField = null;
            selectedSchools = [];
            currentStep = 1;
            
            // Hide all steps except first
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
                step.style.display = 'none';
            });
            
            // Show first step
            document.getElementById('step1').classList.add('active');
            document.getElementById('step1').style.display = 'block';
            
            // Reset step circles
            updateStepCircles(1);
            
            // Reset form inputs
            document.querySelectorAll('input').forEach(input => {
                if (input.type === 'radio') {
                    input.checked = false;
                } else {
                    input.value = '';
                }
            });
            
            // Reset buttons
            document.querySelectorAll('.nav-button.primary').forEach(btn => {
                btn.disabled = true;
            });
            
            // Reset selections
            document.querySelectorAll('.radio-option, .option-card, .school-item').forEach(item => {
                item.classList.remove('selected');
            });
        }

        // Select school type function (globally available)
        function selectSchoolType(type) {
            selectedSchoolType = type;
            
            // Update UI
            document.querySelectorAll('.radio-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            event.target.closest('.radio-option').classList.add('selected');
            document.getElementById('next-btn-1').disabled = false;
        }

    </script>

    <!-- Additional HTML sections that were part of a parallel development -->
    <div class="legacy-content" style="display: none;">
        <!-- Legacy calculator components hidden -->
                    </div>
                </div>

                <div class="navigation">
                    <button class="btn btn-secondary" onclick="goBack('page_1', 'page_2a')">
                        ← Πίσω
                    </button>
                    <button class="btn btn-primary" onclick="goToGrades('gel')" disabled id="next_field_gel">
                        Επόμενο βήμα →
                    </button>
                </div>
            </div>

            <!-- Step 2b: EPAL Field Selection -->
            <div id="page_2b" class="step hidden toright">
                <div class="step-title">
                    <span class="step-number">2</span>
                    Επιλογή Πεδίου (ΕΠΑΛ)
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 50%"></div>
                </div>

                <div class="options-grid">
                    <div class="option-card" onclick="selectField('1')">
                        <input type="radio" name="pedio_b" id="pedio_b1" value="1">
                        <div class="option-title">🔧 Πεδίο 1</div>
                        <div class="option-description">Τεχνολογία και Παραγωγή</div>
                    </div>
                    
                    <div class="option-card" onclick="selectField('2')">
                        <input type="radio" name="pedio_b" id="pedio_b2" value="2">
                        <div class="option-title">🍽️ Πεδίο 2</div>
                        <div class="option-description">Τουρισμός - Επισιτισμός</div>
                    </div>
                    
                    <div class="option-card" onclick="selectField('3')">
                        <input type="radio" name="pedio_b" id="pedio_b3" value="3">
                        <div class="option-title">⚕️ Πεδίο 3</div>
                        <div class="option-description">Υγεία - Πρόνοια - Ευεξία</div>
                    </div>
                    
                    <div class="option-card" onclick="selectField('4')">
                        <input type="radio" name="pedio_b" id="pedio_b4" value="4">
                        <div class="option-title">🎨 Πεδίο 4</div>
                        <div class="option-description">Εφαρμοσμένες Τέχνες</div>
                    </div>
                    
                    <div class="option-card" onclick="selectField('5')">
                        <input type="radio" name="pedio_b" id="pedio_b5" value="5">
                        <div class="option-title">💼 Πεδίο 5</div>
                        <div class="option-description">Διοίκηση και Οικονομία</div>
                    </div>
                    
                    <div class="option-card" onclick="selectField('6')">
                        <input type="radio" name="pedio_b" id="pedio_b6" value="6">
                        <div class="option-title">🌱 Πεδίο 6</div>
                        <div class="option-description">Γεωπονία, Τρόφιμα και Περιβάλλον</div>
                    </div>
                </div>

                <div class="navigation">
                    <button class="btn btn-secondary" onclick="goBack('page_1', 'page_2b')">
                        ← Πίσω
                    </button>
                    <button class="btn btn-primary" onclick="goToGrades('epal')" disabled id="next_field_epal">
                        Επόμενο βήμα →
                    </button>
                </div>
            </div>

            <!-- Step 3a: GEL Grades Input -->
            <div id="page_3a" class="step hidden toright">
                <div class="step-title">
                    <span class="step-number">3</span>
                    Εισαγωγή Βαθμών (ΓΕΛ)
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 75%"></div>
                </div>

                <div class="grades-section" id="gel_subjects">
                    <!-- Subjects will be populated by JavaScript -->
                </div>

                <div class="navigation">
                    <button class="btn btn-secondary" onclick="goBack('page_2a', 'page_3a')">
                        ← Πίσω
                    </button>
                    <button class="btn btn-primary" onclick="calculateResults('gel')">
                        Υπολογισμός Μορίων →
                    </button>
                </div>
            </div>

            <!-- Step 3b: EPAL Grades Input -->
            <div id="page_3b" class="step hidden toright">
                <div class="step-title">
                    <span class="step-number">3</span>
                    Εισαγωγή Βαθμών (ΕΠΑΛ)
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 75%"></div>
                </div>

                <div class="grades-section" id="epal_subjects">
                    <!-- Subjects will be populated by JavaScript -->
                </div>

                <div class="navigation">
                    <button class="btn btn-secondary" onclick="goBack('page_2b', 'page_3b')">
                        ← Πίσω
                    </button>
                    <button class="btn btn-primary" onclick="calculateResults('epal')">
                        Υπολογισμός Μορίων →
                    </button>
                </div>
            </div>

            <!-- Step 4: Results -->
            <div id="page_4" class="step hidden toright">
                <div class="step-title">
                    <span class="step-number">4</span>
                    Αποτελέσματα Υπολογισμού
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 100%"></div>
                </div>

                <div class="results-section">
                    <div class="total-score" id="total_score">0</div>
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <strong>Συνολικά Μόρια</strong>
                    </div>

                    <div class="score-details" id="score_breakdown">
                        <!-- Score breakdown will be populated by JavaScript -->
                    </div>
                </div>

                <div class="navigation">
                    <button class="btn btn-secondary" onclick="startOver()">
                        🔄 Νέος Υπολογισμός
                    </button>
                    <button class="btn btn-primary" onclick="goToSchoolSearch()">
                        🎓 Αναζήτηση Σχολών
                    </button>
                    <button class="btn btn-primary" onclick="printResults()">
                        🖨️ Εκτύπωση
                    </button>
                </div>
            </div>

            <!-- Step 5: School Search and Comparison -->
            <div id="page_5" class="step hidden toright">
                <div class="step-title">
                    <span class="step-number">5</span>
                    Αναζήτηση & Σύγκριση Σχολών
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 100%"></div>
                </div>

                <div class="search-section">
                    <div class="search-filters">
                        <div class="filter-group">
                            <label for="school-search">Αναζήτηση σχολής:</label>
                            <input type="text" id="school-search" placeholder="Πληκτρολογήστε όνομα σχολής..." oninput="searchSchools()">
                        </div>
                        
                        <div class="filter-group">
                            <label for="university-filter">Πανεπιστήμιο:</label>
                            <select id="university-filter" onchange="filterSchools()">
                                <option value="">Όλα τα Πανεπιστήμια</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="moria-range">Φίλτρο μορίων:</label>
                            <div class="range-inputs">
                                <input type="number" id="min-moria" placeholder="Ελάχιστα" oninput="filterSchools()">
                                <span>έως</span>
                                <input type="number" id="max-moria" placeholder="Μέγιστα" oninput="filterSchools()">
                            </div>
                        </div>
                    </div>

                    <div class="user-score-display">
                        <div class="score-badge">
                            <span>Τα δικά σας μόρια:</span>
                            <strong id="user-moria-display">0</strong>
                        </div>
                    </div>

                    <div class="schools-table-container">
                        <table class="schools-table" id="schools-table">
                            <thead>
                                <tr>
                                    <th>Αριθμός Σχολής</th>
                                    <th>Όνομα Σχολής</th>
                                    <th>Πανεπιστήμιο</th>
                                    <th>Μέσος Όρος</th>
                                    <th>Ελάχιστα Μόρια</th>
                                    <th>Μέγιστα Μόρια</th>
                                    <th>Πιθανότητα Εισαγωγής</th>
                                </tr>
                            </thead>
                            <tbody id="schools-tbody">
                                <!-- Schools data will be populated here -->
                            </tbody>
                        </table>
                    </div>

                    <div class="no-data-message" id="no-schools-message" style="display: none;">
                        <p>Δεν βρέθηκαν σχολές που να ταιριάζουν στα κριτήρια αναζήτησης.</p>
                        <p>Παρακαλώ επικοινωνήστε με τον διαχειριστή για να ενημερώσει τη βάση δεδομένων.</p>
                    </div>
                </div>

                <div class="navigation">
                    <button class="btn btn-secondary" onclick="goBackToResults()">
                        ← Πίσω στα Αποτελέσματα
                    </button>
                    <button class="btn btn-primary" onclick="exportResults()">
                        📊 Κατέβασμα ως Excel (.xlsx)
                    </button>
                </div>
                <div style="text-align: center; margin-top: 10px;">
                    <p style="color: #666; font-size: 12px;">
                        Κατεβάστε τα αποτελέσματα σε μορφή Excel για περαιτέρω ανάλυση
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Additional Global variables for new calculator system
        // selectedSchoolType already declared above
        // selectedField already declared above
        let subjects = {};
        
        // Subject definitions
        const subjectData = {
            gel: {
                1: { // Πεδίο 1
                    required: [
                        { name: 'Νέα Ελληνικά', coefficient: 0.3, id: 'nea_ellinika' },
                        { name: 'Ιστορία', coefficient: 0.3, id: 'istoria' },
                        { name: 'Αρχαία Ελληνικά', coefficient: 0.2, id: 'archaia' }
                    ],
                    special: [
                        { name: 'Λατινικά', coefficient: 0.2, id: 'latina' },
                        { name: 'Κοινωνιολογία', coefficient: 0.2, id: 'koinoniologia' }
                    ]
                },
                2: { // Πεδίο 2
                    required: [
                        { name: 'Μαθηματικά', coefficient: 0.3, id: 'mathimatika' },
                        { name: 'Φυσική', coefficient: 0.3, id: 'fysiki' },
                        { name: 'Χημεία', coefficient: 0.2, id: 'chimeia' }
                    ],
                    special: [
                        { name: 'Βιολογία', coefficient: 0.2, id: 'biologia' },
                        { name: 'Πληροφορική', coefficient: 0.2, id: 'pliroforiki' }
                    ]
                },
                3: { // Πεδίο 3
                    required: [
                        { name: 'Βιολογία', coefficient: 0.3, id: 'biologia' },
                        { name: 'Χημεία', coefficient: 0.3, id: 'chimeia' },
                        { name: 'Φυσική', coefficient: 0.2, id: 'fysiki' }
                    ],
                    special: [
                        { name: 'Μαθηματικά', coefficient: 0.2, id: 'mathimatika' }
                    ]
                },
                4: { // Πεδίο 4
                    required: [
                        { name: 'Μαθηματικά', coefficient: 0.3, id: 'mathimatika' },
                        { name: 'Οικονομία', coefficient: 0.2, id: 'oikonomia' },
                        { name: 'Πληροφορική', coefficient: 0.2, id: 'pliroforiki' }
                    ],
                    special: [
                        { name: 'Στατιστική', coefficient: 0.3, id: 'statistiki' }
                    ]
                }
            },
            epal: {
                1: { // Τεχνολογία και Παραγωγή
                    required: [
                        { name: 'Μαθηματικά', coefficient: 0.3, id: 'mathimatika' },
                        { name: 'Φυσική', coefficient: 0.2, id: 'fysiki' }
                    ],
                    special: [
                        { name: 'Ειδικό Μάθημα 1', coefficient: 0.3, id: 'eidiko1' },
                        { name: 'Ειδικό Μάθημα 2', coefficient: 0.2, id: 'eidiko2' }
                    ]
                },
                2: { // Τουρισμός - Επισιτισμός
                    required: [
                        { name: 'Νέα Ελληνικά', coefficient: 0.3, id: 'nea_ellinika' },
                        { name: 'Ιστορία', coefficient: 0.2, id: 'istoria' }
                    ],
                    special: [
                        { name: 'Ειδικό Μάθημα 1', coefficient: 0.3, id: 'eidiko1' },
                        { name: 'Ειδικό Μάθημα 2', coefficient: 0.2, id: 'eidiko2' }
                    ]
                },
                3: { // Υγεία - Πρόνοια - Ευεξία
                    required: [
                        { name: 'Βιολογία', coefficient: 0.3, id: 'biologia' },
                        { name: 'Χημεία', coefficient: 0.2, id: 'chimeia' }
                    ],
                    special: [
                        { name: 'Ειδικό Μάθημα 1', coefficient: 0.3, id: 'eidiko1' },
                        { name: 'Ειδικό Μάθημα 2', coefficient: 0.2, id: 'eidiko2' }
                    ]
                },
                4: { // Εφαρμοσμένες Τέχνες
                    required: [
                        { name: 'Ιστορία Τέχνης', coefficient: 0.3, id: 'istoria_technis' }
                    ],
                    special: [
                        { name: 'Ειδικό Μάθημα 1', coefficient: 0.4, id: 'eidiko1' },
                        { name: 'Ειδικό Μάθημα 2', coefficient: 0.3, id: 'eidiko2' }
                    ]
                },
                5: { // Διοίκηση και Οικονομία
                    required: [
                        { name: 'Μαθηματικά', coefficient: 0.3, id: 'mathimatika' },
                        { name: 'Οικονομία', coefficient: 0.2, id: 'oikonomia' }
                    ],
                    special: [
                        { name: 'Ειδικό Μάθημα 1', coefficient: 0.3, id: 'eidiko1' },
                        { name: 'Ειδικό Μάθημα 2', coefficient: 0.2, id: 'eidiko2' }
                    ]
                },
                6: { // Γεωπονία, Τρόφιμα και Περιβάλλον
                    required: [
                        { name: 'Βιολογία', coefficient: 0.3, id: 'biologia' },
                        { name: 'Χημεία', coefficient: 0.2, id: 'chimeia' }
                    ],
                    special: [
                        { name: 'Ειδικό Μάθημα 1', coefficient: 0.3, id: 'eidiko1' },
                        { name: 'Ειδικό Μάθημα 2', coefficient: 0.2, id: 'eidiko2' }
                    ]
                }
            }
        };

        // Go to field selection
        function goToFieldSelection() {
            document.getElementById('page_1').classList.add('toleft');
            
            if (selectedSchoolType === 'gel') {
                document.getElementById('page_2a').classList.remove('toright', 'hidden');
            } else {
                document.getElementById('page_2b').classList.remove('toright', 'hidden');
            }
        }

        // Select field


        // Go to grades input
        function goToGrades(schoolType) {
            if (schoolType === 'gel') {
                document.getElementById('page_2a').classList.add('toleft');
                document.getElementById('page_3a').classList.remove('toright', 'hidden');
                populateSubjects('gel');
            } else {
                document.getElementById('page_2b').classList.add('toleft');
                document.getElementById('page_3b').classList.remove('toright', 'hidden');
                populateSubjects('epal');
            }
        }

        // Populate subjects for grade input
        function populateSubjects(schoolType) {
            const container = document.getElementById(schoolType + '_subjects');
            const fieldData = subjectData[schoolType][selectedField];
            
            let html = '';
            
            // Required subjects
            html += '<h3 style="color: #667eea; margin-bottom: 1rem;">📚 Υποχρεωτικά Μαθήματα</h3>';
            fieldData.required.forEach(subject => {
                html += `
                    <div class="subject-input">
                        <div class="subject-label">${subject.name}</div>
                        <input type="number" class="grade-input" id="${subject.id}" 
                               min="0" max="20" step="0.1" placeholder="0-20">
                        <div class="coefficient">×${subject.coefficient}</div>
                    </div>
                `;
            });
            
            // Special subjects
            html += '<h3 style="color: #667eea; margin: 2rem 0 1rem 0;">⭐ Ειδικά Μαθήματα</h3>';
            fieldData.special.forEach(subject => {
                html += `
                    <div class="subject-input">
                        <div class="subject-label">${subject.name}</div>
                        <input type="number" class="grade-input" id="${subject.id}" 
                               min="0" max="20" step="0.1" placeholder="0-20">
                        <div class="coefficient">×${subject.coefficient}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Calculate results
        function calculateResults(schoolType) {
            const fieldData = subjectData[schoolType][selectedField];
            let totalScore = 0;
            let breakdown = [];
            
            // Calculate required subjects
            fieldData.required.forEach(subject => {
                const grade = parseFloat(document.getElementById(subject.id).value) || 0;
                const score = grade * subject.coefficient * 1000;
                totalScore += score;
                breakdown.push({
                    name: subject.name,
                    grade: grade,
                    coefficient: subject.coefficient,
                    score: score
                });
            });
            
            // Calculate special subjects
            fieldData.special.forEach(subject => {
                const grade = parseFloat(document.getElementById(subject.id).value) || 0;
                const score = grade * subject.coefficient * 1000;
                totalScore += score;
                breakdown.push({
                    name: subject.name,
                    grade: grade,
                    coefficient: subject.coefficient,
                    score: score
                });
            });
            
            showResults(totalScore, breakdown);
        }

        // Show results
        function showResults(totalScore, breakdown) {
            document.getElementById(selectedSchoolType === 'gel' ? 'page_3a' : 'page_3b').classList.add('toleft');
            document.getElementById('page_4').classList.remove('toright', 'hidden');
            
            // Store user moria globally
            userMoria = Math.round(totalScore);
            
            // Update total score
            document.getElementById('total_score').textContent = userMoria;
            
            // Update breakdown
            const container = document.getElementById('score_breakdown');
            let html = '';
            
            breakdown.forEach(item => {
                html += `
                    <div class="score-item">
                        <div class="score-value">${Math.round(item.score)}</div>
                        <div class="score-label">${item.name}</div>
                        <div class="score-label">${item.grade} × ${item.coefficient}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Go back function
        function goBack(fromPage, toPage) {
            document.getElementById(toPage).classList.add('toright');
            document.getElementById(fromPage).classList.remove('toleft');
        }

        // Start over
        function startOver() {
            // Reset all pages
            document.querySelectorAll('.step').forEach(step => {
                step.classList.add('hidden');
                step.classList.remove('toleft', 'toright');
            });
            
            // Show first page
            document.getElementById('page_1').classList.remove('hidden');
            
            // Reset selections
            selectedSchoolType = '';
            selectedField = 0;
            
            // Reset buttons
            document.getElementById('next_school').disabled = true;
            document.getElementById('next_field_gel').disabled = true;
            document.getElementById('next_field_epal').disabled = true;
            
            // Clear form
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.checked = false;
            });
            document.querySelectorAll('.option-card').forEach(card => {
                card.classList.remove('selected');
            });
        }

        // Print results
        function printResults() {
            window.print();
        }

        // Step 5 functions - School Search and Comparison
        // Variables already declared at the top: schoolsData, userMoria, filteredSchools

        // Go to school search step
        function goToSchoolSearch() {
            console.log('goToSchoolSearch called');
            document.getElementById('page_4').classList.add('toleft');
            document.getElementById('page_5').classList.remove('toright', 'hidden');
            
            // Store user moria
            const totalScoreElement = document.getElementById('total_score');
            if (totalScoreElement) {
                userMoria = parseInt(totalScoreElement.textContent) || 0;
                console.log('User moria set to:', userMoria);
                document.getElementById('user-moria-display').textContent = userMoria.toLocaleString();
            } else {
                console.error('total_score element not found');
                userMoria = 15000; // fallback value for testing
                document.getElementById('user-moria-display').textContent = userMoria.toLocaleString();
            }
            
            // Filter and display schools using already loaded data
            if (schoolsData && schoolsData.length > 0) {
                console.log('Using already loaded schools data:', schoolsData.length, 'schools');
                filterAndDisplaySchools();
            } else {
                console.warn('No schools data available - the admin needs to upload school data first');
                document.getElementById('schools-list').innerHTML = `
                    <div class="no-data-message">
                        <h3>Δεν υπάρχουν διαθέσιμα δεδομένα σχολών</h3>
                        <p>Ο διαχειριστής πρέπει να ανεβάσει πρώτα τα δεδομένα των σχολών από το admin panel.</p>
                    </div>
                `;
            }
        }

        // Go back to results
        function goBackToResults() {
            document.getElementById('page_5').classList.add('toright');
            document.getElementById('page_4').classList.remove('toleft');
        }

        // Filter and display schools using already loaded data
        function filterAndDisplaySchools() {
            console.log('filterAndDisplaySchools called');
            
            // Filter schools based on user criteria
            filterSchools();
            
            // Display filtered results
            displayResults();
            
            // Show Excel export option if we have results
            const exportSection = document.getElementById('excel-export-section');
            if (exportSection) {
                exportSection.style.display = filteredSchools.length > 0 ? 'block' : 'none';
            }
        }

        // Load schools data from JSON files
        async function loadSchoolsData() {
            // Update status message
            updateDataStatus('🔄 Φόρτωση δεδομένων...', 'loading');
            
            try {
                console.log('=== Loading schools data ===');
                
                // Load from JSON files (both GEL and EPAL)
                try {
                    console.log('Loading schools data from JSON files...');
                    
                    // Load GEL schools
                    let gelSchools = [];
                    try {
                        console.log('Loading GEL schools from ./data/schools-data.json...');
                        const gelResponse = await fetch('./data/schools-data.json?v=' + Date.now());
                        if (gelResponse.ok) {
                            const gelData = await gelResponse.json();
                            if (gelData && Array.isArray(gelData) && gelData.length > 0) {
                                gelSchools = gelData.filter(school => school.id !== "ΚΩΔΙΚΟΣ ΣΧΟΛΗΣ"); // Remove header row
                                console.log('📄 Loaded GEL schools:', gelSchools.length);
                            }
                        }
                    } catch (gelError) {
                        console.log('GEL schools file error:', gelError.message);
                    }
                    
                    // Load EPAL schools
                    let epalSchools = [];
                    try {
                        console.log('Loading EPAL schools from ./data/epal-scholes.json...');
                        const epalResponse = await fetch('./data/epal-scholes.json?v=' + Date.now());
                        if (epalResponse.ok) {
                            const epalData = await epalResponse.json();
                            if (epalData && epalData.scholes && Array.isArray(epalData.scholes)) {
                                // Normalize EPAL data structure to match GEL structure
                                const fieldMapping = {
                                    '1': 'technologiko',
                                    '2': 'tourismou',  
                                    '3': 'ygeias',
                                    '4': 'technon',
                                    '5': 'oikonomiko',
                                    '6': 'georgiko'
                                };
                                
                                epalSchools = epalData.scholes.map((school, index) => {
                                    // Determine field based on school name/subjects
                                    let field = 'technologiko'; // default
                                    if (school.name.includes('Τουρισμός') || school.name.includes('Επισιτισμός')) {
                                        field = 'tourismou';
                                    } else if (school.name.includes('Υγεία') || school.name.includes('Πρόνοια')) {
                                        field = 'ygeias';
                                    } else if (school.name.includes('Τέχνες') || school.name.includes('Καλλιτεχνικ')) {
                                        field = 'technon';
                                    } else if (school.name.includes('Διοίκηση') || school.name.includes('Οικονομ')) {
                                        field = 'oikonomiko';
                                    } else if (school.name.includes('Γεωπον') || school.name.includes('Περιβάλλον')) {
                                        field = 'georgiko';
                                    }
                                    
                                    return {
                                        id: `EPAL_${index + 1}`,
                                        university: 'ΕΠΑΛ',
                                        name: school.name,
                                        positionType: 'ΕΠΑΛ ΓΕΝΙΚΗ ΣΕΙΡΑ',
                                        scientificField: field,
                                        maxMoria: school.vasi + 2000,
                                        minMoria: school.vasi - 1000,
                                        schoolType: 'epal',
                                        field: field,
                                        avgScore: 15,
                                        city: 'Αθήνα',
                                        subjects: school.mathimata || [],
                                        coefficients: school.syntelesties || [],
                                        specialSubjects: school.eidika || []
                                    };
                                });
                                console.log('📄 Loaded and normalized EPAL schools:', epalSchools.length);
                            }
                        }
                    } catch (epalError) {
                        console.log('EPAL schools file error:', epalError.message);
                    }
                    
                    // Combine both datasets if we don't have data yet
                    if (!schoolsData || schoolsData.length === 0) {
                        schoolsData = [...gelSchools, ...epalSchools];
                        window.schoolsData = schoolsData; // Make available globally
                        console.log('📄 Combined schools data:', schoolsData.length, `(${gelSchools.length} GEL + ${epalSchools.length} EPAL)`);
                        
                        if (schoolsData.length > 0) {
                            console.log('Sample GEL school:', gelSchools[0]);
                            console.log('Sample EPAL school:', epalSchools[0]);
                            
                            // Validate field mapping
                            const fieldsFound = [...new Set(schoolsData.map(s => s.field))];
                            console.log('Field codes found:', fieldsFound);
                        }
                    }
                } catch (jsonError) {
                    console.log('JSON files loading error:', jsonError.message);
                }
                
                // FINAL OVERRIDE: try to load from localStorage (admin uploaded data) - HIGHEST PRIORITY
                try {
                    console.log('3. Checking localStorage for admin data (HIGHEST PRIORITY)...');
                    const savedData = localStorage.getItem('schoolsCSVData');
                    if (savedData) {
                        const localData = JSON.parse(savedData);
                        if (localData && Array.isArray(localData) && localData.length > 0) {
                            schoolsData = localData; // OVERRIDE any previous data
                        window.schoolsData = schoolsData; // Make available globally
                            console.log('🎯 OVERRIDING with localStorage admin data:', schoolsData.length, 'schools');
                            console.log('Admin data sample:', schoolsData[0]);
                            
                            // Validate field mapping
                            const fieldsFound = [...new Set(schoolsData.map(s => s.field))];
                            console.log('Admin data field codes:', fieldsFound);
                        } else {
                            console.log('localStorage data exists but is invalid');
                        }
                    } else {
                        console.log('No admin data in localStorage - using fallback data');
                    }
                } catch (localError) {
                    console.log('localStorage error:', localError.message);
                }

                // Final check: do we have any data?
                if (schoolsData && schoolsData.length > 0) {
                    console.log('✅ Final data loaded:', schoolsData.length, 'schools');
                    
                    // Make data available globally
                    window.schoolsData = schoolsData;
                    
                    // Update success message
                    const gelCount = schoolsData.filter(s => s.schoolType === 'gel').length;
                    const epalCount = schoolsData.filter(s => s.schoolType === 'epal').length;
                    updateDataStatus(`✅ Φορτώθηκαν ${schoolsData.length} σχολές (${gelCount} ΓΕΛ, ${epalCount} ΕΠΑΛ) από τη βάση δεδομένων`, 'success');
                    
                    populateUniversityFilter();
                    displaySchools(schoolsData);
                } else {
                    // No data available from any source
                    console.log('4. No data sources available - admin must upload data');
                    schoolsData = generateSampleData(); // Returns empty array
                    window.schoolsData = schoolsData; // Make empty data available globally
                    console.log('⚠️ No schools data available:', schoolsData.length, 'schools');
                    
                    // Update error message
                    updateDataStatus('⚠️ Δεν υπάρχουν δεδομένα σχολών. Ο διαχειριστής πρέπει να ανεβάσει δεδομένα μέσω του admin panel.', 'error');
                    
                    // Don't try to populate or display if there's no data
                    if (schoolsData.length === 0) {
                        console.warn('No data to display - waiting for admin upload');
                    } else {
                        populateUniversityFilter();
                        displaySchools(schoolsData);
                    }
                }
                
            } catch (error) {
                console.error('❌ Critical error loading schools data:', error);
                schoolsData = generateSampleData(); // Returns empty array
                console.log('⚠️ Emergency fallback - no data available:', schoolsData.length, 'schools');
                
                // Update error message
                updateDataStatus('❌ Σφάλμα φόρτωσης δεδομένων: ' + error.message, 'error');
                
                // Don't try to populate or display if there's no data
                if (schoolsData.length === 0) {
                    console.warn('No data to display - waiting for admin upload');
                } else {
                    populateUniversityFilter();
                    displaySchools(schoolsData);
                }
            }
        }

        // Generate sample data (fallback) - Return empty array to force admin data upload
        function generateSampleData() {
            console.warn('⚠️ No admin data found - generateSampleData called');
            console.warn('The administrator must upload school data via the admin panel first');
            return []; // Return empty array instead of fake data
        }

        // Populate university filter dropdown
        function populateUniversityFilter() {
            const universityFilter = document.getElementById('university-filter');
            const universities = [...new Set(schoolsData.map(school => school.university))];
            
            universityFilter.innerHTML = '<option value="">Όλα τα Πανεπιστήμια</option>';
            universities.forEach(university => {
                universityFilter.innerHTML += `<option value="${university}">${university}</option>`;
            });
        }

        // Display schools in table
        function displaySchools(schools) {
            console.log('displaySchools called with:', schools.length, 'schools');
            console.log('User moria:', userMoria);
            
            const tbody = document.getElementById('schools-tbody');
            const noDataMessage = document.getElementById('no-schools-message');
            
            if (!tbody) {
                console.error('schools-tbody element not found');
                return;
            }
            
            if (!noDataMessage) {
                console.error('no-schools-message element not found');
                return;
            }
            
            if (!schools || schools.length === 0) {
                console.log('No schools data, showing no-data message');
                tbody.innerHTML = '';
                noDataMessage.style.display = 'block';
                return;
            }
            
            console.log('Displaying', schools.length, 'schools');
            noDataMessage.style.display = 'none';
            
            tbody.innerHTML = schools.map(school => {
                const probability = calculateProbability(school);
                const probabilityClass = getProbabilityClass(probability);
                
                return `
                    <tr>
                        <td class="score">${school.id}</td>
                        <td class="school-name">${school.name}</td>
                        <td class="university">${school.university}</td>
                        <td class="score">${school.avgScore}</td>
                        <td class="score">${school.minMoria.toLocaleString()}</td>
                        <td class="score">${school.maxMoria.toLocaleString()}</td>
                        <td>
                            <span class="probability-badge ${probabilityClass}">
                                ${probability}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
            
            console.log('Table updated with HTML content');
        }

        // Calculate admission probability
        // Get probability CSS class
        function getProbabilityClass(probability) {
            switch (probability) {
                case 'Πολύ Υψηλή':
                case 'Υψηλή':
                    return 'probability-high';
                case 'Μέτρια':
                    return 'probability-medium';
                case 'Χαμηλή':
                case 'Πολύ Χαμηλή':
                default:
                    return 'probability-low';
            }
        }

        // Search schools by name
        function searchSchools() {
            if (!selectedField) return;
            
            const searchTerm = document.getElementById('school-search').value.toLowerCase();
            const universityFilter = document.getElementById('university-filter').value;
            const minMoria = parseInt(document.getElementById('min-moria').value) || 0;
            const maxMoria = parseInt(document.getElementById('max-moria').value) || 999999;
            
            // Get schools for the selected field
            const availableSchools = schoolsData[selectedField] || [];
            
            filteredSchools = availableSchools.filter(school => {
                const matchesSearch = school.name.toLowerCase().includes(searchTerm);
                const matchesUniversity = !universityFilter || school.university === universityFilter;
                const matchesMoriaRange = school.minMoria >= minMoria && school.maxMoria <= maxMoria;
                
                return matchesSearch && matchesUniversity && matchesMoriaRange;
            });
            
            // Sort by admission probability
            filteredSchools.sort((a, b) => {
                const probA = calculateProbabilityScore(a);
                const probB = calculateProbabilityScore(b);
                return probB - probA; // Descending order (best matches first)
            });
            
            displaySchools(filteredSchools);
        }

        // Calculate numeric probability score for sorting
        function calculateProbabilityScore(school) {
            if (userMoria >= school.maxMoria) return 5;
            if (userMoria >= school.minMoria + (school.maxMoria - school.minMoria) * 0.7) return 4;
            if (userMoria >= school.minMoria + (school.maxMoria - school.minMoria) * 0.3) return 3;
            if (userMoria >= school.minMoria) return 2;
            return 1;
        }

        // Export results to CSV
        function exportResults() {
            try {
                console.log('Έναρξη Excel export...');
                
                if (!window.XLSX) {
                    alert('Η βιβλιοθήκη XLSX δεν έχει φορτωθεί. Παρακαλώ ανανεώστε τη σελίδα και δοκιμάστε ξανά.');
                    return;
                }

                // Δημιουργία δεδομένων για Excel
                const excelData = [];
                
                // Header
                excelData.push([
                    'Αριθμός Σχολής',
                    'Όνομα Σχολής', 
                    'Πανεπιστήμιο',
                    'Μέσος Όρος',
                    'Ελάχιστα Μόρια',
                    'Μέγιστα Μόρια',
                    'Πιθανότητα Εισαγωγής (%)',
                    'Τα δικά σας μόρια',
                    'Διαφορά από Ελάχιστα',
                    'Διαφορά από Μέσο Όρο'
                ]);

                // Δεδομένα σχολών
                filteredSchools.forEach(school => {
                    const probability = calculateProbability(school);
                    const diffFromMin = userMoria - school.minMoria;
                    const diffFromAvg = userMoria - school.avgScore;
                    
                    excelData.push([
                        school.id,
                        school.name,
                        school.university,
                        school.avgScore,
                        school.minMoria,
                        school.maxMoria,
                        probability,
                        userMoria,
                        diffFromMin,
                        diffFromAvg
                    ]);
                });

                // Προσθήκη κενής γραμμής και στατιστικών
                excelData.push([]);
                excelData.push(['ΣΤΑΤΙΣΤΙΚΑ']);
                excelData.push([]);
                excelData.push(['Συνολικές Σχολές:', filteredSchools.length]);
                excelData.push(['Τα Μόρια σας:', userMoria]);
                excelData.push(['Ημερομηνία Εξαγωγής:', new Date().toLocaleDateString('el-GR')]);

                // Δημιουργία workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(excelData);

                // Formatting του worksheet
                const range = XLSX.utils.decode_range(ws['!ref']);
                
                // Styling για headers
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const address = XLSX.utils.encode_cell({ r: 0, c: C });
                    if (!ws[address]) continue;
                    ws[address].s = {
                        font: { bold: true },
                        fill: { fgColor: { rgb: "5b3c2a" } },
                        alignment: { horizontal: "center" }
                    };
                }

                // Προσθήκη του worksheet στο workbook
                XLSX.utils.book_append_sheet(wb, ws, "Αποτελέσματα Μορίων");

                // Δημιουργία filename με timestamp
                const now = new Date();
                const timestamp = now.toISOString().slice(0, 19).replace(/[:-]/g, '');
                const filename = `Αποτελεσματα_Υπολογιστη_Μοριων_${timestamp}.xlsx`;

                console.log('Δημιουργία Excel αρχείου:', filename);

                // Export του αρχείου
                XLSX.writeFile(wb, filename);

                console.log('Excel export ολοκληρώθηκε επιτυχώς');

            } catch (error) {
                console.error('Σφάλμα κατά το Excel export:', error);
                alert('Σφάλμα κατά το export. Παρακαλώ δοκιμάστε ξανά.');
            }
        }

        // Add input validation
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('grade-input')) {
                let value = parseFloat(e.target.value);
                if (value < 0) e.target.value = 0;
                if (value > 20) e.target.value = 20;
            }
        });

        // Function to update data status message
        function updateDataStatus(message, type = 'info') {
            const statusElement = document.getElementById('data-status');
            const textElement = document.getElementById('data-status-text');
            
            if (statusElement && textElement) {
                textElement.textContent = message;
                
                // Update styling based on type
                statusElement.className = ''; // Reset classes
                switch (type) {
                    case 'success':
                        statusElement.style.background = '#e8f5e8';
                        statusElement.style.borderLeftColor = '#4caf50';
                        break;
                    case 'error':
                        statusElement.style.background = '#ffeaea';
                        statusElement.style.borderLeftColor = '#f44336';
                        break;
                    case 'loading':
                        statusElement.style.background = '#e3f2fd';
                        statusElement.style.borderLeftColor = '#2196f3';
                        break;
                    default:
                        statusElement.style.background = '#f5f5f5';
                        statusElement.style.borderLeftColor = '#ccc';
                }
            }
        }
    </script>
</body>
</html>
