<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Μαθητικό Στέκι</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;400&display=swap" rel="stylesheet">
  <style>
    .info-item {
      padding: 10px;
      color: #ffffffc2;
      border-radius: 5px;
    }
    
    .info-item strong {
      color: #f4f4f4;
      display: block;
      margin-bottom: 5px;
    }
    
    .subject-card {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .subject-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .login-form {
      max-width: 400px;
      margin: 0 auto;
    }
    
    .login-form input {
      width: 100%;
      margin-bottom: 10px;
    }
    
    .logout-btn:hover {
      background: rgba(255,255,255,0.3) !important;
    }
    
    @media (max-width: 768px) {
      .profile-grid {
        grid-template-columns: 1fr !important;
      }
      
      .logout-btn {
        position: static !important;
        margin-top: 15px;
      }
      
      .student-header {
        text-align: center !important;
      }
    }
    
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .card {
      position: relative;
      overflow: hidden;
      border-radius: 10px;
      color: white;
      text-decoration: none;
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      padding: 20px;
      background-size: cover;
      background-position: center;
    }
    
    .card-overlay {
      position: relative;
      z-index: 1;
    }
    
    .card img {
      max-width: 100%;
      height: auto;
      margin-bottom: 10px;
    }
    
    .card h2 {
      font-size: 1.5em;
      margin: 0;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
    }
    
    .card:hover {
      transform: translateY(-5px);
    }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <div class="logo"><img src="logo.png" alt="logo"></div>
      <nav>
        <a href="#">Αρχική Σελίδα</a>
        <a href="#">Καρτέλα Μαθητή</a>
        <a href="#">Προγράμματα</a>
        <a href="#">Πανελλαδικές Εξετάσεις</a>
        <a href="#">Φωτογραφίες</a>
        <a href="#">Σχετικά με εμάς</a>
      </nav>
      <div class="icons">
        <a href="#"><img src="\elements\Group 17.svg" alt="fb" class="facebook-icon"></a>
        <a href="#"><img src="\elements\mdi_instagram.svg" alt="insta" class="instagram-icon"></a>
        <a href="#"><img src="\elements\phone.svg" alt="phone"></a>
        <a href="#"><img src="\elements\mail.svg" alt="mail"></a>
      </div>
      <a href="index.html" class="login-btn" style="text-decoration: none;">Έξοδος</a>
    </div>
  </header>
  
  <main>
    <div class="container" style="max-width: 1200px; margin: 0 auto; padding: 20px;">
      <div class="student-header" style="color: white; padding: 20px; border-radius: 10px; margin-bottom: 30px; text-align: center; position: relative;">
        <h1>Καρτέλα Μαθητή</h1>
        <p>Εδώ μπορείς να δεις τα στοιχεία σου και τα μαθήματά σου</p>
        <button id="logout-btn" onclick="studentLogout()" style="position: absolute; top: 20px; right: 20px; padding: 8px 15px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 5px; cursor: pointer; display: none;">
          Αποσύνδεση
        </button>
      </div>
       <div id="student-info" >
        <div class="profile-section" style=" margin-top: -55px; background: rgb(239, 123, 52); padding: 10px; border-radius: 20px; box-shadow: 0 2px 10px  rgba(0, 0, 0, 0.667); margin-bottom: 20px; border: 2px solid rgb(232, 93, 6);">
          <div class="profile-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            <div class="info-item">
              <strong>Username:</strong> <span id="student-username"></span>
            </div>
            <div class="info-item">
              <strong>Όνομα:</strong> <span id="student-firstname"></span>
            </div>
            <div class="info-item">
              <strong>Επώνυμο:</strong> <span id="student-lastname"></span>
            </div>
            <div class="info-item">
              <strong>Email:</strong> <span id="student-email"></span>
            </div>
            <div class="info-item">
              <strong>Τηλέφωνο:</strong> <span id="student-phone"></span>
            </div>
            <div class="info-item">
              <strong>Τάξη:</strong> <span id="student-class"></span>
            </div>
          </div>
        </div>
        
        <div class="subjects-section" style="background: white; padding: 20px; border-radius: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
          <h2 style="color: #5f3d2c; margin-bottom: 20px;">Τα Μαθήματά Μου</h2>
          <div id="student-subjects">
            <!-- Τα μαθήματα θα φορτωθούν εδώ -->
          </div>
        </div>
      </div>
      

    </div>


    <div class="student-tools-section">
      <h2 style="color: #5f3d2c; text-align: center; margin: 40px 0 30px 0;">Εργαλεία Μαθητή</h2>
      <div class="cards-grid">
        <a href="grades.html" class="card" style="background-image: url('elements/grades-bg.jpg');">
          <div class="card-overlay">
            <img src="elements/grades-icon.png" alt="Βαθμολογίες">
            <h2>Βαθμολογίες Μαθητή</h2>
          </div>
        </a>
        <a href="calendar.html" class="card" style="background-image: url('elements/calendar-bg.jpg');">
          <div class="card-overlay">
            <img src="elements/calendar-icon.png" alt="Ημερολόγιο">
            <h2>Ημερολόγιο</h2>
          </div>
        </a>
        <a href="progress.html" class="card" style="background-image: url('elements/progress-bg.jpg');">
          <div class="card-overlay">
            <img src="elements/progress-icon.png" alt="Πρόοδος Μαθητή">
            <h2>Πρόοδος Μαθητή</h2>
          </div>
        </a>
      </div>
    </div>

  </main>
  <footer>
    <div class="footer-content">
      <div class="footer-logo">Μαθητικό Στέκι</div>
      <div class="footer-links">
        <span>Καθηγητές:</span>
        <span>...</span>
      </div>
      <div class="footer-map">
        <img src="map.png" alt="Χάρτης">
      </div>
    </div>
    <div class="footer-bottom">
      &copy; 2025 Μαθητικό Στέκι
    </div>
  </footer>
    <script>
  // Global variables
  let currentStudent = null;
  
  // Check if student is already logged in (check localStorage)
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Student tablet loading...');
    console.log('Checking localStorage for logged in student...');
    
    // Ελέγχουμε αν υπάρχει συνδεδεμένος μαθητής
    const loggedInStudent = getLoggedInStudent();
    
    if (loggedInStudent && loggedInStudent.username) {
      console.log('Found logged in student:', loggedInStudent.username);
      // Αυτόματη φόρτωση των στοιχείων του συνδεδεμένου μαθητή
      loadStudentProfile(loggedInStudent.username);
    } else {
      console.log('No logged in student found');
      console.log('Current localStorage state:', localStorage.getItem('loggedInStudent'));
      // Αν δεν υπάρχει συνδεδεμένος μαθητής, ανακατεύθυνση στη σελίδα login
      showLoginRequired();
    }
  });
  
  // Function to get logged in student from localStorage
  function getLoggedInStudent() {
    try {
      const loggedInData = localStorage.getItem('loggedInStudent');
      console.log('Raw localStorage data:', loggedInData);
      
      if (loggedInData) {
        const student = JSON.parse(loggedInData);
        console.log('Parsed student data:', student);
        
        // Έλεγχος αν υπάρχει username (βασικό κριτήριο)
        if (student.username) {
          // Έλεγχος χρόνου login (αν υπάρχει)
          if (student.loginTime) {
            const loginTime = new Date(student.loginTime);
            const now = new Date();
            const hoursDiff = (now - loginTime) / (1000 * 60 * 60);
            console.log('Hours since login:', hoursDiff);
            
            // Αν έχουν περάσει πάνω από 24 ώρες, σβήνουμε τα δεδομένα
            if (hoursDiff > 24) {
              console.log('Login expired, clearing localStorage');
              localStorage.removeItem('loggedInStudent');
              return null;
            }
          }
          
          // Έλεγχος ρόλου (αν υπάρχει)
          if (student.role && student.role !== 'student') {
            console.log('Wrong role:', student.role);
            return null;
          }
          
          console.log('Valid student found:', student.username);
          return student;
        }
      }
    } catch (e) {
      console.error('Error parsing logged in student:', e);
      localStorage.removeItem('loggedInStudent'); // Καθαρίζουμε corrupted data
    }

    console.log('No valid student found');
    return null;
  }
  
  // Function to show login required message
  function showLoginRequired() {
    document.getElementById('login-prompt').innerHTML = `
      <div style="text-align: center; padding: 40px; background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; border-radius: 10px;">
        <h3>Απαιτείται Σύνδεση</h3>
        <p>Πρέπει να συνδεθείτε για να δείτε τα στοιχεία σας.</p>
        <button onclick="window.location.href='/index2.html'" style="padding: 10px 20px; background: #2C5F4F; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">
          Μετάβαση στη Σύνδεση
        </button>
      </div>
    `;
    document.getElementById('login-prompt').style.display = 'block';
  }
  
  // Function to get current student username from various sources
  function getCurrentStudentUsername() {
    // 1. Ελέγχουμε URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const urlUsername = urlParams.get('username');
    if (urlUsername) {
      return urlUsername;
    }
    
    // 2. Ελέγχουμε localStorage (από προηγούμενη σύνδεση)
    const loggedInStudent = localStorage.getItem('loggedInStudent');
    if (loggedInStudent) {
      try {
        const student = JSON.parse(loggedInStudent);
        return student.username;
      } catch (e) {
        console.error('Error parsing logged in student:', e);
      }
    }
    
    // 3. Ελέγχουμε sessionStorage 
    const sessionUsername = sessionStorage.getItem('currentUsername');
    if (sessionUsername) {
      return sessionUsername;
    }
    
    // 4. Fallback - δεν βρέθηκε username
    return null;
  }
  
  // Function to show username selector if no username found
  // Load student profile data
  async function loadStudentProfile(username) {
    console.log('Loading profile for username:', username);
    
    // Καθαρίζουμε όλα τα προηγούμενα cached δεδομένα πρώτα
    localStorage.removeItem('loggedInStudent');
    sessionStorage.removeItem('currentUsername');
    clearPreviousData();
    
    try {
      const response = await fetch(`/api/student/profile/${username}?_t=${Date.now()}`);
      console.log('API Response status:', response.status);
      
      if (!response.ok) {
        if (response.status === 404) {
          throw new Error(`Ο μαθητής με username "${username}" δεν βρέθηκε`);
        }
        throw new Error('Failed to fetch student profile');
      }
      
      const studentData = await response.json();
      console.log('Student data received:', studentData);
      
      // Αποθηκεύουμε τα ΝΕΑ στοιχεία
      sessionStorage.setItem('currentUsername', username);
      localStorage.setItem('loggedInStudent', JSON.stringify({ username: username, role: 'student' }));
      
      displayStudentProfile(studentData);
      
    } catch (error) {
      console.error('Error loading student profile:', error);
      showError(error.message || 'Σφάλμα φόρτωσης των στοιχείων σας');
    }
  }
  
  // Clear previous data to avoid showing wrong student info
  function clearPreviousData() {
    console.log('Clearing previous student data...');
    
    // Clear all profile fields
    document.getElementById('student-username').textContent = '';
    document.getElementById('student-firstname').textContent = '';
    document.getElementById('student-lastname').textContent = '';
    document.getElementById('student-email').textContent = '';
    document.getElementById('student-phone').textContent = '';
    document.getElementById('student-class').textContent = '';
    
    // Clear subjects section
    document.getElementById('student-subjects').innerHTML = '';
  }
  
  // Display student profile data
  function displayStudentProfile(student) {
    console.log('Displaying student profile:', student);
    
    // Show logout button
    document.getElementById('logout-btn').style.display = 'block';
    
    console.log('Setting student details...');
    
    // Fill personal information (using correct field names from database)
    document.getElementById('student-username').textContent = student.username || '-';
    document.getElementById('student-firstname').textContent = student.first_name || '-';
    document.getElementById('student-lastname').textContent = student.last_name || '-';
    document.getElementById('student-email').textContent = student.email || '-';
    document.getElementById('student-phone').textContent = student.phone || '-';
    document.getElementById('student-class').textContent = student.class || '-';
    
    console.log('Setting student enrollments...');
    console.log('Enrollments data:', student.enrollments);
    
    // Display enrollments (subjects)
    displayStudentSubjects(student.enrollments || []);

    console.log('Profile display completed for:', student.username);
  }
  
  // Display student subjects/enrollments
  function displayStudentSubjects(enrollments) {
    const subjectsContainer = document.getElementById('student-subjects');
    
    console.log('Displaying subjects:', enrollments);
    
    if (enrollments.length === 0) {
      subjectsContainer.innerHTML = '<p style="text-align: center; color: #666;">Δεν είστε εγγεγραμμένοι σε κανένα μάθημα ακόμα.</p>';
      return;
    }
    
    const subjectsHTML = enrollments.map(enrollment => `
      <div class="subject-card" style="background: #f8f9fa;  border-bottom: 2px solid #f5c6cb;  padding: 15px; margin: 10px 0; ">
        <h4 style="margin: 0 0 10px 0; color: #5f3d2c;  margin-bottom: 20px;">${enrollment.subject_name || 'Άγνωστο Μάθημα'}</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 14px;">
          <div><strong>Κωδικός:</strong> ${enrollment.subject_code || '-'}</div>
          <div><strong>Τάξη:</strong> ${enrollment.subject_class || '-'}</div>
          <div><strong>Καθηγητής:</strong> ${enrollment.teacher_name || 'Δεν έχει οριστεί'}</div>
          <div><strong>Κατάσταση:</strong> <span style="color: ${enrollment.status === 'active' ? 'green' : 'red'};">${getStatusText(enrollment.status)}</span></div>
        </div>
      </div>
    `).join('');
    
    subjectsContainer.innerHTML = subjectsHTML;
  }
  
  // Helper functions
  function formatDate(dateString) {
    if (!dateString) return 'Δεν έχει οριστεί';
    const date = new Date(dateString);
    return date.toLocaleDateString('el-GR');
  }
  
  function getStatusText(status) {
    switch(status) {
      case 'active': return 'Ενεργή';
      case 'inactive': return 'Ανενεργή';
      case 'completed': return 'Ολοκληρωμένη';
      default: return status || 'Άγνωστη';
    }
  }
  
  // Function to show error messages
  function showError(message) {
    document.getElementById('login-prompt').innerHTML = `
      <div style="text-align: center; padding: 40px; background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; border-radius: 10px;">
        <h3>Σφάλμα</h3>
        <p>${message}</p>
        <button onclick="window.location.href='/index2.html'" style="padding: 10px 20px; background: #2C5F4F; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">
          Μετάβαση στη Σύνδεση
        </button>
      </div>
    `;
    document.getElementById('login-prompt').style.display = 'block';
  }

  // Logout function
  function studentLogout() {
    // Clear any stored session
    localStorage.removeItem('loggedInStudent');
    sessionStorage.removeItem('currentUsername');
    currentStudent = null;
    
    // Ανακατεύθυνση στη σελίδα login
    window.location.href = '/index2.html';
  }
  
  // Optional: Add some keyboard shortcuts or other functionality here
  // document.addEventListener('keypress', function(e) {
  //   if (e.key === 'F5') {
  //     location.reload();
  //   }
  // });
</script>

</body>
</html>
