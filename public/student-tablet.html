<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ÎœÎ±Î¸Î·Ï„Î¹ÎºÏŒ Î£Ï„Î­ÎºÎ¹</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;400&display=swap" rel="stylesheet">
  <style>
    .info-item {
      padding: 10px;
      background: #f8f9fa;
      border-radius: 5px;
      border-left: 3px solid #2C5F4F;
    }
    
    .info-item strong {
      color: #2C5F4F;
      display: block;
      margin-bottom: 5px;
    }
    
    .subject-card {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .subject-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .login-form {
      max-width: 400px;
      margin: 0 auto;
    }
    
    .login-form input {
      width: 100%;
      margin-bottom: 10px;
    }
    
    .logout-btn:hover {
      background: rgba(255,255,255,0.3) !important;
    }
    
    @media (max-width: 768px) {
      .profile-grid {
        grid-template-columns: 1fr !important;
      }
      
      .logout-btn {
        position: static !important;
        margin-top: 15px;
      }
      
      .student-header {
        text-align: center !important;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <div class="logo"><img src="logo.png" alt="logo"></div>
      <nav>
        <a href="#">Î‘ÏÏ‡Î¹ÎºÎ® Î£ÎµÎ»Î¯Î´Î±</a>
        <a href="#">ÎšÎ±ÏÏ„Î­Î»Î± ÎœÎ±Î¸Î·Ï„Î®</a>
        <a href="#">Î ÏÎ¿Î³ÏÎ¬Î¼Î¼Î±Ï„Î±</a>
        <a href="#">Î Î±Î½ÎµÎ»Î»Î±Î´Î¹ÎºÎ­Ï‚ Î•Î¾ÎµÏ„Î¬ÏƒÎµÎ¹Ï‚</a>
        <a href="#">Î¦Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯ÎµÏ‚</a>
        <a href="#">Î£Ï‡ÎµÏ„Î¹ÎºÎ¬ Î¼Îµ ÎµÎ¼Î¬Ï‚</a>
      </nav>
      <div class="icons">
        <a href="#"><img src="\elements\Group 17.svg" alt="fb" class="facebook-icon"></a>
        <a href="#"><img src="\elements\mdi_instagram.svg" alt="insta" class="instagram-icon"></a>
        <a href="#"><img src="\elements\phone.svg" alt="phone"></a>
        <a href="#"><img src="\elements\mail.svg" alt="mail"></a>
      </div>
      <a href="index.html" class="login-btn" style="text-decoration: none;">ÎˆÎ¾Î¿Î´Î¿Ï‚</a>
    </div>
  </header>
  
  <main>
    <div class="container" style="max-width: 1200px; margin: 0 auto; padding: 20px;">
      <div class="student-header" style="background: linear-gradient(135deg, #2C5F4F, #4A7C59); color: white; padding: 20px; border-radius: 10px; margin-bottom: 30px; text-align: center; position: relative;">
        <h1>ÎšÎ±ÏÏ„Î­Î»Î± ÎœÎ±Î¸Î·Ï„Î®</h1>
        <p>Î•Î´Ï Î¼Ï€Î¿ÏÎµÎ¯Ï‚ Î½Î± Î´ÎµÎ¹Ï‚ Ï„Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± ÏƒÎ¿Ï… ÎºÎ±Î¹ Ï„Î± Î¼Î±Î¸Î®Î¼Î±Ï„Î¬ ÏƒÎ¿Ï…</p>
        <button id="logout-btn" onclick="studentLogout()" style="position: absolute; top: 20px; right: 20px; padding: 8px 15px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 5px; cursor: pointer; display: none;">
          Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·
        </button>
      </div>
       <div id="student-info" >
        <div class="profile-section" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
          <h2 style="color: #2C5F4F; margin-bottom: 20px;">Î ÏÎ¿ÏƒÏ‰Ï€Î¹ÎºÎ¬ Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î±</h2>
          <div class="profile-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            <div class="info-item">
              <strong>Username:</strong> <span id="student-username"></span>
            </div>
            <div class="info-item">
              <strong>ÎŒÎ½Î¿Î¼Î±:</strong> <span id="student-firstname"></span>
            </div>
            <div class="info-item">
              <strong>Î•Ï€ÏÎ½Ï…Î¼Î¿:</strong> <span id="student-lastname"></span>
            </div>
            <div class="info-item">
              <strong>Email:</strong> <span id="student-email"></span>
            </div>
            <div class="info-item">
              <strong>Î¤Î·Î»Î­Ï†Ï‰Î½Î¿:</strong> <span id="student-phone"></span>
            </div>
            <div class="info-item">
              <strong>Î¤Î¬Î¾Î·:</strong> <span id="student-class"></span>
            </div>
          </div>
        </div>
        
        <div class="subjects-section" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
          <h2 style="color: #2C5F4F; margin-bottom: 20px;">Î¤Î± ÎœÎ±Î¸Î®Î¼Î±Ï„Î¬ ÎœÎ¿Ï…</h2>
          <div id="student-subjects">
            <!-- Î¤Î± Î¼Î±Î¸Î®Î¼Î±Ï„Î± Î¸Î± Ï†Î¿ÏÏ„Ï‰Î¸Î¿ÏÎ½ ÎµÎ´Ï -->
          </div>
        </div>
      </div>
      
      <div id="login-prompt" style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px; display: none;">
        <div id="login-error" style="color: red; margin-top: 10px; display: none;"></div>
      </div>
    </div>


<div style="display: flex; justify-content: center; gap: 16px;">
  <a href="grades.html" class="student-box" style="height: 50px; width: 100px; background-color: brown; color: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; text-decoration: none; font-weight: bold;">
    Î’Î±Î¸Î¼Î¿Î»Î¿Î³Î¯ÎµÏ‚ ÎœÎ±Î¸Î·Ï„Î®
  </a>
  <a href="calendar.html" class="student-box" style="height: 50px; width: 100px; background-color: #e2c08d; color: #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; text-decoration: none; font-weight: bold;">
    Î—Î¼ÎµÏÎ¿Î»ÏŒÎ³Î¹Î¿
  </a>
  <a href="progress.html" class="student-box" style="height: 50px; width: 100px; background-color: #f7e7c1; color: #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; text-decoration: none; font-weight: bold;">
    Î ÏÏŒÎ¿Î´Î¿Ï‚ ÎœÎ±Î¸Î·Ï„Î®
  </a>
</div>

  </main>
  <footer>
    <div class="footer-content">
      <div class="footer-logo">ÎœÎ±Î¸Î·Ï„Î¹ÎºÏŒ Î£Ï„Î­ÎºÎ¹</div>
      <div class="footer-links">
        <span>ÎšÎ±Î¸Î·Î³Î·Ï„Î­Ï‚:</span>
        <span>...</span>
      </div>
      <div class="footer-map">
        <img src="map.png" alt="Î§Î¬ÏÏ„Î·Ï‚">
      </div>
    </div>
    <div class="footer-bottom">
      &copy; 2025 ÎœÎ±Î¸Î·Ï„Î¹ÎºÏŒ Î£Ï„Î­ÎºÎ¹
    </div>
  </footer>
    <script>
  // Global variables
  let currentStudent = null;
  
  // Check if student is already logged in (check localStorage)
  document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ Student tablet loading...');
    console.log('ğŸ” Checking localStorage for logged in student...');
    
    // Î•Î»Î­Î³Ï‡Î¿Ï…Î¼Îµ Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Ï‚ Î¼Î±Î¸Î·Ï„Î®Ï‚
    const loggedInStudent = getLoggedInStudent();
    
    if (loggedInStudent && loggedInStudent.username) {
      console.log('âœ… Found logged in student:', loggedInStudent.username);
      // Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î· Ï†ÏŒÏÏ„Ï‰ÏƒÎ· Ï„Ï‰Î½ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Ï‰Î½ Ï„Î¿Ï… ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Ï… Î¼Î±Î¸Î·Ï„Î®
      loadStudentProfile(loggedInStudent.username);
    } else {
      console.log('âŒ No logged in student found');
      console.log('ğŸ’¾ Current localStorage state:', localStorage.getItem('loggedInStudent'));
      // Î‘Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Ï‚ Î¼Î±Î¸Î·Ï„Î®Ï‚, Î±Î½Î±ÎºÎ±Ï„ÎµÏÎ¸Ï…Î½ÏƒÎ· ÏƒÏ„Î· ÏƒÎµÎ»Î¯Î´Î± login
      showLoginRequired();
    }
  });
  
  // Function to get logged in student from localStorage
  function getLoggedInStudent() {
    try {
      const loggedInData = localStorage.getItem('loggedInStudent');
      console.log('ğŸ“¦ Raw localStorage data:', loggedInData);
      
      if (loggedInData) {
        const student = JSON.parse(loggedInData);
        console.log('ğŸ‘¤ Parsed student data:', student);
        
        // ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ username (Î²Î±ÏƒÎ¹ÎºÏŒ ÎºÏÎ¹Ï„Î®ÏÎ¹Î¿)
        if (student.username) {
          // ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Ï‡ÏÏŒÎ½Î¿Ï… login (Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹)
          if (student.loginTime) {
            const loginTime = new Date(student.loginTime);
            const now = new Date();
            const hoursDiff = (now - loginTime) / (1000 * 60 * 60);
            console.log('â° Hours since login:', hoursDiff);
            
            // Î‘Î½ Î­Ï‡Î¿Ï…Î½ Ï€ÎµÏÎ¬ÏƒÎµÎ¹ Ï€Î¬Î½Ï‰ Î±Ï€ÏŒ 24 ÏÏÎµÏ‚, ÏƒÎ²Î®Î½Î¿Ï…Î¼Îµ Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î±
            if (hoursDiff > 24) {
              console.log('â±ï¸ Login expired, clearing localStorage');
              localStorage.removeItem('loggedInStudent');
              return null;
            }
          }
          
          // ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ ÏÏŒÎ»Î¿Ï… (Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹)
          if (student.role && student.role !== 'student') {
            console.log('ğŸš« Wrong role:', student.role);
            return null;
          }
          
          console.log('âœ… Valid student found:', student.username);
          return student;
        }
      }
    } catch (e) {
      console.error('âŒ Error parsing logged in student:', e);
      localStorage.removeItem('loggedInStudent'); // ÎšÎ±Î¸Î±ÏÎ¯Î¶Î¿Ï…Î¼Îµ corrupted data
    }
    
    console.log('âŒ No valid student found');
    return null;
  }
  
  // Function to show login required message
  function showLoginRequired() {
    document.getElementById('login-prompt').innerHTML = `
      <div style="text-align: center; padding: 40px; background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; border-radius: 10px;">
        <h3>ğŸ” Î‘Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹ Î£ÏÎ½Î´ÎµÏƒÎ·</h3>
        <p>Î ÏÎ­Ï€ÎµÎ¹ Î½Î± ÏƒÏ…Î½Î´ÎµÎ¸ÎµÎ¯Ï„Îµ Î³Î¹Î± Î½Î± Î´ÎµÎ¯Ï„Îµ Ï„Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± ÏƒÎ±Ï‚.</p>
        <button onclick="window.location.href='/index2.html'" style="padding: 10px 20px; background: #2C5F4F; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">
          ÎœÎµÏ„Î¬Î²Î±ÏƒÎ· ÏƒÏ„Î· Î£ÏÎ½Î´ÎµÏƒÎ·
        </button>
      </div>
    `;
    document.getElementById('login-prompt').style.display = 'block';
  }
  
  // Function to get current student username from various sources
  function getCurrentStudentUsername() {
    // 1. Î•Î»Î­Î³Ï‡Î¿Ï…Î¼Îµ URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const urlUsername = urlParams.get('username');
    if (urlUsername) {
      return urlUsername;
    }
    
    // 2. Î•Î»Î­Î³Ï‡Î¿Ï…Î¼Îµ localStorage (Î±Ï€ÏŒ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î· ÏƒÏÎ½Î´ÎµÏƒÎ·)
    const loggedInStudent = localStorage.getItem('loggedInStudent');
    if (loggedInStudent) {
      try {
        const student = JSON.parse(loggedInStudent);
        return student.username;
      } catch (e) {
        console.error('Error parsing logged in student:', e);
      }
    }
    
    // 3. Î•Î»Î­Î³Ï‡Î¿Ï…Î¼Îµ sessionStorage 
    const sessionUsername = sessionStorage.getItem('currentUsername');
    if (sessionUsername) {
      return sessionUsername;
    }
    
    // 4. Fallback - Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ username
    return null;
  }
  
  // Function to show username selector if no username found
  // Load student profile data
  async function loadStudentProfile(username) {
    console.log('ğŸ”„ Loading profile for username:', username);
    
    // ÎšÎ±Î¸Î±ÏÎ¯Î¶Î¿Ï…Î¼Îµ ÏŒÎ»Î± Ï„Î± Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î± cached Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï€ÏÏÏ„Î±
    localStorage.removeItem('loggedInStudent');
    sessionStorage.removeItem('currentUsername');
    clearPreviousData();
    
    try {
      const response = await fetch(`/api/student/profile/${username}?_t=${Date.now()}`);
      console.log('ğŸ“¡ API Response status:', response.status);
      
      if (!response.ok) {
        if (response.status === 404) {
          throw new Error(`ÎŸ Î¼Î±Î¸Î·Ï„Î®Ï‚ Î¼Îµ username "${username}" Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ`);
        }
        throw new Error('Failed to fetch student profile');
      }
      
      const studentData = await response.json();
      console.log('ğŸ“Š Student data received:', studentData);
      
      // Î‘Ï€Î¿Î¸Î·ÎºÎµÏÎ¿Ï…Î¼Îµ Ï„Î± ÎÎ•Î‘ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±
      sessionStorage.setItem('currentUsername', username);
      localStorage.setItem('loggedInStudent', JSON.stringify({ username: username, role: 'student' }));
      
      displayStudentProfile(studentData);
      
    } catch (error) {
      console.error('âŒ Error loading student profile:', error);
      showError(error.message || 'Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Ï„Ï‰Î½ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Ï‰Î½ ÏƒÎ±Ï‚');
    }
  }
  
  // Clear previous data to avoid showing wrong student info
  function clearPreviousData() {
    console.log('ğŸ§¹ Clearing previous student data...');
    
    // Clear all profile fields
    document.getElementById('student-username').textContent = '';
    document.getElementById('student-firstname').textContent = '';
    document.getElementById('student-lastname').textContent = '';
    document.getElementById('student-email').textContent = '';
    document.getElementById('student-phone').textContent = '';
    document.getElementById('student-class').textContent = '';
    
    // Clear subjects section
    document.getElementById('student-subjects').innerHTML = '';
  }
  
  // Display student profile data
  function displayStudentProfile(student) {
    console.log('ğŸ¨ Displaying student profile:', student);
    
    // Show logout button
    document.getElementById('logout-btn').style.display = 'block';
    
    console.log('ğŸ‘¤ Setting student details...');
    
    // Fill personal information (using correct field names from database)
    document.getElementById('student-username').textContent = student.username || '-';
    document.getElementById('student-firstname').textContent = student.first_name || '-';
    document.getElementById('student-lastname').textContent = student.last_name || '-';
    document.getElementById('student-email').textContent = student.email || '-';
    document.getElementById('student-phone').textContent = student.phone || '-';
    document.getElementById('student-class').textContent = student.class || '-';
    
    console.log('ğŸ“š Setting student enrollments...');
    console.log('ğŸ“Š Enrollments data:', student.enrollments);
    
    // Display enrollments (subjects)
    displayStudentSubjects(student.enrollments || []);
    
    console.log('âœ… Profile display completed for:', student.username);
  }
  
  // Display student subjects/enrollments
  function displayStudentSubjects(enrollments) {
    const subjectsContainer = document.getElementById('student-subjects');
    
    console.log('ğŸ“‹ Displaying subjects:', enrollments);
    
    if (enrollments.length === 0) {
      subjectsContainer.innerHTML = '<p style="text-align: center; color: #666;">Î”ÎµÎ½ ÎµÎ¯ÏƒÏ„Îµ ÎµÎ³Î³ÎµÎ³ÏÎ±Î¼Î¼Î­Î½Î¿Î¹ ÏƒÎµ ÎºÎ±Î½Î­Î½Î± Î¼Î¬Î¸Î·Î¼Î± Î±ÎºÏŒÎ¼Î±.</p>';
      return;
    }
    
    const subjectsHTML = enrollments.map(enrollment => `
      <div class="subject-card" style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #2C5F4F;">
        <h4 style="margin: 0 0 10px 0; color: #2C5F4F;">${enrollment.subject_name || 'Î†Î³Î½Ï‰ÏƒÏ„Î¿ ÎœÎ¬Î¸Î·Î¼Î±'}</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 14px;">
          <div><strong>ÎšÏ‰Î´Î¹ÎºÏŒÏ‚:</strong> ${enrollment.subject_code || '-'}</div>
          <div><strong>Î¤Î¬Î¾Î·:</strong> ${enrollment.subject_class || '-'}</div>
          <div><strong>ÎšÎ±Î¸Î·Î³Î·Ï„Î®Ï‚:</strong> ${enrollment.teacher_name || 'Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ Î¿ÏÎ¹ÏƒÏ„ÎµÎ¯'}</div>
          <div><strong>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·:</strong> <span style="color: ${enrollment.status === 'active' ? 'green' : 'red'};">${getStatusText(enrollment.status)}</span></div>
        </div>
      </div>
    `).join('');
    
    subjectsContainer.innerHTML = subjectsHTML;
  }
  
  // Helper functions
  function formatDate(dateString) {
    if (!dateString) return 'Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ Î¿ÏÎ¹ÏƒÏ„ÎµÎ¯';
    const date = new Date(dateString);
    return date.toLocaleDateString('el-GR');
  }
  
  function getStatusText(status) {
    switch(status) {
      case 'active': return 'Î•Î½ÎµÏÎ³Î®';
      case 'inactive': return 'Î‘Î½ÎµÎ½ÎµÏÎ³Î®';
      case 'completed': return 'ÎŸÎ»Î¿ÎºÎ»Î·ÏÏ‰Î¼Î­Î½Î·';
      default: return status || 'Î†Î³Î½Ï‰ÏƒÏ„Î·';
    }
  }
  
  // Function to show error messages
  function showError(message) {
    document.getElementById('login-prompt').innerHTML = `
      <div style="text-align: center; padding: 40px; background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; border-radius: 10px;">
        <h3>âš ï¸ Î£Ï†Î¬Î»Î¼Î±</h3>
        <p>${message}</p>
        <button onclick="window.location.href='/index2.html'" style="padding: 10px 20px; background: #2C5F4F; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">
          ÎœÎµÏ„Î¬Î²Î±ÏƒÎ· ÏƒÏ„Î· Î£ÏÎ½Î´ÎµÏƒÎ·
        </button>
      </div>
    `;
    document.getElementById('login-prompt').style.display = 'block';
  }

  // Logout function
  function studentLogout() {
    // Clear any stored session
    localStorage.removeItem('loggedInStudent');
    sessionStorage.removeItem('currentUsername');
    currentStudent = null;
    
    // Î‘Î½Î±ÎºÎ±Ï„ÎµÏÎ¸Ï…Î½ÏƒÎ· ÏƒÏ„Î· ÏƒÎµÎ»Î¯Î´Î± login
    window.location.href = '/index2.html';
  }
  
  // Optional: Add some keyboard shortcuts or other functionality here
  // document.addEventListener('keypress', function(e) {
  //   if (e.key === 'F5') {
  //     location.reload();
  //   }
  // });
</script>

</body>
</html>
