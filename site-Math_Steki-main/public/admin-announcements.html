<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Διαχείριση Ανακοινώσεων - Math Steki</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .announcements-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 4px solid #007bff;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .priority-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .priority-low { background: #d4edda; color: #155724; }
        .priority-normal { background: #cce7ff; color: #004085; }
        .priority-high { background: #fff3cd; color: #856404; }
        .priority-urgent { background: #f8d7da; color: #721c24; }

        .type-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .type-general { background: #e2e6ea; color: #495057; }
        .type-class { background: #d1ecf1; color: #0c5460; }
        .type-subject { background: #d4edda; color: #155724; }

        .announcements-list {
            margin-top: 30px;
        }

        .announcement-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .announcement-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .announcement-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }

        .announcement-badges {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .announcement-content {
            color: #666;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .announcement-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: #999;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }

        .announcement-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }

        .notification {
            padding: 12px 20px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .notification.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .notification.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .conditional-fields {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 4px;
        }

        .conditional-fields.show {
            display: block;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .announcement-header {
                flex-direction: column;
                gap: 10px;
            }
            
            .announcement-meta {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="announcements-container">
        <h1>🔔 Διαχείριση Ανακοινώσεων</h1>
        
        <div id="notification" class="notification" style="display: none;"></div>

        <!-- Φόρμα νέας ανακοίνωσης -->
        <div class="form-section">
            <h2>📝 Νέα Ανακοίνωση</h2>
            <form id="announcementForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="title">Τίτλος *</label>
                        <input type="text" id="title" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="priority">Προτεραιότητα</label>
                        <select id="priority" name="priority">
                            <option value="low">Χαμηλή</option>
                            <option value="normal" selected>Κανονική</option>
                            <option value="high">Υψηλή</option>
                            <option value="urgent">Επείγουσα</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="type">Τύπος Ανακοίνωσης</label>
                        <select id="type" name="type">
                            <option value="general">Γενική (Όλοι οι μαθητές)</option>
                            <option value="class">Ανά Τάξη</option>
                            <option value="subject">Ανά Τμήμα/Μάθημα</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="startDate">Ημερομηνία Έναρξης</label>
                        <input type="date" id="startDate" name="startDate">
                    </div>
                </div>

                <!-- Conditional fields -->
                <div id="classFields" class="conditional-fields">
                    <div class="form-group">
                        <label for="targetClass">Τάξη</label>
                        <select id="targetClass" name="targetClass">
                            <option value="">Επιλέξτε τάξη...</option>
                        </select>
                    </div>
                </div>

                <div id="subjectFields" class="conditional-fields">
                    <div class="form-group">
                        <label for="targetSubject">Τμήμα/Μάθημα</label>
                        <select id="targetSubject" name="targetSubject">
                            <option value="">Επιλέξτε τμήμα...</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="endDate">Ημερομηνία Λήξης</label>
                        <input type="date" id="endDate" name="endDate">
                    </div>
                    <div class="form-group">
                        <label for="externalLink">Εξωτερικός Σύνδεσμος</label>
                        <input type="url" id="externalLink" name="externalLink" placeholder="https://...">
                    </div>
                </div>

                <div class="form-group full-width">
                    <label for="content">Περιεχόμενο *</label>
                    <textarea id="content" name="content" required placeholder="Γράψτε το περιεχόμενο της ανακοίνωσης..."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="pdfAttachment">PDF Συνημμένο</label>
                        <input type="text" id="pdfAttachment" name="pdfAttachment" placeholder="Όνομα αρχείου PDF">
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button type="submit" class="btn btn-primary">
                            📢 Δημιουργία Ανακοίνωσης
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Λίστα ανακοινώσεων -->
        <div class="announcements-list">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2> Υπάρχουσες Ανακοινώσεις</h2>
                <button onclick="loadAnnouncements()" class="btn btn-primary btn-sm">
                     Ανανέωση
                </button>
            </div>
            <div id="announcementsList">
                <p>Φόρτωση ανακοινώσεων...</p>
            </div>
        </div>
    </div>

    <script>
        let subjects = [];
        let classes = [];

        // Φόρτωση initial data
        document.addEventListener('DOMContentLoaded', function() {
            loadClasses();
            loadSubjects();
            loadAnnouncements();
            
            // Event listener για type change
            document.getElementById('type').addEventListener('change', function() {
                toggleConditionalFields(this.value);
            });
        });

        // Toggle conditional fields based on type
        function toggleConditionalFields(type) {
            const classFields = document.getElementById('classFields');
            const subjectFields = document.getElementById('subjectFields');
            
            classFields.classList.remove('show');
            subjectFields.classList.remove('show');
            
            if (type === 'class') {
                classFields.classList.add('show');
            } else if (type === 'subject') {
                subjectFields.classList.add('show');
            }
        }

        // Φόρτωση τάξεων
        async function loadClasses() {
            try {
                const response = await fetch('/classes');
                if (response.ok) {
                    classes = await response.json();
                    const select = document.getElementById('targetClass');
                    select.innerHTML = '<option value="">Επιλέξτε τάξη...</option>';
                    classes.forEach(cls => {
                        select.innerHTML += `<option value="${cls.class_name}">${cls.class_name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading classes:', error);
            }
        }

        // Φόρτωση τμημάτων
        async function loadSubjects() {
            try {
                const response = await fetch('/subjects');
                if (response.ok) {
                    subjects = await response.json();
                    const select = document.getElementById('targetSubject');
                    select.innerHTML = '<option value="">Επιλέξτε τμήμα...</option>';
                    subjects.forEach(subject => {
                        select.innerHTML += `<option value="${subject.id}">${subject.name} (${subject.class})</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading subjects:', error);
            }
        }

        // Φόρτωση ανακοινώσεων
        async function loadAnnouncements() {
            try {
                const response = await fetch('/announcements');
                if (response.ok) {
                    const announcements = await response.json();
                    displayAnnouncements(announcements);
                } else {
                    document.getElementById('announcementsList').innerHTML = '<p>Σφάλμα φόρτωσης ανακοινώσεων</p>';
                }
            } catch (error) {
                console.error('Error loading announcements:', error);
                document.getElementById('announcementsList').innerHTML = '<p>Σφάλμα φόρτωσης ανακοινώσεων</p>';
            }
        }

        // Εμφάνιση ανακοινώσεων
        function displayAnnouncements(announcements) {
            const container = document.getElementById('announcementsList');
            
            if (announcements.length === 0) {
                container.innerHTML = '<p>Δεν υπάρχουν ανακοινώσεις</p>';
                return;
            }

            container.innerHTML = announcements.map(announcement => `
                <div class="announcement-card">
                    <div class="announcement-header">
                        <h3 class="announcement-title">${announcement.title}</h3>
                        <div class="announcement-badges">
                            <span class="priority-badge priority-${announcement.priority}">${getPriorityText(announcement.priority)}</span>
                            <span class="type-badge type-${announcement.notification_type}">${getTypeText(announcement.notification_type)}</span>
                        </div>
                    </div>
                    
                    <div class="announcement-content">
                        ${announcement.content.replace(/\n/g, '<br>')}
                    </div>
                    
                    ${announcement.target_class ? `<p><strong>Τάξη:</strong> ${announcement.target_class}</p>` : ''}
                    ${announcement.target_subject_id ? `<p><strong>Τμήμα:</strong> ${getSubjectName(announcement.target_subject_id)}</p>` : ''}
                    ${announcement.start_date ? `<p><strong>Από:</strong> ${formatDate(announcement.start_date)}</p>` : ''}
                    ${announcement.end_date ? `<p><strong>Έως:</strong> ${formatDate(announcement.end_date)}</p>` : ''}
                    ${announcement.external_link ? `<p><strong>Σύνδεσμος:</strong> <a href="${announcement.external_link}" target="_blank">${announcement.external_link}</a></p>` : ''}
                    ${announcement.pdf_attachment ? `<p><strong>PDF:</strong> ${announcement.pdf_attachment}</p>` : ''}
                    
                    <div class="announcement-meta">
                        <span>Δημιουργήθηκε: ${formatDateTime(announcement.created_at)}</span>
                        <div class="announcement-actions">
                            <button onclick="editAnnouncement(${announcement.notification_id})" class="btn btn-warning btn-sm">
                                 Επεξεργασία
                            </button>
                            <button onclick="deleteAnnouncement(${announcement.notification_id})" class="btn btn-danger btn-sm">
                                 Διαγραφή
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Helper functions
        function getPriorityText(priority) {
            const map = { 'low': 'Χαμηλή', 'normal': 'Κανονική', 'high': 'Υψηλή', 'urgent': 'Επείγουσα' };
            return map[priority] || priority;
        }

        function getTypeText(type) {
            const map = { 'general': 'Γενική', 'class': 'Τάξη', 'subject': 'Τμήμα' };
            return map[type] || type;
        }

        function getSubjectName(subjectId) {
            const subject = subjects.find(s => s.id == subjectId);
            return subject ? `${subject.name} (${subject.class})` : 'Άγνωστο';
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('el-GR');
        }

        function formatDateTime(dateString) {
            return new Date(dateString).toLocaleString('el-GR');
        }

        // Αποθήκευση ανακοίνωσης
        document.getElementById('announcementForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            
            // Clean up data based on type
            if (data.type !== 'class') {
                data.targetClass = null;
            }
            if (data.type !== 'subject') {
                data.targetSubject = null;
            }
            
            // Convert empty strings to null
            Object.keys(data).forEach(key => {
                if (data[key] === '') data[key] = null;
            });

            try {
                const response = await fetch('/announcements', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: data.title,
                        content: data.content,
                        type: data.type,
                        targetClass: data.targetClass,
                        targetSubjectId: data.targetSubject,
                        startDate: data.startDate,
                        endDate: data.endDate,
                        priority: data.priority,
                        pdfAttachment: data.pdfAttachment,
                        externalLink: data.externalLink
                    })
                });

                if (response.ok) {
                    showNotification('Η ανακοίνωση δημιουργήθηκε επιτυχώς!', 'success');
                    this.reset();
                    toggleConditionalFields('general');
                    loadAnnouncements();
                } else {
                    showNotification('Σφάλμα κατά τη δημιουργία της ανακοίνωσης', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Σφάλμα κατά τη δημιουργία της ανακοίνωσης', 'error');
            }
        });

        // Διαγραφή ανακοίνωσης
        async function deleteAnnouncement(id) {
            if (!confirm('Είστε σίγουροι ότι θέλετε να διαγράψετε αυτή την ανακοίνωση;')) {
                return;
            }

            try {
                const response = await fetch(`/announcements/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showNotification('Η ανακοίνωση διαγράφηκε επιτυχώς!', 'success');
                    loadAnnouncements();
                } else {
                    showNotification('Σφάλμα κατά τη διαγραφή της ανακοίνωσης', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Σφάλμα κατά τη διαγραφή της ανακοίνωσης', 'error');
            }
        }

        // Εμφάνιση notification
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        // Placeholder για επεξεργασία
        function editAnnouncement(id) {
            showNotification('Η λειτουργία επεξεργασίας θα υλοποιηθεί σύντομα', 'error');
        }
    </script>
</body>
</html>
