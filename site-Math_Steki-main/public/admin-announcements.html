<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î‘Î½Î±ÎºÎ¿Î¹Î½ÏÏƒÎµÏ‰Î½ - Math Steki</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .announcements-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 4px solid #007bff;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .priority-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .priority-low { background: #d4edda; color: #155724; }
        .priority-normal { background: #cce7ff; color: #004085; }
        .priority-high { background: #fff3cd; color: #856404; }
        .priority-urgent { background: #f8d7da; color: #721c24; }

        .type-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .type-general { background: #e2e6ea; color: #495057; }
        .type-class { background: #d1ecf1; color: #0c5460; }
        .type-subject { background: #d4edda; color: #155724; }

        .announcements-list {
            margin-top: 30px;
        }

        .announcement-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .announcement-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .announcement-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }

        .announcement-badges {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .announcement-content {
            color: #666;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .announcement-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: #999;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }

        .announcement-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }

        .notification {
            padding: 12px 20px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .notification.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .notification.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .conditional-fields {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 4px;
        }

        .conditional-fields.show {
            display: block;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .announcement-header {
                flex-direction: column;
                gap: 10px;
            }
            
            .announcement-meta {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="announcements-container">
        <h1>ğŸ”” Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î‘Î½Î±ÎºÎ¿Î¹Î½ÏÏƒÎµÏ‰Î½</h1>
        
        <div id="notification" class="notification" style="display: none;"></div>

        <!-- Î¦ÏŒÏÎ¼Î± Î½Î­Î±Ï‚ Î±Î½Î±ÎºÎ¿Î¯Î½Ï‰ÏƒÎ·Ï‚ -->
        <div class="form-section">
            <h2>ğŸ“ ÎÎ­Î± Î‘Î½Î±ÎºÎ¿Î¯Î½Ï‰ÏƒÎ·</h2>
            <form id="announcementForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="title">Î¤Î¯Ï„Î»Î¿Ï‚ *</label>
                        <input type="text" id="title" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="priority">Î ÏÎ¿Ï„ÎµÏÎ±Î¹ÏŒÏ„Î·Ï„Î±</label>
                        <select id="priority" name="priority">
                            <option value="low">Î§Î±Î¼Î·Î»Î®</option>
                            <option value="normal" selected>ÎšÎ±Î½Î¿Î½Î¹ÎºÎ®</option>
                            <option value="high">Î¥ÏˆÎ·Î»Î®</option>
                            <option value="urgent">Î•Ï€ÎµÎ¯Î³Î¿Ï…ÏƒÎ±</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="type">Î¤ÏÏ€Î¿Ï‚ Î‘Î½Î±ÎºÎ¿Î¯Î½Ï‰ÏƒÎ·Ï‚</label>
                        <select id="type" name="type">
                            <option value="general">Î“ÎµÎ½Î¹ÎºÎ® (ÎŒÎ»Î¿Î¹ Î¿Î¹ Î¼Î±Î¸Î·Ï„Î­Ï‚)</option>
                            <option value="class">Î‘Î½Î¬ Î¤Î¬Î¾Î·</option>
                            <option value="subject">Î‘Î½Î¬ Î¤Î¼Î®Î¼Î±/ÎœÎ¬Î¸Î·Î¼Î±</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="startDate">Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± ÎˆÎ½Î±ÏÎ¾Î·Ï‚</label>
                        <input type="date" id="startDate" name="startDate">
                    </div>
                </div>

                <!-- Conditional fields -->
                <div id="classFields" class="conditional-fields">
                    <div class="form-group">
                        <label for="targetClass">Î¤Î¬Î¾Î·</label>
                        <select id="targetClass" name="targetClass">
                            <option value="">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¬Î¾Î·...</option>
                        </select>
                    </div>
                </div>

                <div id="subjectFields" class="conditional-fields">
                    <div class="form-group">
                        <label for="targetSubject">Î¤Î¼Î®Î¼Î±/ÎœÎ¬Î¸Î·Î¼Î±</label>
                        <select id="targetSubject" name="targetSubject">
                            <option value="">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¼Î®Î¼Î±...</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="endDate">Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± Î›Î®Î¾Î·Ï‚</label>
                        <input type="date" id="endDate" name="endDate">
                    </div>
                    <div class="form-group">
                        <label for="externalLink">Î•Î¾Ï‰Ï„ÎµÏÎ¹ÎºÏŒÏ‚ Î£ÏÎ½Î´ÎµÏƒÎ¼Î¿Ï‚</label>
                        <input type="url" id="externalLink" name="externalLink" placeholder="https://...">
                    </div>
                </div>

                <div class="form-group full-width">
                    <label for="content">Î ÎµÏÎ¹ÎµÏ‡ÏŒÎ¼ÎµÎ½Î¿ *</label>
                    <textarea id="content" name="content" required placeholder="Î“ÏÎ¬ÏˆÏ„Îµ Ï„Î¿ Ï€ÎµÏÎ¹ÎµÏ‡ÏŒÎ¼ÎµÎ½Î¿ Ï„Î·Ï‚ Î±Î½Î±ÎºÎ¿Î¯Î½Ï‰ÏƒÎ·Ï‚..."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="pdfAttachment">PDF Î£Ï…Î½Î·Î¼Î¼Î­Î½Î¿</label>
                        <input type="text" id="pdfAttachment" name="pdfAttachment" placeholder="ÎŒÎ½Î¿Î¼Î± Î±ÏÏ‡ÎµÎ¯Î¿Ï… PDF">
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <button type="submit" class="btn btn-primary">
                            ğŸ“¢ Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î‘Î½Î±ÎºÎ¿Î¯Î½Ï‰ÏƒÎ·Ï‚
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Î›Î¯ÏƒÏ„Î± Î±Î½Î±ÎºÎ¿Î¹Î½ÏÏƒÎµÏ‰Î½ -->
        <div class="announcements-list">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2> Î¥Ï€Î¬ÏÏ‡Î¿Ï…ÏƒÎµÏ‚ Î‘Î½Î±ÎºÎ¿Î¹Î½ÏÏƒÎµÎ¹Ï‚</h2>
                <button onclick="loadAnnouncements()" class="btn btn-primary btn-sm">
                     Î‘Î½Î±Î½Î­Ï‰ÏƒÎ·
                </button>
            </div>
            <div id="announcementsList">
                <p>Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î±Î½Î±ÎºÎ¿Î¹Î½ÏÏƒÎµÏ‰Î½...</p>
            </div>
        </div>
    </div>

    <script>
        let subjects = [];
        let classes = [];

        // Î¦ÏŒÏÏ„Ï‰ÏƒÎ· initial data
        document.addEventListener('DOMContentLoaded', function() {
            loadClasses();
            loadSubjects();
            loadAnnouncements();
            
            // Event listener Î³Î¹Î± type change
            document.getElementById('type').addEventListener('change', function() {
                toggleConditionalFields(this.value);
            });
        });

        // Toggle conditional fields based on type
        function toggleConditionalFields(type) {
            const classFields = document.getElementById('classFields');
            const subjectFields = document.getElementById('subjectFields');
            
            classFields.classList.remove('show');
            subjectFields.classList.remove('show');
            
            if (type === 'class') {
                classFields.classList.add('show');
            } else if (type === 'subject') {
                subjectFields.classList.add('show');
            }
        }

        // Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Ï„Î¬Î¾ÎµÏ‰Î½
        async function loadClasses() {
            try {
                const response = await fetch('/classes');
                if (response.ok) {
                    classes = await response.json();
                    const select = document.getElementById('targetClass');
                    select.innerHTML = '<option value="">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¬Î¾Î·...</option>';
                    classes.forEach(cls => {
                        select.innerHTML += `<option value="${cls.class_name}">${cls.class_name}</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading classes:', error);
            }
        }

        // Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Ï„Î¼Î·Î¼Î¬Ï„Ï‰Î½
        async function loadSubjects() {
            try {
                const response = await fetch('/subjects');
                if (response.ok) {
                    subjects = await response.json();
                    const select = document.getElementById('targetSubject');
                    select.innerHTML = '<option value="">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¼Î®Î¼Î±...</option>';
                    subjects.forEach(subject => {
                        select.innerHTML += `<option value="${subject.id}">${subject.name} (${subject.class})</option>`;
                    });
                }
            } catch (error) {
                console.error('Error loading subjects:', error);
            }
        }

        // Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î±Î½Î±ÎºÎ¿Î¹Î½ÏÏƒÎµÏ‰Î½
        async function loadAnnouncements() {
            try {
                const response = await fetch('/announcements');
                if (response.ok) {
                    const announcements = await response.json();
                    displayAnnouncements(announcements);
                } else {
                    document.getElementById('announcementsList').innerHTML = '<p>Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Î±Î½Î±ÎºÎ¿Î¹Î½ÏÏƒÎµÏ‰Î½</p>';
                }
            } catch (error) {
                console.error('Error loading announcements:', error);
                document.getElementById('announcementsList').innerHTML = '<p>Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Î±Î½Î±ÎºÎ¿Î¹Î½ÏÏƒÎµÏ‰Î½</p>';
            }
        }

        // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Î±Î½Î±ÎºÎ¿Î¹Î½ÏÏƒÎµÏ‰Î½
        function displayAnnouncements(announcements) {
            const container = document.getElementById('announcementsList');
            
            if (announcements.length === 0) {
                container.innerHTML = '<p>Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î½Î±ÎºÎ¿Î¹Î½ÏÏƒÎµÎ¹Ï‚</p>';
                return;
            }

            container.innerHTML = announcements.map(announcement => `
                <div class="announcement-card">
                    <div class="announcement-header">
                        <h3 class="announcement-title">${announcement.title}</h3>
                        <div class="announcement-badges">
                            <span class="priority-badge priority-${announcement.priority}">${getPriorityText(announcement.priority)}</span>
                            <span class="type-badge type-${announcement.notification_type}">${getTypeText(announcement.notification_type)}</span>
                        </div>
                    </div>
                    
                    <div class="announcement-content">
                        ${announcement.content.replace(/\n/g, '<br>')}
                    </div>
                    
                    ${announcement.target_class ? `<p><strong>Î¤Î¬Î¾Î·:</strong> ${announcement.target_class}</p>` : ''}
                    ${announcement.target_subject_id ? `<p><strong>Î¤Î¼Î®Î¼Î±:</strong> ${getSubjectName(announcement.target_subject_id)}</p>` : ''}
                    ${announcement.start_date ? `<p><strong>Î‘Ï€ÏŒ:</strong> ${formatDate(announcement.start_date)}</p>` : ''}
                    ${announcement.end_date ? `<p><strong>ÎˆÏ‰Ï‚:</strong> ${formatDate(announcement.end_date)}</p>` : ''}
                    ${announcement.external_link ? `<p><strong>Î£ÏÎ½Î´ÎµÏƒÎ¼Î¿Ï‚:</strong> <a href="${announcement.external_link}" target="_blank">${announcement.external_link}</a></p>` : ''}
                    ${announcement.pdf_attachment ? `<p><strong>PDF:</strong> ${announcement.pdf_attachment}</p>` : ''}
                    
                    <div class="announcement-meta">
                        <span>Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ: ${formatDateTime(announcement.created_at)}</span>
                        <div class="announcement-actions">
                            <button onclick="editAnnouncement(${announcement.notification_id})" class="btn btn-warning btn-sm">
                                 Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±
                            </button>
                            <button onclick="deleteAnnouncement(${announcement.notification_id})" class="btn btn-danger btn-sm">
                                 Î”Î¹Î±Î³ÏÎ±Ï†Î®
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Helper functions
        function getPriorityText(priority) {
            const map = { 'low': 'Î§Î±Î¼Î·Î»Î®', 'normal': 'ÎšÎ±Î½Î¿Î½Î¹ÎºÎ®', 'high': 'Î¥ÏˆÎ·Î»Î®', 'urgent': 'Î•Ï€ÎµÎ¯Î³Î¿Ï…ÏƒÎ±' };
            return map[priority] || priority;
        }

        function getTypeText(type) {
            const map = { 'general': 'Î“ÎµÎ½Î¹ÎºÎ®', 'class': 'Î¤Î¬Î¾Î·', 'subject': 'Î¤Î¼Î®Î¼Î±' };
            return map[type] || type;
        }

        function getSubjectName(subjectId) {
            const subject = subjects.find(s => s.id == subjectId);
            return subject ? `${subject.name} (${subject.class})` : 'Î†Î³Î½Ï‰ÏƒÏ„Î¿';
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('el-GR');
        }

        function formatDateTime(dateString) {
            return new Date(dateString).toLocaleString('el-GR');
        }

        // Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î±Î½Î±ÎºÎ¿Î¯Î½Ï‰ÏƒÎ·Ï‚
        document.getElementById('announcementForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            
            // Clean up data based on type
            if (data.type !== 'class') {
                data.targetClass = null;
            }
            if (data.type !== 'subject') {
                data.targetSubject = null;
            }
            
            // Convert empty strings to null
            Object.keys(data).forEach(key => {
                if (data[key] === '') data[key] = null;
            });

            try {
                const response = await fetch('/announcements', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: data.title,
                        content: data.content,
                        type: data.type,
                        targetClass: data.targetClass,
                        targetSubjectId: data.targetSubject,
                        startDate: data.startDate,
                        endDate: data.endDate,
                        priority: data.priority,
                        pdfAttachment: data.pdfAttachment,
                        externalLink: data.externalLink
                    })
                });

                if (response.ok) {
                    showNotification('Î— Î±Î½Î±ÎºÎ¿Î¯Î½Ï‰ÏƒÎ· Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!', 'success');
                    this.reset();
                    toggleConditionalFields('general');
                    loadAnnouncements();
                } else {
                    showNotification('Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î· Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Ï„Î·Ï‚ Î±Î½Î±ÎºÎ¿Î¯Î½Ï‰ÏƒÎ·Ï‚', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î· Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Ï„Î·Ï‚ Î±Î½Î±ÎºÎ¿Î¯Î½Ï‰ÏƒÎ·Ï‚', 'error');
            }
        });

        // Î”Î¹Î±Î³ÏÎ±Ï†Î® Î±Î½Î±ÎºÎ¿Î¯Î½Ï‰ÏƒÎ·Ï‚
        async function deleteAnnouncement(id) {
            if (!confirm('Î•Î¯ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Î¹ ÏŒÏ„Î¹ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÏ„Îµ Î±Ï…Ï„Î® Ï„Î·Î½ Î±Î½Î±ÎºÎ¿Î¯Î½Ï‰ÏƒÎ·;')) {
                return;
            }

            try {
                const response = await fetch(`/announcements/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showNotification('Î— Î±Î½Î±ÎºÎ¿Î¯Î½Ï‰ÏƒÎ· Î´Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!', 'success');
                    loadAnnouncements();
                } else {
                    showNotification('Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î· Î´Î¹Î±Î³ÏÎ±Ï†Î® Ï„Î·Ï‚ Î±Î½Î±ÎºÎ¿Î¯Î½Ï‰ÏƒÎ·Ï‚', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î· Î´Î¹Î±Î³ÏÎ±Ï†Î® Ï„Î·Ï‚ Î±Î½Î±ÎºÎ¿Î¯Î½Ï‰ÏƒÎ·Ï‚', 'error');
            }
        }

        // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· notification
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        // Placeholder Î³Î¹Î± ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±
        function editAnnouncement(id) {
            showNotification('Î— Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚ Î¸Î± Ï…Î»Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ ÏƒÏÎ½Ï„Î¿Î¼Î±', 'error');
        }
    </script>
</body>
</html>
