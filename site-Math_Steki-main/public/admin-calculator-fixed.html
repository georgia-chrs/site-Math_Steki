<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î‘ÏÏ‡ÎµÎ¯Ï‰Î½ - Math Steki</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .file-upload {
            border: 2px dashed #ddd;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            border-radius: 8px;
        }
        .upload-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .upload-btn:hover {
            background: #0056b3;
        }
        .preview-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .file-preview {
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .preview-table {
            width: 100%;
            border-collapse: collapse;
        }
        .preview-table th, .preview-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .preview-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î‘ÏÏ‡ÎµÎ¯Ï‰Î½ Î£Ï‡Î¿Î»ÏÎ½</h1>
        
        <div class="file-upload">
            <h3>Î‘Î½Î­Î²Î±ÏƒÎ¼Î± Î±ÏÏ‡ÎµÎ¯Î¿Ï… ÏƒÏ‡Î¿Î»ÏÎ½</h3>
            <div id="status-indicator" style="display: none; margin-bottom: 10px; padding: 8px; background-color: #e8f5e8; color: #2d5a2d; border-radius: 4px; font-size: 14px;">
                ğŸ“ Î¥Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î±Ï€ÏŒ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î· ÏƒÏ…Î½ÎµÎ´ÏÎ¯Î±
            </div>
            <p><strong>Î¥Ï€Î¿ÏƒÏ„Î·ÏÎ¹Î¶ÏŒÎ¼ÎµÎ½Î· Î¼Î¿ÏÏ†Î®:</strong> Tab-separated Î±ÏÏ‡ÎµÎ¯Î± (TSV) Î® Excel (.xlsx, .xls)</p>
            <p><strong>Î‘Ï€Î±Î¹Ï„Î¿ÏÎ¼ÎµÎ½ÎµÏ‚ ÏƒÏ„Î®Î»ÎµÏ‚:</strong> ÎšÎ©Î”Î™ÎšÎŸÎ£ Î£Î§ÎŸÎ›Î—Î£, Î™Î”Î¡Î¥ÎœÎ‘, ÎŸÎÎŸÎœÎ‘ Î£Î§ÎŸÎ›Î—Î£, Î•Î™Î”ÎŸÎ£ Î˜Î•Î£Î—Î£, Î•Î Î™Î£Î¤Î—ÎœÎŸÎÎ™ÎšÎ‘ Î Î•Î”Î™Î‘, ÎœÎ•Î“Î™Î£Î¤Î‘ ÎœÎŸÎ¡Î™Î‘, Î•Î›Î‘Î§Î™Î£Î¤Î‘ ÎœÎŸÎ¡Î™Î‘</p>
            <select id="schools-file-format" style="margin-bottom: 10px;">
                <option value="tsv">TSV Î±ÏÏ‡ÎµÎ¯Î¿ (Tab-separated)</option>
                <option value="excel">Excel Î±ÏÏ‡ÎµÎ¯Î¿ (.xlsx, .xls)</option>
            </select>
            <input type="file" id="schools-csv-file" accept=".tsv,.txt,.csv,.xlsx,.xls">
            <br><br>
            <button class="upload-btn" onclick="uploadSchoolsFile()">Î‘Î½Î­Î²Î±ÏƒÎ¼Î± Î‘ÏÏ‡ÎµÎ¯Î¿Ï…</button>
            <button class="preview-btn" onclick="downloadSampleTSV()">Î›Î®ÏˆÎ· Î”ÎµÎ¯Î³Î¼Î±Ï„Î¿Ï‚ TSV</button>
            <button class="preview-btn" onclick="downloadSampleExcel()">Î›Î®ÏˆÎ· Î”ÎµÎ¯Î³Î¼Î±Ï„Î¿Ï‚ Excel</button>
            <button class="preview-btn" onclick="refreshData()">Î‘Î½Î±Î½Î­Ï‰ÏƒÎ· Î ÏÎ¿Î²Î¿Î»Î®Ï‚</button>
            <button class="preview-btn" onclick="clearStoredData()">Î”Î¹Î±Î³ÏÎ±Ï†Î® Î¥Ï€Î±ÏÏ‡ÏŒÎ½Ï„Ï‰Î½ Î”ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½</button>
        </div>
        
        <div id="schools-csv-preview" class="file-preview" style="display:none;"></div>
        <div id="status-messages"></div>
    </div>

    <script>
        // Global variables
        let parsedSchoolsData = null;

        // Load saved data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedData();
        });

        // Load previously uploaded data from localStorage
        function loadSavedData() {
            console.log('=== Loading saved admin data ===');
            try {
                const savedData = localStorage.getItem('adminUploadedData');
                console.log('Raw localStorage data:', savedData ? 'exists' : 'null');
                
                if (savedData) {
                    const data = JSON.parse(savedData);
                    console.log('Parsed data:', data ? data.length : 'null', 'schools');
                    
                    if (data && Array.isArray(data) && data.length > 0) {
                        parsedSchoolsData = data;
                        console.log('Setting parsedSchoolsData to:', data.length, 'schools');
                        
                        showSchoolsPreview(parsedSchoolsData, 'Î‘Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î±');
                        showMessage(`Î¦Î¿ÏÏ„ÏÎ¸Î·ÎºÎ±Î½ ${data.length} ÏƒÏ‡Î¿Î»Î­Ï‚ Î±Ï€ÏŒ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î· ÏƒÏ…Î½ÎµÎ´ÏÎ¯Î±.`, 'success');
                        
                        // Show indicator that saved data exists
                        const indicator = document.getElementById('status-indicator');
                        if (indicator) {
                            indicator.style.display = 'block';
                            indicator.innerHTML = `ğŸ“ Î¦Î¿ÏÏ„ÏÎ¸Î·ÎºÎ±Î½ ${data.length} ÏƒÏ‡Î¿Î»Î­Ï‚ Î±Ï€ÏŒ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î· ÏƒÏ…Î½ÎµÎ´ÏÎ¯Î±`;
                            console.log('Status indicator updated');
                        } else {
                            console.error('Status indicator element not found');
                        }
                        
                        console.log('Loaded saved admin data:', data.length, 'schools');
                    } else {
                        console.log('Data exists but is invalid or empty');
                        hideStatusIndicator();
                    }
                } else {
                    console.log('No saved data found in localStorage');
                    hideStatusIndicator();
                }
            } catch (error) {
                console.error('Error loading saved data:', error);
                hideStatusIndicator();
            }
        }

        // Hide status indicator
        function hideStatusIndicator() {
            const indicator = document.getElementById('status-indicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }

        // Save data to localStorage for persistence
        function saveDataToLocal(data) {
            console.log('=== Saving data to localStorage ===');
            console.log('Input data:', data ? data.length : 'null', 'schools');
            
            try {
                // Save raw data for admin panel persistence
                localStorage.setItem('adminUploadedData', JSON.stringify(data));
                console.log('Saved raw admin data to localStorage');
                
                // Also save transformed data for moria calculator immediately
                const transformedData = data.map(school => {
                    // Map scientificField to field codes used by moria calculator
                    let fieldCode = 'theoretiko'; // default
                    const sciField = school.scientificField.toLowerCase();
                    
                    if (sciField.includes('Î¸ÎµÏ„Î¹Îº') || sciField.includes('Î¼Î±Î¸Î·Î¼Î±Ï„Î¹Îº') || sciField.includes('Ï†Ï…ÏƒÎ¹Îº')) {
                        fieldCode = 'thetiko';
                    } else if (sciField.includes('Ï„ÎµÏ‡Î½Î¿Î»Î¿Î³Î¹Îº') || sciField.includes('Î¼Î·Ï‡Î±Î½Î¹Îº') || sciField.includes('Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¹Îº')) {
                        fieldCode = 'technologiko';
                    } else if (sciField.includes('Î¿Î¹ÎºÎ¿Î½Î¿Î¼Î¹Îº')) {
                        fieldCode = 'oikonomiko';
                    } else if (sciField.includes('Î¸ÎµÏ‰ÏÎ·Ï„Î¹Îº') || sciField.includes('Ï†Î¹Î»Î¿Î»Î¿Î³') || sciField.includes('Î¹ÏƒÏ„Î¿Ï')) {
                        fieldCode = 'theoretiko';
                    }
                    
                    // Calculate average score from min/max moria
                    const avgScore = school.maxMoria && school.minMoria ? 
                        Math.round((school.maxMoria + school.minMoria) / 2) : 
                        school.maxMoria || school.minMoria || 0;
                    
                    return {
                        id: school.id,
                        name: school.name,
                        university: school.university,
                        field: fieldCode,
                        schoolType: school.positionType.toLowerCase().includes('Î³ÎµÎ»') ? 'gel' : 'epal',
                        avgScore: avgScore,
                        minMoria: school.minMoria || 0,
                        maxMoria: school.maxMoria || 0,
                        positionType: school.positionType,
                        scientificField: school.scientificField
                    };
                });
                
                // Save transformed data for moria calculator
                localStorage.setItem('schoolsCSVData', JSON.stringify(transformedData));
                console.log('Saved transformed data for moria calculator');
                
                console.log('Saved admin data to localStorage (both formats)');
                console.log('Raw data:', data.length, 'schools');
                console.log('Transformed data:', transformedData.length, 'schools');
                console.log('Sample transformed school:', transformedData[0]);
                
                // Verify the data was saved
                const verification = localStorage.getItem('adminUploadedData');
                console.log('Verification: Data saved?', verification ? 'YES' : 'NO');
                
            } catch (error) {
                console.error('Error saving admin data:', error);
            }
        }

        // Main upload function
        function uploadSchoolsFile() {
            const fileInput = document.getElementById('schools-csv-file');
            const formatSelect = document.getElementById('schools-file-format');
            const selectedFormat = formatSelect.value;
            
            if (!fileInput.files[0]) {
                showMessage('Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Î­Î½Î± Î±ÏÏ‡ÎµÎ¯Î¿.', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const fileName = file.name.toLowerCase();
            
            // Auto-detect format based on file extension
            let actualFormat = selectedFormat;
            if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                actualFormat = 'excel';
            } else if (fileName.endsWith('.tsv') || fileName.endsWith('.txt') || fileName.endsWith('.csv')) {
                actualFormat = 'tsv';
            }
            
            if (actualFormat === 'excel') {
                uploadExcelFile(file);
            } else {
                uploadTSVFile(file);
            }
        }

        // Upload TSV/CSV file (tab-separated)
        function uploadTSVFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const tsvText = e.target.result;
                    const schoolsData = parseSchoolsTSV(tsvText);
                    
                    if (schoolsData.length > 0) {
                        parsedSchoolsData = schoolsData;
                        saveDataToLocal(schoolsData); // Save to localStorage
                        showSchoolsPreview(schoolsData, 'TSV');
                        showMessage(`TSV ÎµÏ€ÎµÎ¾ÎµÏÎ³Î¬ÏƒÏ„Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚! Î’ÏÎ­Î¸Î·ÎºÎ±Î½ ${schoolsData.length} ÏƒÏ‡Î¿Î»Î­Ï‚.`, 'success');
                    } else {
                        showMessage('Î¤Î¿ TSV Î±ÏÏ‡ÎµÎ¯Î¿ Î´ÎµÎ½ Ï€ÎµÏÎ¹Î­Ï‡ÎµÎ¹ Î­Î³ÎºÏ…ÏÎ± Î´ÎµÎ´Î¿Î¼Î­Î½Î±.', 'error');
                    }
                } catch (error) {
                    showMessage('Î£Ï†Î¬Î»Î¼Î± ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚ TSV: ' + error.message, 'error');
                    console.error('TSV parsing error:', error);
                }
            };
            reader.onerror = () => showMessage('Î£Ï†Î¬Î»Î¼Î± Î±Î½Î¬Î³Î½Ï‰ÏƒÎ·Ï‚ Î±ÏÏ‡ÎµÎ¯Î¿Ï….', 'error');
            reader.readAsText(file, 'UTF-8');
        }

        // Upload Excel file
        function uploadExcelFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // Use the first sheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convert to JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    
                    if (jsonData.length > 0) {
                        const schoolsData = parseSchoolsExcel(jsonData);
                        parsedSchoolsData = schoolsData;
                        saveDataToLocal(schoolsData); // Save to localStorage
                        showSchoolsPreview(schoolsData, 'Excel');
                        showMessage(`Excel ÎµÏ€ÎµÎ¾ÎµÏÎ³Î¬ÏƒÏ„Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚! Î’ÏÎ­Î¸Î·ÎºÎ±Î½ ${schoolsData.length} ÏƒÏ‡Î¿Î»Î­Ï‚.`, 'success');
                    } else {
                        showMessage('Î¤Î¿ Excel Î±ÏÏ‡ÎµÎ¯Î¿ Î´ÎµÎ½ Ï€ÎµÏÎ¹Î­Ï‡ÎµÎ¹ Î­Î³ÎºÏ…ÏÎ± Î´ÎµÎ´Î¿Î¼Î­Î½Î±.', 'error');
                    }
                    
                } catch (error) {
                    showMessage('Î£Ï†Î¬Î»Î¼Î± ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚ Excel: ' + error.message, 'error');
                    console.error('Excel parsing error:', error);
                }
            };
            reader.onerror = () => showMessage('Î£Ï†Î¬Î»Î¼Î± Î±Î½Î¬Î³Î½Ï‰ÏƒÎ·Ï‚ Î±ÏÏ‡ÎµÎ¯Î¿Ï….', 'error');
            reader.readAsArrayBuffer(file);
        }

        // Parse TSV file with exactly 7 required columns
        function parseSchoolsTSV(tsvText) {
            const lines = tsvText.split('\n').filter(line => line.trim());
            
            if (lines.length < 2) {
                throw new Error('Î¤Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î­Ï‡ÎµÎ¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ Î¼Î¯Î± Î³ÏÎ±Î¼Î¼Î® headers ÎºÎ±Î¹ Î¼Î¯Î± Î³ÏÎ±Î¼Î¼Î® Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½.');
            }
            
            const headers = lines[0].split('\t').map(h => h.trim());
            console.log('TSV headers detected:', headers);
            
            // Validate headers - expect exactly these 7 columns
            const expectedHeaders = ['ÎšÎ©Î”Î™ÎšÎŸÎ£ Î£Î§ÎŸÎ›Î—Î£', 'Î™Î”Î¡Î¥ÎœÎ‘', 'ÎŸÎÎŸÎœÎ‘ Î£Î§ÎŸÎ›Î—Î£', 'Î•Î™Î”ÎŸÎ£ Î˜Î•Î£Î—Î£', 'Î•Î Î™Î£Î¤Î—ÎœÎŸÎÎ™ÎšÎ‘ Î Î•Î”Î™Î‘', 'ÎœÎ•Î“Î™Î£Î¤Î‘ ÎœÎŸÎ¡Î™Î‘', 'Î•Î›Î‘Î§Î™Î£Î¤Î‘ ÎœÎŸÎ¡Î™Î‘'];
            if (headers.length < 7) {
                console.warn(`Warning: Expected 7 columns, found ${headers.length}. Columns: ${headers.join(', ')}`);
            }
            
            const schools = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split('\t').map(v => v.trim());
                
                if (values.length >= 7 && values[0] && values[2]) { // Must have school code and name
                    const school = {
                        id: values[0] || '',                    // ÎšÎ©Î”Î™ÎšÎŸÎ£ Î£Î§ÎŸÎ›Î—Î£
                        university: values[1] || '',            // Î™Î”Î¡Î¥ÎœÎ‘
                        name: values[2] || '',                  // ÎŸÎÎŸÎœÎ‘ Î£Î§ÎŸÎ›Î—Î£
                        positionType: values[3] || '',          // Î•Î™Î”ÎŸÎ£ Î˜Î•Î£Î—Î£
                        scientificField: values[4] || '',       // Î•Î Î™Î£Î¤Î—ÎœÎŸÎÎ™ÎšÎ‘ Î Î•Î”Î™Î‘
                        maxMoria: parseInt(values[5]) || 0,     // ÎœÎ•Î“Î™Î£Î¤Î‘ ÎœÎŸÎ¡Î™Î‘
                        minMoria: parseInt(values[6]) || 0      // Î•Î›Î‘Î§Î™Î£Î¤Î‘ ÎœÎŸÎ¡Î™Î‘
                    };
                    
                    schools.push(school);
                    console.log(`Parsed school: ${school.id} - ${school.name} - ${school.university} - ÎœÏŒÏÎ¹Î±: ${school.minMoria}-${school.maxMoria}`);
                }
            }
            
            console.log(`Successfully parsed ${schools.length} schools from TSV`);
            return schools;
        }

        // Parse Excel data with exactly 7 required columns
        function parseSchoolsExcel(jsonData) {
            const schools = [];
            
            if (jsonData.length < 2) {
                throw new Error('Î¤Î¿ Excel Î±ÏÏ‡ÎµÎ¯Î¿ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î­Ï‡ÎµÎ¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ Î¼Î¯Î± Î³ÏÎ±Î¼Î¼Î® headers ÎºÎ±Î¹ Î¼Î¯Î± Î³ÏÎ±Î¼Î¼Î® Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½.');
            }
            
            const headers = jsonData[0];
            console.log('Excel headers detected:', headers);
            
            // Validate headers - expect exactly these 7 columns
            const expectedHeaders = ['ÎšÎ©Î”Î™ÎšÎŸÎ£ Î£Î§ÎŸÎ›Î—Î£', 'Î™Î”Î¡Î¥ÎœÎ‘', 'ÎŸÎÎŸÎœÎ‘ Î£Î§ÎŸÎ›Î—Î£', 'Î•Î™Î”ÎŸÎ£ Î˜Î•Î£Î—Î£', 'Î•Î Î™Î£Î¤Î—ÎœÎŸÎÎ™ÎšÎ‘ Î Î•Î”Î™Î‘', 'ÎœÎ•Î“Î™Î£Î¤Î‘ ÎœÎŸÎ¡Î™Î‘', 'Î•Î›Î‘Î§Î™Î£Î¤Î‘ ÎœÎŸÎ¡Î™Î‘'];
            if (headers.length < 7) {
                console.warn(`Warning: Expected 7 columns, found ${headers.length}. Columns: ${headers.join(', ')}`);
            }
            
            for (let i = 1; i < jsonData.length; i++) {
                const values = jsonData[i];
                
                if (values && values.length >= 7 && values[0] && values[2]) { // Must have school code and name
                    const school = {
                        id: values[0] ? values[0].toString() : '',              // ÎšÎ©Î”Î™ÎšÎŸÎ£ Î£Î§ÎŸÎ›Î—Î£
                        university: values[1] ? values[1].toString() : '',      // Î™Î”Î¡Î¥ÎœÎ‘
                        name: values[2] ? values[2].toString() : '',            // ÎŸÎÎŸÎœÎ‘ Î£Î§ÎŸÎ›Î—Î£
                        positionType: values[3] ? values[3].toString() : '',    // Î•Î™Î”ÎŸÎ£ Î˜Î•Î£Î—Î£
                        scientificField: values[4] ? values[4].toString() : '', // Î•Î Î™Î£Î¤Î—ÎœÎŸÎÎ™ÎšÎ‘ Î Î•Î”Î™Î‘
                        maxMoria: parseInt(values[5]) || 0,                     // ÎœÎ•Î“Î™Î£Î¤Î‘ ÎœÎŸÎ¡Î™Î‘
                        minMoria: parseInt(values[6]) || 0                      // Î•Î›Î‘Î§Î™Î£Î¤Î‘ ÎœÎŸÎ¡Î™Î‘
                    };
                    
                    schools.push(school);
                    console.log(`Parsed school: ${school.id} - ${school.name} - ${school.university} - ÎœÏŒÏÎ¹Î±: ${school.minMoria}-${school.maxMoria}`);
                }
            }
            
            console.log(`Successfully parsed ${schools.length} schools from Excel`);
            return schools;
        }


        // Show preview for parsed data
        function showSchoolsPreview(schoolsData, fileType) {
            const container = document.getElementById('schools-csv-preview');
            container.style.display = 'block';
            
            const limitedData = schoolsData.slice(0, 10); // Show first 10 rows
            
            let html = `
                <h3>Î ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· Î±ÏÏ‡ÎµÎ¯Î¿Ï… ${fileType} (${schoolsData.length} ÏƒÏ…Î½Î¿Î»Î¹ÎºÎ¬ ÏƒÏ‡Î¿Î»Î­Ï‚, ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ· Ï€ÏÏÏ„Ï‰Î½ 10)</h3>
                <div style="overflow-x: auto;">
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th>ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ Î£Ï‡Î¿Î»Î®Ï‚</th>
                                <th>ÎŠÎ´ÏÏ…Î¼Î±</th>
                                <th>ÎŒÎ½Î¿Î¼Î± Î£Ï‡Î¿Î»Î®Ï‚</th>
                                <th>Î•Î¯Î´Î¿Ï‚ Î˜Î­ÏƒÎ·Ï‚</th>
                                <th>Î•Ï€Î¹ÏƒÏ„Î·Î¼Î¿Î½Î¹ÎºÎ¬ Î ÎµÎ´Î¯Î±</th>
                                <th>ÎœÎ­Î³Î¹ÏƒÏ„Î± ÎœÏŒÏÎ¹Î±</th>
                                <th>Î•Î»Î¬Ï‡Î¹ÏƒÏ„Î± ÎœÏŒÏÎ¹Î±</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            limitedData.forEach(school => {
                html += `
                    <tr>
                        <td>${school.id || 'N/A'}</td>
                        <td>${school.university || 'N/A'}</td>
                        <td>${school.name || 'N/A'}</td>
                        <td>${school.positionType || 'N/A'}</td>
                        <td>${school.scientificField || 'N/A'}</td>
                        <td>${school.maxMoria || 'N/A'}</td>
                        <td>${school.minMoria || 'N/A'}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 15px;">
                    <button class="upload-btn" onclick="confirmSchoolsUpload()">Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ· & Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
                    <button class="upload-btn" onclick="downloadProcessedDataAsExcel()">ÎšÎ±Ï„Î­Î²Î±ÏƒÎ¼Î± Ï‰Ï‚ Excel</button>
                    <button class="preview-btn" onclick="cancelUpload()">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Clear existing data before new upload
        function clearStoredData() {
            try {
                localStorage.removeItem('schoolsCSVData'); // Clear moria calculator data
                localStorage.removeItem('adminUploadedData'); // Clear admin panel data
                
                // Clear current session data
                parsedSchoolsData = null;
                document.getElementById('schools-csv-preview').style.display = 'none';
                document.getElementById('schools-csv-file').value = '';
                hideStatusIndicator();
                
                showMessage('ÎŒÎ»Î± Ï„Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î´Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎ±Î½ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚.', 'success');
                console.log('Cleared all stored data from localStorage');
            } catch (error) {
                showMessage('Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î· Î´Î¹Î±Î³ÏÎ±Ï†Î® Ï„Ï‰Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½.', 'error');
                console.error('Error clearing localStorage:', error);
            }
        }

        // Refresh data display without clearing
        function refreshData() {
            loadSavedData();
            showMessage('Î— Ï€ÏÎ¿Î²Î¿Î»Î® Î±Î½Î±Î½ÎµÏÎ¸Î·ÎºÎµ Î¼Îµ Ï„Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î±.', 'success');
        }

        // Confirm upload and save data
        function confirmSchoolsUpload() {
            if (!parsedSchoolsData) {
                showMessage('Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î³Î¹Î± Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·.', 'error');
                return;
            }
            
            // The data transformation is already done in saveDataToLocal (called during parsing)
            // Just show success message
            showMessage(`Î¤Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎ±Î½ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚! ${parsedSchoolsData.length} ÏƒÏ‡Î¿Î»Î­Ï‚. Î¤Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± ÎµÎ¯Î½Î±Î¹ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î± ÏƒÏ„Î¿Î½ Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÏ„Î® Î¼Î¿ÏÎ¯Ï‰Î½.`, 'success');
            console.log('Confirmed data save:', parsedSchoolsData.length, 'schools');
            
            // Hide preview
            document.getElementById('schools-csv-preview').style.display = 'none';
        }

        // Cancel upload
        function cancelUpload() {
            parsedSchoolsData = null;
            document.getElementById('schools-csv-preview').style.display = 'none';
            document.getElementById('schools-csv-file').value = '';
            showMessage('Î¤Î¿ Î±Î½Î­Î²Î±ÏƒÎ¼Î± Î±ÎºÏ…ÏÏÎ¸Î·ÎºÎµ.', 'error');
        }

        // Download processed data as Excel
        function downloadProcessedDataAsExcel() {
            if (!parsedSchoolsData) {
                showMessage('Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î³Î¹Î± ÎºÎ±Ï„Î­Î²Î±ÏƒÎ¼Î±.', 'error');
                return;
            }
            
            const ws = XLSX.utils.json_to_sheet(parsedSchoolsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Î£Ï‡Î¿Î»Î­Ï‚");
            XLSX.writeFile(wb, "processed_schools.xlsx");
            showMessage('Î¤Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ ÎºÎ±Ï„Î­Î²Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!', 'success');
        }

        // Download sample TSV file with exactly 7 columns
        function downloadSampleTSV() {
            const sampleData = `ÎšÎ©Î”Î™ÎšÎŸÎ£ Î£Î§ÎŸÎ›Î—Î£\tÎ™Î”Î¡Î¥ÎœÎ‘\tÎŸÎÎŸÎœÎ‘ Î£Î§ÎŸÎ›Î—Î£\tÎ•Î™Î”ÎŸÎ£ Î˜Î•Î£Î—Î£\tÎ•Î Î™Î£Î¤Î—ÎœÎŸÎÎ™ÎšÎ‘ Î Î•Î”Î™Î‘\tÎœÎ•Î“Î™Î£Î¤Î‘ ÎœÎŸÎ¡Î™Î‘\tÎ•Î›Î‘Î§Î™Î£Î¤Î‘ ÎœÎŸÎ¡Î™Î‘
101\tÎ Î±Î½ÎµÏ€Î¹ÏƒÏ„Î®Î¼Î¹Î¿ Î‘Î¸Î·Î½ÏÎ½\tÎ¦Î¹Î»Î¿Î»Î¿Î³Î¯Î±Ï‚\tÎ“Î•Î›\tÎ˜ÎµÏ‰ÏÎ·Ï„Î¹ÎºÎ® ÎšÎ±Ï„ÎµÏÎ¸Ï…Î½ÏƒÎ·\t19500\t16800
102\tÎ‘ÏÎ¹ÏƒÏ„Î¿Ï„Î­Î»ÎµÎ¹Î¿ Î Î±Î½ÎµÏ€Î¹ÏƒÏ„Î®Î¼Î¹Î¿ Î˜ÎµÏƒÏƒÎ±Î»Î¿Î½Î¯ÎºÎ·Ï‚\tÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÏÎ½\tÎ“Î•Î›\tÎ˜ÎµÏ„Î¹ÎºÎ® ÎšÎ±Ï„ÎµÏÎ¸Ï…Î½ÏƒÎ·\t18750\t15200
103\tÎ Î±Î½ÎµÏ€Î¹ÏƒÏ„Î®Î¼Î¹Î¿ Î Î¬Ï„ÏÎ±Ï‚\tÎœÎ·Ï‡Î±Î½Î¹ÎºÏÎ½ Î—/Î¥\tÎ“Î•Î›\tÎ¤ÎµÏ‡Î½Î¿Î»Î¿Î³Î¹ÎºÎ® ÎšÎ±Ï„ÎµÏÎ¸Ï…Î½ÏƒÎ·\t17900\t14500
201\tÎ¤Î•Î™ Î‘Î¸Î®Î½Î±Ï‚\tÎ•Ï€Î¹Ï‡ÎµÎ¹ÏÎ·Î¼Î±Ï„Î¹ÎºÏŒÏ„Î·Ï„Î±Ï‚\tÎ•Î Î‘Î›\tÎŸÎ¹ÎºÎ¿Î½Î¿Î¼Î¹ÎºÎ® ÎšÎ±Ï„ÎµÏÎ¸Ï…Î½ÏƒÎ·\t16200\t12800
202\tÎ¤Î•Î™ Î˜ÎµÏƒÏƒÎ±Î»Î¿Î½Î¯ÎºÎ·Ï‚\tÎ Î»Î·ÏÎ¿Ï†Î¿ÏÎ¹ÎºÎ®Ï‚\tÎ•Î Î‘Î›\tÎ¤ÎµÏ‡Î½Î¿Î»Î¿Î³Î¹ÎºÎ® ÎšÎ±Ï„ÎµÏÎ¸Ï…Î½ÏƒÎ·\t15800\t11900
G001\tÎ•Î¸Î½Î¹ÎºÏŒ ÎšÎ±Ï€Î¿Î´Î¹ÏƒÏ„ÏÎ¹Î±ÎºÏŒ Î Î±Î½ÎµÏ€Î¹ÏƒÏ„Î®Î¼Î¹Î¿ Î‘Î¸Î·Î½ÏÎ½\tÎ™Î±Ï„ÏÎ¹ÎºÎ®\tÎ“Î•Î›\tÎ˜ÎµÏ„Î¹ÎºÎ® ÎšÎ±Ï„ÎµÏÎ¸Ï…Î½ÏƒÎ·\t21500\t19800
G002\tÎ‘ÏÎ¹ÏƒÏ„Î¿Ï„Î­Î»ÎµÎ¹Î¿ Î Î±Î½ÎµÏ€Î¹ÏƒÏ„Î®Î¼Î¹Î¿ Î˜ÎµÏƒÏƒÎ±Î»Î¿Î½Î¯ÎºÎ·Ï‚\tÎŸÎ´Î¿Î½Ï„Î¹Î±Ï„ÏÎ¹ÎºÎ®\tÎ“Î•Î›\tÎ˜ÎµÏ„Î¹ÎºÎ® ÎšÎ±Ï„ÎµÏÎ¸Ï…Î½ÏƒÎ·\t21000\t19000
E001\tÎ¤Î•Î™ Î‘Î¸Î®Î½Î±Ï‚\tÎœÎ·Ï‡Î±Î½Î¿Î»Î¿Î³Î¯Î±\tÎ•Î Î‘Î›\tÎ¤ÎµÏ‡Î½Î¿Î»Î¿Î³Î¹ÎºÎ® ÎšÎ±Ï„ÎµÏÎ¸Ï…Î½ÏƒÎ·\t16500\t13000`;
            
            const blob = new Blob([sampleData], { type: 'text/tab-separated-values' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sample_schools_7_columns.tsv';
            a.click();
            window.URL.revokeObjectURL(url);
            showMessage('Î¤Î¿ Î´ÎµÎ¯Î³Î¼Î± TSV ÎºÎ±Ï„Î­Î²Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!', 'success');
        }

        // Download sample Excel file with exactly 7 columns
        function downloadSampleExcel() {
            const sampleData = [
                ['ÎšÎ©Î”Î™ÎšÎŸÎ£ Î£Î§ÎŸÎ›Î—Î£', 'Î™Î”Î¡Î¥ÎœÎ‘', 'ÎŸÎÎŸÎœÎ‘ Î£Î§ÎŸÎ›Î—Î£', 'Î•Î™Î”ÎŸÎ£ Î˜Î•Î£Î—Î£', 'Î•Î Î™Î£Î¤Î—ÎœÎŸÎÎ™ÎšÎ‘ Î Î•Î”Î™Î‘', 'ÎœÎ•Î“Î™Î£Î¤Î‘ ÎœÎŸÎ¡Î™Î‘', 'Î•Î›Î‘Î§Î™Î£Î¤Î‘ ÎœÎŸÎ¡Î™Î‘'],
                ['101', 'Î Î±Î½ÎµÏ€Î¹ÏƒÏ„Î®Î¼Î¹Î¿ Î‘Î¸Î·Î½ÏÎ½', 'Î¦Î¹Î»Î¿Î»Î¿Î³Î¯Î±Ï‚', 'Î“Î•Î›', 'Î˜ÎµÏ‰ÏÎ·Ï„Î¹ÎºÎ® ÎšÎ±Ï„ÎµÏÎ¸Ï…Î½ÏƒÎ·', 19500, 16800],
                ['102', 'Î‘ÏÎ¹ÏƒÏ„Î¿Ï„Î­Î»ÎµÎ¹Î¿ Î Î±Î½ÎµÏ€Î¹ÏƒÏ„Î®Î¼Î¹Î¿ Î˜ÎµÏƒÏƒÎ±Î»Î¿Î½Î¯ÎºÎ·Ï‚', 'ÎœÎ±Î¸Î·Î¼Î±Ï„Î¹ÎºÏÎ½', 'Î“Î•Î›', 'Î˜ÎµÏ„Î¹ÎºÎ® ÎšÎ±Ï„ÎµÏÎ¸Ï…Î½ÏƒÎ·', 18750, 15200],
                ['103', 'Î Î±Î½ÎµÏ€Î¹ÏƒÏ„Î®Î¼Î¹Î¿ Î Î¬Ï„ÏÎ±Ï‚', 'ÎœÎ·Ï‡Î±Î½Î¹ÎºÏÎ½ Î—/Î¥', 'Î“Î•Î›', 'Î¤ÎµÏ‡Î½Î¿Î»Î¿Î³Î¹ÎºÎ® ÎšÎ±Ï„ÎµÏÎ¸Ï…Î½ÏƒÎ·', 17900, 14500],
                ['201', 'Î¤Î•Î™ Î‘Î¸Î®Î½Î±Ï‚', 'Î•Ï€Î¹Ï‡ÎµÎ¹ÏÎ·Î¼Î±Ï„Î¹ÎºÏŒÏ„Î·Ï„Î±Ï‚', 'Î•Î Î‘Î›', 'ÎŸÎ¹ÎºÎ¿Î½Î¿Î¼Î¹ÎºÎ® ÎšÎ±Ï„ÎµÏÎ¸Ï…Î½ÏƒÎ·', 16200, 12800],
                ['202', 'Î¤Î•Î™ Î˜ÎµÏƒÏƒÎ±Î»Î¿Î½Î¯ÎºÎ·Ï‚', 'Î Î»Î·ÏÎ¿Ï†Î¿ÏÎ¹ÎºÎ®Ï‚', 'Î•Î Î‘Î›', 'Î¤ÎµÏ‡Î½Î¿Î»Î¿Î³Î¹ÎºÎ® ÎšÎ±Ï„ÎµÏÎ¸Ï…Î½ÏƒÎ·', 15800, 11900],
                ['G001', 'Î•Î¸Î½Î¹ÎºÏŒ ÎšÎ±Ï€Î¿Î´Î¹ÏƒÏ„ÏÎ¹Î±ÎºÏŒ Î Î±Î½ÎµÏ€Î¹ÏƒÏ„Î®Î¼Î¹Î¿ Î‘Î¸Î·Î½ÏÎ½', 'Î™Î±Ï„ÏÎ¹ÎºÎ®', 'Î“Î•Î›', 'Î˜ÎµÏ„Î¹ÎºÎ® ÎšÎ±Ï„ÎµÏÎ¸Ï…Î½ÏƒÎ·', 21500, 19800],
                ['G002', 'Î‘ÏÎ¹ÏƒÏ„Î¿Ï„Î­Î»ÎµÎ¹Î¿ Î Î±Î½ÎµÏ€Î¹ÏƒÏ„Î®Î¼Î¹Î¿ Î˜ÎµÏƒÏƒÎ±Î»Î¿Î½Î¯ÎºÎ·Ï‚', 'ÎŸÎ´Î¿Î½Ï„Î¹Î±Ï„ÏÎ¹ÎºÎ®', 'Î“Î•Î›', 'Î˜ÎµÏ„Î¹ÎºÎ® ÎšÎ±Ï„ÎµÏÎ¸Ï…Î½ÏƒÎ·', 21000, 19000],
                ['E001', 'Î¤Î•Î™ Î‘Î¸Î®Î½Î±Ï‚', 'ÎœÎ·Ï‡Î±Î½Î¿Î»Î¿Î³Î¯Î±', 'Î•Î Î‘Î›', 'Î¤ÎµÏ‡Î½Î¿Î»Î¿Î³Î¹ÎºÎ® ÎšÎ±Ï„ÎµÏÎ¸Ï…Î½ÏƒÎ·', 16500, 13000]
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(sampleData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Î”ÎµÎ¯Î³Î¼Î± Î£Ï‡Î¿Î»ÏÎ½");
            XLSX.writeFile(wb, "sample_schools_7_columns.xlsx");
            showMessage('Î¤Î¿ Î´ÎµÎ¯Î³Î¼Î± Excel ÎºÎ±Ï„Î­Î²Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!', 'success');
        }

        // Show message
        function showMessage(message, type) {
            const container = document.getElementById('status-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            
            container.innerHTML = '';
            container.appendChild(messageDiv);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 5000);
        }
    </script>
</body>
</html>
