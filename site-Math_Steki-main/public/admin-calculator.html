<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î£Ï‡Î¿Î»ÏÎ½ - Admin Panel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background: #f5f5f5; 
            margin: 0; 
            padding: 20px; 
        }
        .admin-container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: #fff; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 0 20px rgba(0,0,0,0.1); 
        }
        h1 { 
            color: #5b3c2a; 
            text-align: center; 
            margin-bottom: 30px; 
        }
        .school-type-section { 
            margin-bottom: 40px; 
            padding: 25px; 
            border: 2px solid #ddd; 
            border-radius: 12px;
            background: #fafafa;
        }
        .school-type-section h2 { 
            color: #5b3c2a; 
            margin-top: 0;
            border-bottom: 2px solid #5b3c2a;
            padding-bottom: 10px;
        }
        .file-upload { 
            margin: 20px 0; 
            padding: 20px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            text-align: center;
        }
        .file-upload label { 
            display: block; 
            margin-bottom: 10px; 
            font-weight: bold;
            color: #333;
        }
        .file-upload input[type="file"] { 
            margin: 10px 0;
            padding: 10px; 
            border: 1px solid #ccc; 
            border-radius: 5px; 
        }
        .upload-btn { 
            background: #5b3c2a; 
            color: #fff; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin-top: 10px; 
        }
        .upload-btn:hover { 
            opacity: 0.9; 
        }
        .current-files { 
            background: #f9f9f9; 
            padding: 15px; 
            border-radius: 5px; 
            margin: 15px 0; 
        }
        .current-files h3 { 
            margin-top: 0; 
            color: #666; 
        }
        .file-list { 
            list-style: none; 
            padding: 0; 
        }
        .file-list li { 
            padding: 5px 0; 
            border-bottom: 1px solid #eee; 
        }
        .preview-btn { 
            background: #17a2b8; 
            color: #fff; 
            border: none; 
            padding: 5px 10px; 
            border-radius: 3px; 
            cursor: pointer; 
            margin-left: 10px; 
        }
        .file-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        .message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .preview-table th, .preview-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .preview-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .template-section {
            margin-bottom: 40px;
            padding: 25px;
            border: 2px solid #007bff;
            border-radius: 12px;
            background: #f8f9ff;
        }
        .template-section h2 {
            color: #007bff;
            margin-top: 0;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .template-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .template-info {
            flex-grow: 1;
        }
        .template-actions {
            display: flex;
            gap: 10px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn:hover {
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <h1>Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î£Ï‡Î¿Î»ÏÎ½ - Admin Panel</h1>
        
        <!-- Excel Templates Section -->
        <div class="template-section">
            <h2> Excel Templates Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ·</h2>
            
            <div class="file-upload">
                <label for="template-file">Î‘Î½Î­Î²Î±ÏƒÎ¼Î± Î½Î­Î¿Ï… Excel Template:</label>
                <p><strong>Î¥Ï€Î¿ÏƒÏ„Î·ÏÎ¹Î¶ÏŒÎ¼ÎµÎ½ÎµÏ‚ Î¼Î¿ÏÏ†Î­Ï‚:</strong> Excel (.xlsx, .xls)</p>
                
                <select id="template-type" style="margin-bottom: 10px; padding: 8px; border-radius: 4px;">
                    <option value="">Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„ÏÏ€Î¿ template...</option>
                    <option value="anthropistikes">Î‘Î½Î¸ÏÏ‰Ï€Î¹ÏƒÏ„Î¹ÎºÎ­Ï‚ Î•Ï€Î¹ÏƒÏ„Î®Î¼ÎµÏ‚</option>
                    <option value="thetikes">Î˜ÎµÏ„Î¹ÎºÎ­Ï‚ Î•Ï€Î¹ÏƒÏ„Î®Î¼ÎµÏ‚</option>
                    <option value="oikonomikes">ÎŸÎ¹ÎºÎ¿Î½Î¿Î¼Î¹ÎºÎ­Ï‚ Î•Ï€Î¹ÏƒÏ„Î®Î¼ÎµÏ‚</option>
                    <option value="epal">Î•Î Î‘Î›</option>
                    <option value="kales-texnes">ÎšÎ±Î»Î­Ï‚ Î¤Î­Ï‡Î½ÎµÏ‚</option>
                    <option value="other">Î†Î»Î»Î¿</option>
                </select>
                
                <input type="file" id="template-file" accept=".xlsx,.xls" style="margin: 10px 0;">
                <button onclick="uploadTemplate()" class="btn btn-primary">Î‘Î½Î­Î²Î±ÏƒÎ¼Î± Template</button>
            </div>
            
            <div id="templates-list">
                <h3>Î¥Ï€Î¬ÏÏ‡Î¿Î½Ï„Î± Templates:</h3>
                <div id="templates-container">
                    <p>Î¦ÏŒÏÏ„Ï‰ÏƒÎ· templates...</p>
                </div>
            </div>
            
            <div id="template-stats">
                <h3>Î£Ï„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬ Templates:</h3>
                <div id="stats-container">
                    <p>Î¦ÏŒÏÏ„Ï‰ÏƒÎ· ÏƒÏ„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏÎ½...</p>
                </div>
            </div>
        </div>
        
        <!-- Î“Î•Î› Î£Ï‡Î¿Î»Î­Ï‚ -->
        <div class="school-type-section">
            <h2>ğŸ“ Î“Î•Î› - Î“ÎµÎ½Î¹ÎºÏŒ Î›ÏÎºÎµÎ¹Î¿</h2>
            <div class="file-upload">
                <label for="gel-file">Î‘Î½Î­Î²Î±ÏƒÎ¼Î± Î±ÏÏ‡ÎµÎ¯Î¿Ï… ÏƒÏ‡Î¿Î»ÏÎ½ Î“Î•Î›:</label>
                <p><strong>Î¥Ï€Î¿ÏƒÏ„Î·ÏÎ¹Î¶ÏŒÎ¼ÎµÎ½ÎµÏ‚ Î¼Î¿ÏÏ†Î­Ï‚:</strong> TSV (Tab-separated), Excel (.xlsx, .xls)</p>
                <p><strong>Î‘Ï€Î±Î¹Ï„Î¿ÏÎ¼ÎµÎ½ÎµÏ‚ ÏƒÏ„Î®Î»ÎµÏ‚:</strong> ÎšÎ©Î”Î™ÎšÎŸÎ£ Î£Î§ÎŸÎ›Î—Î£, Î™Î”Î¡Î¥ÎœÎ‘, ÎŸÎÎŸÎœÎ‘ Î£Î§ÎŸÎ›Î—Î£, ÎœÎ•Î“Î™Î£Î¤Î‘ ÎœÎŸÎ¡Î™Î‘, Î•Î›Î‘Î§Î™Î£Î¤Î‘ ÎœÎŸÎ¡Î™Î‘</p>
                <select id="gel-file-format" style="margin-bottom: 10px;">
                    <option value="tsv">TSV Î±ÏÏ‡ÎµÎ¯Î¿ (Tab-separated)</option>
                    <option value="excel">Excel Î±ÏÏ‡ÎµÎ¯Î¿ (.xlsx, .xls)</option>
                </select>
                <input type="file" id="gel-file" accept=".tsv,.txt,.csv,.xlsx,.xls">
                <button class="upload-btn" onclick="uploadGELFile()">Î‘Î½Î­Î²Î±ÏƒÎ¼Î± Î‘ÏÏ‡ÎµÎ¯Î¿Ï… Î“Î•Î›</button>
                <button class="preview-btn" onclick="downloadSampleGEL()">Î›Î®ÏˆÎ· Î”ÎµÎ¯Î³Î¼Î±Ï„Î¿Ï‚</button>
            </div>
            
            <div id="gel-preview" class="file-preview" style="display:none;"></div>
            
            <div class="current-files">
                <h3>Î¤ÏÎ­Ï‡Î¿Î½ Î±ÏÏ‡ÎµÎ¯Î¿ Î“Î•Î›:</h3>
                <ul class="file-list">
                    <li id="current-gel-file">Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ Î±Î½Î­Î²ÎµÎ¹ Î±ÏÏ‡ÎµÎ¯Î¿ Î“Î•Î›</li>
                </ul>
            </div>
        </div>

        <!-- Î•Î Î‘Î› Î£Ï‡Î¿Î»Î­Ï‚ -->
        <div class="school-type-section">
            <h2>ğŸ”§ Î•Î Î‘Î› - Î•Ï€Î±Î³Î³ÎµÎ»Î¼Î±Ï„Î¹ÎºÏŒ Î›ÏÎºÎµÎ¹Î¿</h2>
            <div class="file-upload">
                <label for="epal-file">Î‘Î½Î­Î²Î±ÏƒÎ¼Î± Î±ÏÏ‡ÎµÎ¯Î¿Ï… ÏƒÏ‡Î¿Î»ÏÎ½ Î•Î Î‘Î›:</label>
                <p><strong>Î¥Ï€Î¿ÏƒÏ„Î·ÏÎ¹Î¶ÏŒÎ¼ÎµÎ½ÎµÏ‚ Î¼Î¿ÏÏ†Î­Ï‚:</strong> TSV (Tab-separated), Excel (.xlsx, .xls)</p>
                <p><strong>Î‘Ï€Î±Î¹Ï„Î¿ÏÎ¼ÎµÎ½ÎµÏ‚ ÏƒÏ„Î®Î»ÎµÏ‚:</strong> ÎšÎ©Î”Î™ÎšÎŸÎ£ Î£Î§ÎŸÎ›Î—Î£, Î™Î”Î¡Î¥ÎœÎ‘, ÎŸÎÎŸÎœÎ‘ Î£Î§ÎŸÎ›Î—Î£, ÎœÎ•Î“Î™Î£Î¤Î‘ ÎœÎŸÎ¡Î™Î‘, Î•Î›Î‘Î§Î™Î£Î¤Î‘ ÎœÎŸÎ¡Î™Î‘</p>
                <select id="epal-file-format" style="margin-bottom: 10px;">
                    <option value="tsv">TSV Î±ÏÏ‡ÎµÎ¯Î¿ (Tab-separated)</option>
                    <option value="excel">Excel Î±ÏÏ‡ÎµÎ¯Î¿ (.xlsx, .xls)</option>
                </select>
                <input type="file" id="epal-file" accept=".tsv,.txt,.csv,.xlsx,.xls">
                <button class="upload-btn" onclick="uploadEPALFile()">Î‘Î½Î­Î²Î±ÏƒÎ¼Î± Î‘ÏÏ‡ÎµÎ¯Î¿Ï… Î•Î Î‘Î›</button>
                <button class="preview-btn" onclick="downloadSampleEPAL()">Î›Î®ÏˆÎ· Î”ÎµÎ¯Î³Î¼Î±Ï„Î¿Ï‚</button>
            </div>
            
            <div id="epal-preview" class="file-preview" style="display:none;"></div>
            
            <div class="current-files">
                <h3>Î¤ÏÎ­Ï‡Î¿Î½ Î±ÏÏ‡ÎµÎ¯Î¿ Î•Î Î‘Î›:</h3>
                <ul class="file-list">
                    <li id="current-epal-file">Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ Î±Î½Î­Î²ÎµÎ¹ Î±ÏÏ‡ÎµÎ¯Î¿ Î•Î Î‘Î›</li>
                </ul>
            </div>
        </div>

        <div id="status-messages"></div>
    </div>

    <script>
        // Global variables
        let gelData = null;
        let epalData = null;

        // Upload GEL file
        function uploadGELFile() {
            const fileInput = document.getElementById('gel-file');
            const formatSelect = document.getElementById('gel-file-format');
            
            if (!fileInput.files[0]) {
                showMessage('Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Î­Î½Î± Î±ÏÏ‡ÎµÎ¯Î¿ Î“Î•Î›.', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const fileName = file.name.toLowerCase();
            let actualFormat = formatSelect.value;
            
            // Auto-detect format
            if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                actualFormat = 'excel';
            } else if (fileName.endsWith('.tsv') || fileName.endsWith('.txt') || fileName.endsWith('.csv')) {
                actualFormat = 'tsv';
            }
            
            if (actualFormat === 'excel') {
                uploadExcelFile(file, 'gel');
            } else {
                uploadTSVFile(file, 'gel');
            }
        }

        // Upload EPAL file
        function uploadEPALFile() {
            const fileInput = document.getElementById('epal-file');
            const formatSelect = document.getElementById('epal-file-format');
            
            if (!fileInput.files[0]) {
                showMessage('Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Î­Î½Î± Î±ÏÏ‡ÎµÎ¯Î¿ Î•Î Î‘Î›.', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const fileName = file.name.toLowerCase();
            let actualFormat = formatSelect.value;
            
            // Auto-detect format
            if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                actualFormat = 'excel';
            } else if (fileName.endsWith('.tsv') || fileName.endsWith('.txt') || fileName.endsWith('.csv')) {
                actualFormat = 'tsv';
            }
            
            if (actualFormat === 'excel') {
                uploadExcelFile(file, 'epal');
            } else {
                uploadTSVFile(file, 'epal');
            }
        }

        // Upload TSV file for specific school type
        async function uploadTSVFile(file, schoolType) {
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const tsvText = e.target.result;
                    const schoolsData = parseSchoolsTSV(tsvText);
                    
                    if (schoolsData.length > 0) {
                        // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Ï„Î¿Ï… schoolType ÎºÎ±Î¹ Î¬Î»Î»Ï‰Î½ Î±Ï€Î±ÏÎ±Î¯Ï„Î·Ï„Ï‰Î½ Ï€ÎµÎ´Î¯Ï‰Î½ ÏƒÏ„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î±
                        const enhancedData = schoolsData.map(school => {
                            // Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î¿Ï‚ Ï€ÏÎ¿ÏƒÎ´Î¹Î¿ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Ï„Î¿Ï… field Î²Î¬ÏƒÎµÎ¹ Ï„Î¿Ï… scientificField
                            let field = 'theoretiko'; // default
                            const scientificField = (school.scientificField || '').toLowerCase();
                            
                            if (schoolType === 'gel') {
                                if (scientificField.includes('Î¸ÎµÏ„Î¹Îº') || scientificField.includes('Î¼Î±Î¸Î·Î¼Î±Ï„Î¹Îº') || scientificField.includes('Ï†Ï…ÏƒÎ¹Îº')) {
                                    field = 'thetiko';
                                } else if (scientificField.includes('Î¿Î¹ÎºÎ¿Î½Î¿Î¼') || scientificField.includes('Î´Î¹Î¿Î¹ÎºÎ·Ï„')) {
                                    field = 'oikonomiko';
                                } else if (scientificField.includes('Ï„ÎµÏ‡Î½Î¿Î»Î¿Î³')) {
                                    field = 'technologiko';
                                } else {
                                    field = 'theoretiko';
                                }
                            } else { // epal
                                if (scientificField.includes('Ï€Î»Î·ÏÎ¿Ï†Î¿Ï') || scientificField.includes('Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÏ„')) {
                                    field = 'pliroforiki';
                                } else if (scientificField.includes('Î¼Î·Ï‡Î±Î½Î¿Î»Î¿Î³') || scientificField.includes('Î¼Î·Ï‡Î±Î½Î¹Îº')) {
                                    field = 'mixanologia';
                                } else {
                                    field = 'pliroforiki'; // default Î³Î¹Î± Î•Î Î‘Î›
                                }
                            }
                            
                            return {
                                ...school,
                                schoolType: schoolType,
                                field: field,
                                avgScore: Math.round((school.minMoria + school.maxMoria) / 2) || 15000
                            };
                        });
                        
                        // Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® ÏƒÏ„Î¿ backend
                        const success = await saveSchoolsDataToServer(enhancedData);
                        
                        if (success) {
                            if (schoolType === 'gel') {
                                gelData = enhancedData;
                                showSchoolsPreview(enhancedData, 'Î“Î•Î›', 'gel-preview');
                                document.getElementById('current-gel-file').textContent = 
                                    `${file.name} - ${enhancedData.length} ÏƒÏ‡Î¿Î»Î­Ï‚ (Î‘Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½Î¿)`;
                            } else {
                                epalData = enhancedData;
                                showSchoolsPreview(enhancedData, 'Î•Î Î‘Î›', 'epal-preview');
                                document.getElementById('current-epal-file').textContent = 
                                    `${file.name} - ${enhancedData.length} ÏƒÏ‡Î¿Î»Î­Ï‚ (Î‘Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½Î¿)`;
                            }
                            showMessage(`${schoolType.toUpperCase()} TSV ÎµÏ€ÎµÎ¾ÎµÏÎ³Î¬ÏƒÏ„Î·ÎºÎµ ÎºÎ±Î¹ Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚! Î’ÏÎ­Î¸Î·ÎºÎ±Î½ ${enhancedData.length} ÏƒÏ‡Î¿Î»Î­Ï‚.`, 'success');
                        } else {
                            showMessage('Î£Ï†Î¬Î»Î¼Î± Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·Ï‚ ÏƒÏ„Î· Î²Î¬ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½.', 'error');
                        }
                    } else {
                        showMessage('Î¤Î¿ TSV Î±ÏÏ‡ÎµÎ¯Î¿ Î´ÎµÎ½ Ï€ÎµÏÎ¹Î­Ï‡ÎµÎ¹ Î­Î³ÎºÏ…ÏÎ± Î´ÎµÎ´Î¿Î¼Î­Î½Î±.', 'error');
                    }
                } catch (error) {
                    showMessage('Î£Ï†Î¬Î»Î¼Î± ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚ TSV: ' + error.message, 'error');
                    console.error('TSV parsing error:', error);
                }
            };
            reader.onerror = () => showMessage('Î£Ï†Î¬Î»Î¼Î± Î±Î½Î¬Î³Î½Ï‰ÏƒÎ·Ï‚ Î±ÏÏ‡ÎµÎ¯Î¿Ï….', 'error');
            reader.readAsText(file, 'UTF-8');
        }

        // Upload Excel file for specific school type
        async function uploadExcelFile(file, schoolType) {
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    
                    if (jsonData.length > 0) {
                        const schoolsData = parseSchoolsExcel(jsonData);
                        
                        // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Ï„Î¿Ï… schoolType ÎºÎ±Î¹ Î¬Î»Î»Ï‰Î½ Î±Ï€Î±ÏÎ±Î¯Ï„Î·Ï„Ï‰Î½ Ï€ÎµÎ´Î¯Ï‰Î½ ÏƒÏ„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î±
                        const enhancedData = schoolsData.map(school => {
                            // Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î¿Ï‚ Ï€ÏÎ¿ÏƒÎ´Î¹Î¿ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Ï„Î¿Ï… field Î²Î¬ÏƒÎµÎ¹ Ï„Î¿Ï… scientificField
                            let field = 'theoretiko'; // default
                            const scientificField = (school.scientificField || '').toLowerCase();
                            
                            if (schoolType === 'gel') {
                                if (scientificField.includes('Î¸ÎµÏ„Î¹Îº') || scientificField.includes('Î¼Î±Î¸Î·Î¼Î±Ï„Î¹Îº') || scientificField.includes('Ï†Ï…ÏƒÎ¹Îº')) {
                                    field = 'thetiko';
                                } else if (scientificField.includes('Î¿Î¹ÎºÎ¿Î½Î¿Î¼') || scientificField.includes('Î´Î¹Î¿Î¹ÎºÎ·Ï„')) {
                                    field = 'oikonomiko';
                                } else if (scientificField.includes('Ï„ÎµÏ‡Î½Î¿Î»Î¿Î³')) {
                                    field = 'technologiko';
                                } else {
                                    field = 'theoretiko';
                                }
                            } else { // epal
                                if (scientificField.includes('Ï€Î»Î·ÏÎ¿Ï†Î¿Ï') || scientificField.includes('Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÏ„')) {
                                    field = 'pliroforiki';
                                } else if (scientificField.includes('Î¼Î·Ï‡Î±Î½Î¿Î»Î¿Î³') || scientificField.includes('Î¼Î·Ï‡Î±Î½Î¹Îº')) {
                                    field = 'mixanologia';
                                } else {
                                    field = 'pliroforiki'; // default Î³Î¹Î± Î•Î Î‘Î›
                                }
                            }
                            
                            return {
                                ...school,
                                schoolType: schoolType,
                                field: field,
                                avgScore: Math.round((school.minMoria + school.maxMoria) / 2) || 15000
                            };
                        });
                        
                        // Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® ÏƒÏ„Î¿ backend
                        const success = await saveSchoolsDataToServer(enhancedData);
                        
                        if (success) {
                            if (schoolType === 'gel') {
                                gelData = enhancedData;
                                showSchoolsPreview(enhancedData, 'Î“Î•Î›', 'gel-preview');
                                document.getElementById('current-gel-file').textContent = 
                                    `${file.name} - ${enhancedData.length} ÏƒÏ‡Î¿Î»Î­Ï‚ (Î‘Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½Î¿)`;
                            } else {
                                epalData = enhancedData;
                                showSchoolsPreview(enhancedData, 'Î•Î Î‘Î›', 'epal-preview');
                                document.getElementById('current-epal-file').textContent = 
                                    `${file.name} - ${enhancedData.length} ÏƒÏ‡Î¿Î»Î­Ï‚ (Î‘Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½Î¿)`;
                            }
                            showMessage(`${schoolType.toUpperCase()} Excel ÎµÏ€ÎµÎ¾ÎµÏÎ³Î¬ÏƒÏ„Î·ÎºÎµ ÎºÎ±Î¹ Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚! Î’ÏÎ­Î¸Î·ÎºÎ±Î½ ${enhancedData.length} ÏƒÏ‡Î¿Î»Î­Ï‚.`, 'success');
                        } else {
                            showMessage('Î£Ï†Î¬Î»Î¼Î± Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·Ï‚ ÏƒÏ„Î· Î²Î¬ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½.', 'error');
                        }
                    } else {
                        showMessage('Î¤Î¿ Excel Î±ÏÏ‡ÎµÎ¯Î¿ Î´ÎµÎ½ Ï€ÎµÏÎ¹Î­Ï‡ÎµÎ¹ Î­Î³ÎºÏ…ÏÎ± Î´ÎµÎ´Î¿Î¼Î­Î½Î±.', 'error');
                    }
                    
                } catch (error) {
                    showMessage('Î£Ï†Î¬Î»Î¼Î± ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚ Excel: ' + error.message, 'error');
                    console.error('Excel parsing error:', error);
                }
            };
            reader.onerror = () => showMessage('Î£Ï†Î¬Î»Î¼Î± Î±Î½Î¬Î³Î½Ï‰ÏƒÎ·Ï‚ Î±ÏÏ‡ÎµÎ¯Î¿Ï….', 'error');
            reader.readAsArrayBuffer(file);
        }

        // Parse TSV file with Greek university data format
        function parseSchoolsTSV(tsvText) {
            const lines = tsvText.split('\n').filter(line => line.trim());
            
            if (lines.length < 2) {
                throw new Error('Î¤Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î­Ï‡ÎµÎ¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ Î¼Î¯Î± Î³ÏÎ±Î¼Î¼Î® headers ÎºÎ±Î¹ Î¼Î¯Î± Î³ÏÎ±Î¼Î¼Î® Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½.');
            }
            
            const headers = lines[0].split('\t').map(h => h.trim());
            console.log('TSV headers detected:', headers);
            
            const schools = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split('\t').map(v => v.trim());
                
                // Î’Î¬ÏƒÎµÎ¹ Ï„Î·Ï‚ Î´Î¿Î¼Î®Ï‚: ÎšÎ©Î”Î™ÎšÎŸÎ£ | Î™Î”Î¡Î¥ÎœÎ‘ | ÎŸÎÎŸÎœÎ‘ | Î•Î™Î”ÎŸÎ£ Î˜Î•Î£Î—Î£ | Î•Î Î™Î£Î¤Î—ÎœÎŸÎÎ™ÎšÎ‘ Î Î•Î”Î™Î‘ | ÎœÎ•Î“Î™Î£Î¤Î‘ ÎœÎŸÎ¡Î™Î‘ | Î•Î›Î‘Î§Î™Î£Î¤Î‘ ÎœÎŸÎ¡Î™Î‘
                if (values.length >= 7 && values[2] && values[2].length > 3) {
                    const school = {
                        id: values[0] || '',                 // ÎšÎ©Î”Î™ÎšÎŸÎ£ Î£Î§ÎŸÎ›Î—Î£ (ÏƒÏ„Î®Î»Î· 0)
                        university: values[1] || '',         // Î™Î”Î¡Î¥ÎœÎ‘ (ÏƒÏ„Î®Î»Î· 1)
                        name: values[2] || '',               // ÎŸÎÎŸÎœÎ‘ Î£Î§ÎŸÎ›Î—Î£ (ÏƒÏ„Î®Î»Î· 2)
                        positionType: values[3] || '',       // Î•Î™Î”ÎŸÎ£ Î˜Î•Î£Î—Î£ (ÏƒÏ„Î®Î»Î· 3)
                        scientificField: values[4] || '',    // Î•Î Î™Î£Î¤Î—ÎœÎŸÎÎ™ÎšÎ‘ Î Î•Î”Î™Î‘ (ÏƒÏ„Î®Î»Î· 4)
                        maxMoria: parseInt(values[5]) || 0,  // ÎœÎ•Î“Î™Î£Î¤Î‘ ÎœÎŸÎ¡Î™Î‘ (ÏƒÏ„Î®Î»Î· 5)
                        minMoria: parseInt(values[6]) || 0   // Î•Î›Î‘Î§Î™Î£Î¤Î‘ ÎœÎŸÎ¡Î™Î‘ (ÏƒÏ„Î®Î»Î· 6)
                    };
                    
                    schools.push(school);
                }
            }
            
            console.log(`Successfully parsed ${schools.length} schools from TSV`);
            return schools;
        }

        // Parse Excel data (array format)
        function parseSchoolsExcel(jsonData) {
            const schools = [];
            
            if (jsonData.length < 2) {
                throw new Error('Î¤Î¿ Excel Î±ÏÏ‡ÎµÎ¯Î¿ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î­Ï‡ÎµÎ¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ Î¼Î¯Î± Î³ÏÎ±Î¼Î¼Î® headers ÎºÎ±Î¹ Î¼Î¯Î± Î³ÏÎ±Î¼Î¼Î® Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½.');
            }
            
            for (let i = 1; i < jsonData.length; i++) {
                const values = jsonData[i];
                
                // Î’Î¬ÏƒÎµÎ¹ Ï„Î·Ï‚ Î´Î¿Î¼Î®Ï‚: ÎšÎ©Î”Î™ÎšÎŸÎ£ | Î™Î”Î¡Î¥ÎœÎ‘ | ÎŸÎÎŸÎœÎ‘ | Î•Î™Î”ÎŸÎ£ Î˜Î•Î£Î—Î£ | Î•Î Î™Î£Î¤Î—ÎœÎŸÎÎ™ÎšÎ‘ Î Î•Î”Î™Î‘ | ÎœÎ•Î“Î™Î£Î¤Î‘ ÎœÎŸÎ¡Î™Î‘ | Î•Î›Î‘Î§Î™Î£Î¤Î‘ ÎœÎŸÎ¡Î™Î‘
                if (values && values.length >= 7 && values[2] && values[2].toString().length > 3) {
                    const school = {
                        id: values[0] ? values[0].toString() : '',                 // ÎšÎ©Î”Î™ÎšÎŸÎ£ Î£Î§ÎŸÎ›Î—Î£ (ÏƒÏ„Î®Î»Î· 0)
                        university: values[1] ? values[1].toString() : '',         // Î™Î”Î¡Î¥ÎœÎ‘ (ÏƒÏ„Î®Î»Î· 1)
                        name: values[2] ? values[2].toString() : '',               // ÎŸÎÎŸÎœÎ‘ Î£Î§ÎŸÎ›Î—Î£ (ÏƒÏ„Î®Î»Î· 2)
                        positionType: values[3] ? values[3].toString() : '',       // Î•Î™Î”ÎŸÎ£ Î˜Î•Î£Î—Î£ (ÏƒÏ„Î®Î»Î· 3)
                        scientificField: values[4] ? values[4].toString() : '',    // Î•Î Î™Î£Î¤Î—ÎœÎŸÎÎ™ÎšÎ‘ Î Î•Î”Î™Î‘ (ÏƒÏ„Î®Î»Î· 4)
                        maxMoria: parseInt(values[5]) || 0,                        // ÎœÎ•Î“Î™Î£Î¤Î‘ ÎœÎŸÎ¡Î™Î‘ (ÏƒÏ„Î®Î»Î· 5)
                        minMoria: parseInt(values[6]) || 0                         // Î•Î›Î‘Î§Î™Î£Î¤Î‘ ÎœÎŸÎ¡Î™Î‘ (ÏƒÏ„Î®Î»Î· 6)
                    };
                    
                    schools.push(school);
                }
            }
            
            return schools;
        }

        // Show preview for parsed data
        function showSchoolsPreview(schoolsData, schoolType, containerId) {
            const container = document.getElementById(containerId);
            container.style.display = 'block';
            
            const limitedData = schoolsData.slice(0, 10);
            
            let html = `
                <h3>Î ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· ${schoolType} (${schoolsData.length} ÏƒÏ…Î½Î¿Î»Î¹ÎºÎ¬ ÏƒÏ‡Î¿Î»Î­Ï‚, ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ· Ï€ÏÏÏ„Ï‰Î½ 10)</h3>
                <div style="overflow-x: auto;">
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th>ÎšÏ‰Î´Î¹ÎºÏŒÏ‚</th>
                                <th>ÎŠÎ´ÏÏ…Î¼Î±</th>
                                <th>ÎŒÎ½Î¿Î¼Î± Î£Ï‡Î¿Î»Î®Ï‚</th>
                                <th>Î•Î¯Î´Î¿Ï‚ Î˜Î­ÏƒÎ·Ï‚</th>
                                <th>Î•Ï€Î¹ÏƒÏ„Î·Î¼Î¿Î½Î¹ÎºÎ¬ Î ÎµÎ´Î¯Î±</th>
                                <th>ÎœÎ­Î³Î¹ÏƒÏ„Î± ÎœÏŒÏÎ¹Î±</th>
                                <th>Î•Î»Î¬Ï‡Î¹ÏƒÏ„Î± ÎœÏŒÏÎ¹Î±</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            limitedData.forEach(school => {
                html += `
                    <tr>
                        <td>${school.id || 'N/A'}</td>
                        <td>${school.university || 'N/A'}</td>
                        <td>${school.name || 'N/A'}</td>
                        <td>${school.positionType || 'N/A'}</td>
                        <td>${school.scientificField || 'N/A'}</td>
                        <td>${school.maxMoria || 'N/A'}</td>
                        <td>${school.minMoria || 'N/A'}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 15px;">
                    <button class="upload-btn" onclick="saveData('${schoolType.toLowerCase()}')">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· ${schoolType}</button>
                    <button class="upload-btn" onclick="downloadAsExcel('${schoolType.toLowerCase()}')">ÎšÎ±Ï„Î­Î²Î±ÏƒÎ¼Î± Ï‰Ï‚ Excel</button>
                    <button class="preview-btn" onclick="clearData('${schoolType.toLowerCase()}')">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Save data function
        function saveData(schoolType) {
            const data = schoolType === 'Î³ÎµÎ»' ? gelData : epalData;
            if (!data) {
                showMessage('Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î³Î¹Î± Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·.', 'error');
                return;
            }
            
            showMessage(`Î¤Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± ${schoolType.toUpperCase()} Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎ±Î½ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚! ${data.length} ÏƒÏ‡Î¿Î»Î­Ï‚.`, 'success');
            console.log(`Saved ${schoolType} data:`, data);
        }

        // Download as Excel
        function downloadAsExcel(schoolType) {
            const data = schoolType === 'Î³ÎµÎ»' ? gelData : epalData;
            if (!data) {
                showMessage('Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î³Î¹Î± ÎºÎ±Ï„Î­Î²Î±ÏƒÎ¼Î±.', 'error');
                return;
            }
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, schoolType.toUpperCase());
            XLSX.writeFile(wb, `${schoolType}_schools.xlsx`);
            showMessage(`Î¤Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ ${schoolType.toUpperCase()} ÎºÎ±Ï„Î­Î²Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!`, 'success');
        }

        // Clear data
        function clearData(schoolType) {
            if (schoolType === 'Î³ÎµÎ»') {
                gelData = null;
                document.getElementById('gel-preview').style.display = 'none';
                document.getElementById('gel-file').value = '';
                document.getElementById('current-gel-file').textContent = 'Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ Î±Î½Î­Î²ÎµÎ¹ Î±ÏÏ‡ÎµÎ¯Î¿ Î“Î•Î›';
            } else {
                epalData = null;
                document.getElementById('epal-preview').style.display = 'none';
                document.getElementById('epal-file').value = '';
                document.getElementById('current-epal-file').textContent = 'Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ Î±Î½Î­Î²ÎµÎ¹ Î±ÏÏ‡ÎµÎ¯Î¿ Î•Î Î‘Î›';
            }
            showMessage(`Î¤Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± ${schoolType.toUpperCase()} Î´Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎ±Î½.`, 'error');
        }

        // Download sample files
        function downloadSampleGEL() {
            const sampleData = `ÎšÎ©Î”Î™ÎšÎŸÎ£ Î£Î§ÎŸÎ›Î—Î£\tÎ™Î”Î¡Î¥ÎœÎ‘\tÎŸÎÎŸÎœÎ‘ Î£Î§ÎŸÎ›Î—Î£\tÎ•Î™Î”ÎŸÎ£ Î˜Î•Î£Î—Î£\tÎ•Î Î™Î£Î¤Î—ÎœÎŸÎÎ™ÎšÎ‘ Î Î•Î”Î™Î‘\tÎœÎ•Î“Î™Î£Î¤Î‘ ÎœÎŸÎ¡Î™Î‘\tÎ•Î›Î‘Î§Î™Î£Î¤Î‘ ÎœÎŸÎ¡Î™Î‘
0413\tÎ‘.Î•.Î‘. Î‘Î˜Î—ÎÎ‘Î£\tÎ Î¡ÎŸÎ“Î¡Î‘ÎœÎœÎ‘ Î™Î•Î¡Î‘Î¤Î™ÎšÎ©Î Î£Î ÎŸÎ¥Î”Î©Î Î‘Î˜Î—ÎÎ‘Î£\tÎ“Î•Î› Î“Î•ÎÎ™ÎšÎ— Î£Î•Î™Î¡Î‘ Î—Îœ.\t1\t10010\t10010
0818\tÎ‘.Î•.Î.\tÎ£Î§ÎŸÎ›Î— ÎœÎ—Î§Î‘ÎÎ™ÎšÎ©Î\tÎ“Î•Î› Î“Î•ÎÎ™ÎšÎ— Î£Î•Î™Î¡Î‘ Î—Îœ.\t2\t16800\t8350
0129\tÎ‘.Î .Î˜.\tÎ‘Î“Î“Î›Î™ÎšÎ—Î£ Î“Î›Î©Î£Î£Î‘Î£ ÎšÎ‘Î™ Î¦Î™Î›ÎŸÎ›ÎŸÎ“Î™Î‘Î£ (Î˜Î•Î£Î£Î‘Î›ÎŸÎÎ™ÎšÎ—)\tÎ“Î•Î› Î“Î•ÎÎ™ÎšÎ— Î£Î•Î™Î¡Î‘ Î—Îœ.\t1\t22760\t18550`;
            
            downloadFile(sampleData, 'sample_gel_schools.tsv', 'text/tab-separated-values');
            showMessage('Î¤Î¿ Î´ÎµÎ¯Î³Î¼Î± Î“Î•Î› ÎºÎ±Ï„Î­Î²Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!', 'success');
        }

        function downloadSampleEPAL() {
            const sampleData = `ÎšÎ©Î”Î™ÎšÎŸÎ£ Î£Î§ÎŸÎ›Î—Î£\tÎ™Î”Î¡Î¥ÎœÎ‘\tÎŸÎÎŸÎœÎ‘ Î£Î§ÎŸÎ›Î—Î£\tÎ•Î™Î”ÎŸÎ£ Î˜Î•Î£Î—Î£\tÎ•Î Î™Î£Î¤Î—ÎœÎŸÎÎ™ÎšÎ‘ Î Î•Î”Î™Î‘\tÎœÎ•Î“Î™Î£Î¤Î‘ ÎœÎŸÎ¡Î™Î‘\tÎ•Î›Î‘Î§Î™Î£Î¤Î‘ ÎœÎŸÎ¡Î™Î‘
0501\tÎ•Î Î‘Î›\tÎ¤Î•Î§ÎÎŸÎ›ÎŸÎ“Î™Î‘ Î¤Î¡ÎŸÎ¦Î™ÎœÎ©Î\tÎ•Î Î‘Î› Î Î›Î—Î¡ÎŸÎ¦ÎŸÎ¡Î™ÎšÎ—Î£\t4\t12500\t8200
0502\tÎ•Î Î‘Î›\tÎœÎ—Î§Î‘ÎÎŸÎ›ÎŸÎ“Î™Î‘ Î‘Î¥Î¤ÎŸÎšÎ™ÎÎ—Î¤Î©Î\tÎ•Î Î‘Î› Î Î›Î—Î¡ÎŸÎ¦ÎŸÎ¡Î™ÎšÎ—Î£\t4\t14800\t9500
0503\tÎ•Î Î‘Î›\tÎ—Î›Î•ÎšÎ¤Î¡ÎŸÎÎ™ÎšÎ‘ Î£Î¥Î£Î¤Î—ÎœÎ‘Î¤Î‘\tÎ•Î Î‘Î› Î Î›Î—Î¡ÎŸÎ¦ÎŸÎ¡Î™ÎšÎ—Î£\t4\t13200\t8800`;
            
            downloadFile(sampleData, 'sample_epal_schools.tsv', 'text/tab-separated-values');
            showMessage('Î¤Î¿ Î´ÎµÎ¯Î³Î¼Î± Î•Î Î‘Î› ÎºÎ±Ï„Î­Î²Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!', 'success');
        }

        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Show message
        function showMessage(message, type) {
            const container = document.getElementById('status-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            
            container.innerHTML = '';
            container.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 5000);
        }

        // ========== EXCEL TEMPLATES FUNCTIONALITY ==========
        
        // Load and display templates when page loads
        window.addEventListener('load', function() {
            loadTemplates();
            loadTemplateStats();
        });
        
        // Upload new template
        async function uploadTemplate() {
            const fileInput = document.getElementById('template-file');
            const templateType = document.getElementById('template-type').value;
            
            if (!fileInput.files[0]) {
                showMessage('Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Î­Î½Î± Î±ÏÏ‡ÎµÎ¯Î¿.', 'error');
                return;
            }
            
            if (!templateType) {
                showMessage('Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Ï„ÏÏ€Î¿ template.', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('template', fileInput.files[0]);
            formData.append('templateType', templateType);
            
            try {
                const response = await fetch('/api/upload-calculator-template', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    fileInput.value = '';
                    document.getElementById('template-type').value = '';
                    loadTemplates();
                    loadTemplateStats();
                } else {
                    showMessage(result.error || 'Î£Ï†Î¬Î»Î¼Î± Î±Î½ÎµÎ²Î¬ÏƒÎ¼Î±Ï„Î¿Ï‚', 'error');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showMessage('Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ Î¼Îµ Ï„Î¿Î½ server.', 'error');
            }
        }
        
        // Load and display all templates
        async function loadTemplates() {
            try {
                const response = await fetch('/api/calculator-templates');
                const templates = await response.json();
                
                const container = document.getElementById('templates-container');
                
                if (templates.length === 0) {
                    container.innerHTML = '<p>Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ templates.</p>';
                    return;
                }
                
                let html = '';
                templates.forEach(template => {
                    const uploadDate = new Date(template.uploadDate).toLocaleDateString('el-GR');
                    const fileSize = formatFileSize(template.size);
                    
                    html += `
                        <div class="template-item">
                            <div class="template-info">
                                <strong>${template.originalName}</strong><br>
                                <small>Î¤ÏÏ€Î¿Ï‚: ${template.templateType} | ÎœÎ­Î³ÎµÎ¸Î¿Ï‚: ${fileSize} | Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±: ${uploadDate}</small>
                            </div>
                            <div class="template-actions">
                                <button onclick="downloadTemplate('${template.fileName}')" class="btn btn-success">ğŸ“¥ ÎšÎ±Ï„Î­Î²Î±ÏƒÎ¼Î±</button>
                                <button onclick="deleteTemplate('${template.fileName}')" class="btn btn-danger">ğŸ—‘ï¸ Î”Î¹Î±Î³ÏÎ±Ï†Î®</button>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading templates:', error);
                document.getElementById('templates-container').innerHTML = '<p>Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ templates.</p>';
            }
        }
        
        // Load template statistics
        async function loadTemplateStats() {
            try {
                const response = await fetch('/api/calculator-templates-stats');
                const stats = await response.json();
                
                const container = document.getElementById('stats-container');
                
                let html = `
                    <p><strong>Î£ÏÎ½Î¿Î»Î¿ Templates:</strong> ${stats.totalTemplates}</p>
                    <p><strong>Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ ÎœÎ­Î³ÎµÎ¸Î¿Ï‚:</strong> ${formatFileSize(stats.totalSize)}</p>
                `;
                
                if (stats.lastUpdated) {
                    const lastUpdate = new Date(stats.lastUpdated).toLocaleDateString('el-GR');
                    html += `<p><strong>Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ·:</strong> ${lastUpdate}</p>`;
                }
                
                if (Object.keys(stats.templateTypes).length > 0) {
                    html += '<p><strong>Î‘Î½Î¬ Î¤ÏÏ€Î¿:</strong></p><ul>';
                    for (const [type, count] of Object.entries(stats.templateTypes)) {
                        html += `<li>${type}: ${count}</li>`;
                    }
                    html += '</ul>';
                }
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading template stats:', error);
                document.getElementById('stats-container').innerHTML = '<p>Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ ÏƒÏ„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÏÎ½.</p>';
            }
        }
        
        // Download template
        async function downloadTemplate(fileName) {
            try {
                const response = await fetch(`/api/calculator-templates/${fileName}`);
                
                if (!response.ok) {
                    throw new Error('Template Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                a.click();
                window.URL.revokeObjectURL(url);
                
                showMessage('Î¤Î¿ template ÎºÎ±Ï„Î­Î²Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!', 'success');
            } catch (error) {
                console.error('Download error:', error);
                showMessage('Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„ÎµÎ²Î¬ÏƒÎ¼Î±Ï„Î¿Ï‚ template.', 'error');
            }
        }
        
        // Delete template
        async function deleteTemplate(fileName) {
            if (!confirm('Î•Î¯ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Î¹ ÏŒÏ„Î¹ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÏ„Îµ Î±Ï…Ï„ÏŒ Ï„Î¿ template;')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/calculator-templates/${fileName}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                    loadTemplates();
                    loadTemplateStats();
                } else {
                    showMessage(result.error || 'Î£Ï†Î¬Î»Î¼Î± Î´Î¹Î±Î³ÏÎ±Ï†Î®Ï‚', 'error');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showMessage('Î£Ï†Î¬Î»Î¼Î± ÏƒÏÎ½Î´ÎµÏƒÎ·Ï‚ Î¼Îµ Ï„Î¿Î½ server.', 'error');
            }
        }
        
        // Format file size
        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ ÏƒÏ‡Î¿Î»ÏÎ½ ÏƒÏ„Î¿ backend
        async function saveSchoolsDataToServer(schoolsData) {
            try {
                const response = await fetch('/api/upload-schools-csv', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(schoolsData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('Schools data saved to server:', result);
                    return true;
                } else {
                    console.error('Failed to save schools data:', result.error);
                    return false;
                }
            } catch (error) {
                console.error('Error saving schools data to server:', error);
                return false;
            }
        }
        
        // Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½Ï‰Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ Î±Ï€ÏŒ Ï„Î¿ backend ÎºÎ±Ï„Î¬ Ï„Î·Î½ ÎµÎºÎºÎ¯Î½Î·ÏƒÎ·
        async function loadSavedSchoolsData() {
            try {
                const response = await fetch('/api/schools-data');
                const schoolsData = await response.json();
                
                if (schoolsData && schoolsData.length > 0) {
                    // Î”Î¹Î±Ï‡Ï‰ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ GEL ÎºÎ±Î¹ EPAL
                    const gelSchools = schoolsData.filter(school => school.schoolType === 'gel');
                    const epalSchools = schoolsData.filter(school => school.schoolType === 'epal');
                    
                    if (gelSchools.length > 0) {
                        gelData = gelSchools;
                        showSchoolsPreview(gelSchools, 'Î“Î•Î›', 'gel-preview');
                        document.getElementById('current-gel-file').textContent = 
                            `Î‘Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ - ${gelSchools.length} ÏƒÏ‡Î¿Î»Î­Ï‚ Î“Î•Î›`;
                    }
                    
                    if (epalSchools.length > 0) {
                        epalData = epalSchools;
                        showSchoolsPreview(epalSchools, 'Î•Î Î‘Î›', 'epal-preview');
                        document.getElementById('current-epal-file').textContent = 
                            `Î‘Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ - ${epalSchools.length} ÏƒÏ‡Î¿Î»Î­Ï‚ Î•Î Î‘Î›`;
                    }
                    
                    console.log(`Loaded ${schoolsData.length} schools from server (${gelSchools.length} GEL, ${epalSchools.length} EPAL)`);
                }
            } catch (error) {
                console.error('Error loading saved schools data:', error);
            }
        }
        
        // ÎšÎ»Î®ÏƒÎ· Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½Ï‰Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ ÎºÎ±Ï„Î¬ Ï„Î·Î½ ÎµÎºÎºÎ¯Î½Î·ÏƒÎ·
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedSchoolsData();
            // loadTemplates(); // Î‘Î½ Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹
        });
    </script>
</body>
</html>
